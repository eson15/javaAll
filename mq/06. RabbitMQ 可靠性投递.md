> æ–‡ç« å¯ä»¥ç™½å«–ï¼Œè€é“ä»¬é¡ºä¾¿å…³æ³¨ä¸€ä¸‹æˆ‘çš„å…¬ä¼—å·ï¼Œæ‰‹åŠ¨æ»‘ç¨½ğŸ¤£ğŸ¤£ &nbsp;
>
> æ¬¢è¿å¤§å®¶å…³æ³¨ï¼š**æ­¦å“¥èŠç¼–ç¨‹**ã€**Javaå¼€å‘å®å…¸**ã€**Javaç§ƒå¤´å“¥**ï¼Œæ‚¨çš„æ”¯æŒï¼Œæ˜¯æˆ‘åˆ›ä½œçš„æŒç»­åŠ¨åŠ›ï¼&nbsp;&nbsp;

![æ­¦å“¥èŠç¼–ç¨‹](https://img-blog.csdnimg.cn/202002150421550.jpg)![Javaå¼€å‘å®å…¸](https://img-blog.csdnimg.cn/20200608005630228.png)![Javaç§ƒå¤´å“¥](https://img-blog.csdnimg.cn/20201025170941235.png)

----



æœ¬èŠ‚ä¸»è¦è®¨è®ºä¸€äº›å¤æ‚æƒ…å†µä¸‹çš„MQé—®é¢˜ã€‚é€šè¿‡ä¸€äº›å¼‚å¸¸æƒ…å†µå’Œæ–¹æ¡ˆæ¥ç¡®ä¿æ¶ˆæ¯æ­£ç¡®æŠ•é€’ã€‚

## MQå’ŒDBæ“ä½œçš„ä¸€è‡´æ€§é—®é¢˜

ç¡®ä¿MQæ¶ˆæ¯å’Œæ•°æ®åº“ä¸€è‡´æ˜¯æ¶ˆæ¯å¯é æ€§çš„è¦æ±‚ä¹‹ä¸€ã€‚ä¸‹é¢åˆ—å‡ºä¸€äº›å¸¸è§çš„å¼‚å¸¸åœºæ™¯è¿›è¡Œåˆ†æã€‚

- å…ˆæŠ•é€’æ¶ˆæ¯å†æ›´æ–°æ•°æ®åº“
- å…ˆæ›´æ–°æ•°æ®åº“å†æŠ•é€’æ¶ˆæ¯

**å…ˆæŠ•é€’æ¶ˆæ¯å†æ›´æ–°æ•°æ®åº“**ï¼šå½“æ¶ˆæ¯æŠ•é€’æˆåŠŸè€Œæ•°æ®åº“è¿æ¥å¤±è´¥æ—¶ï¼Œæ“ä½œmqå›æ»šå¯èƒ½æ¯”è¾ƒéº»çƒ¦ã€‚å› æ­¤å»ºè®®**å…ˆæ“ä½œæ•°æ®åº“å†å‘é€mq**ï¼Œåˆ©ç”¨æ•°æ®åº“çš„äº‹åŠ¡æ¥å›æ»šæ•°æ®ã€‚è¿™æ ·ï¼Œå…ˆæ“ä½œæ•°æ®åº“æš‚ä¸æäº¤ï¼Œç­‰å¾…mqå‘é€æˆåŠŸå†æäº¤ï¼Œå¯ç¡®ä¿æ•°æ®åº“å’Œmqä¸€è‡´ã€‚ä¸€æ—¦mqæ“ä½œå‡ºç°å¤±è´¥æƒ…å†µï¼Œè€Œæ­¤æ—¶æ•°æ®åº“å°šæœªæäº¤ï¼Œç›´æ¥æ ¹æ®mqå¤±è´¥çš„å¼‚å¸¸ï¼Œé€šè¿‡æ•°æ®åº“äº‹åŠ¡æ§åˆ¶å›æ»šå³å¯ã€‚

**æ‹“å±•ï¼š**è¯¥æ€è·¯ä¾ç„¶é€‚ç”¨äºä¸€äº›å…¶å®ƒç±»ä¼¼åœºæ™¯ï¼Œå¦‚ï¼šredisç¼“å­˜å’Œæ•°æ®åº“æ“ä½œçš„é—®é¢˜ï¼Œå…ˆæ“ä½œæ•°æ®åº“ï¼Œå†æ“ä½œç¼“å­˜ï¼Œåœ¨ç¼“å­˜å¤±è´¥æ—¶å¯¹æ•°æ®åº“è¿›è¡Œå›æ»šã€‚

å…¶å®å¯ä»¥æŠŠmq redis ç­‰(éœ€è¦å’Œæ•°æ®åº“ä¿æŒä¸€è‡´çš„)ä¸­é—´ä»¶éƒ½çœ‹åšç¼“å­˜ï¼Œç”šè‡³æ–‡ä»¶çš„è¯»å†™ç­‰IOæ“ä½œéƒ½å¯ä»¥è§†ä½œç¼“å­˜ã€‚å°†æ•°æ®åº“æ”¾åœ¨å‰é¢æ“ä½œæ˜¯åˆ©ç”¨äº†æ•°æ®åº“äº‹åŠ¡å›æ»šæ–¹ä¾¿çš„ç‰¹æ€§ï¼Œå¯ä»¥åœ¨åç»­æ“ä½œå‡ºç°å¼‚å¸¸æ—¶å›æ»šï¼Œä»è€Œä¿è¯ä¸€è‡´æ€§ã€‚(å¯ä»¥ç»§ç»­å¼•ç”³å‡ºåˆ†å¸ƒå¼äº‹åŠ¡çš„é—®é¢˜ï¼Œè¿™é‡Œæš‚ä¸è®¨è®º)ã€‚



## MQçš„ç¡®è®¤æœºåˆ¶

åœ¨mqæ¶ˆæ¯å‘é€è¿‡ç¨‹ä¸­ï¼Œå¯èƒ½å­˜åœ¨ç½‘ç»œæˆ–å…¶å®ƒå¼‚å¸¸æƒ…å†µå¯¼è‡´æ¶ˆæ¯å‘é€å¤±è´¥ã€‚RabbitMQæä¾›äº†ç¡®è®¤æœºåˆ¶ã€‚å³ï¼šç”Ÿäº§è€…å‘é€äº†æ¶ˆæ¯ç»™MQæœåŠ¡ç«¯ä¹‹åï¼ŒæœåŠ¡ç«¯ä¼šç»™ç”Ÿäº§è€…ä¸€ä¸ªåº”ç­”ï¼Œåªè¦ç”Ÿäº§è€…æ”¶åˆ°äº†åº”ç­”ï¼Œä¾¿è¯æ˜æœåŠ¡ç«¯æ”¶åˆ°äº†æ¶ˆæ¯ã€‚

ç¡®è®¤æœºåˆ¶æœ‰ä¸¤ç§ï¼š

- äº‹åŠ¡æ¨¡å¼
- ç¡®è®¤æ¨¡å¼

**äº‹åŠ¡æ¨¡å¼**

å’Œæ•°æ®åº“ç±»ä¼¼ï¼Œåœ¨å‘é€æ¶ˆæ¯å‰å¼€å¯äº‹åŠ¡ï¼Œç»“æŸåæäº¤äº‹åŠ¡ã€‚

åªè¦æäº¤æˆåŠŸä¾¿å¯ä»¥ç¡®ä¿æ¶ˆæ¯æŠ•é€’åˆ°äº†MQæœåŠ¡ç«¯ã€‚

äº‹åŠ¡æ¨¡å¼å¯ä»¥é€šè¿‡`channel.txSelect()`æ¥å¼€å¯,`channel.txCommit()`æ¥æäº¤ã€‚å¦‚æœä¸­é€”å‡ºç°äº†é”™è¯¯ï¼Œé€šè¿‡`channel.txRollback()`æ¥å›æ»šã€‚springbootä¸­å¯ä»¥é€šè¿‡`rabbitTemplate.setChannelTransacted(true)`æ¥å¼€å¯äº‹åŠ¡ã€‚

ç¼ºç‚¹ï¼šchannelæ˜¯é˜»å¡çš„ï¼Œæœªæäº¤æ—¶æ— æ³•å‘é€ä¸‹ä¸€æ¡æ¶ˆæ¯ï¼Œä¼šå½±å“æŠ•é€’æ€§èƒ½ã€‚ï¼ˆè¿™ä¸€ç‚¹å’Œæ•°æ®åº“ä¹Ÿç±»ä¼¼ï¼Œæ²¡æœ‰æäº¤ä¹‹å‰ï¼Œå’Œäº‹åŠ¡ç›¸å…³çš„é”å®šæ“ä½œéƒ½ä¸å…è®¸æ‰§è¡Œï¼‰ï¼Œä¸€èˆ¬ä¸å»ºè®®ä½¿ç”¨è¯¥æ¨¡å¼ã€‚

**ç¡®è®¤æ¨¡å¼ï¼š**

ç¡®è®¤æ¨¡å¼åˆåˆ†äº†ä¸‰ç§ï¼š

- æ™®é€šç¡®è®¤æ¨¡å¼ï¼šå‘ä¸€æ¡ç¡®è®¤ä¸€æ¡ï¼›ç¼ºç‚¹ï¼šå•æ¡æ•ˆç‡ä½ã€‚
- æ‰¹é‡ç¡®è®¤ï¼šå‘äº†å¤šæ¡ä¸€èµ·ç¡®è®¤ï¼›ç¼ºç‚¹ï¼šä¸åŒåœºæ™¯éœ€æ±‚ä¸åŒï¼Œæ— æ³•å‡†ç¡®ä¼°é‡ä¸€æ¬¡ç¡®è®¤çš„æ•°é‡ã€‚
- å¼‚æ­¥ç¡®è®¤ï¼šå‘é€æ¶ˆæ¯åï¼Œä¸€ä¸ªç‹¬ç«‹çš„ç¡®è®¤çº¿ç¨‹(Listener)ä¸“é—¨ç”¨æ¥å¤„ç†æœªç¡®è®¤çš„æ¶ˆæ¯ã€‚[æ¨è]

å¼‚æ­¥åŸä¸º`ConfirmListener` , RabbitTemplateå¯¹channelåšäº†å°è£…ï¼Œå…·ä½“ç”¨æ³•å¦‚ä¸‹ï¼š

```java
rabbitTemplate.setConfirmCallback(
  new RabbitTemplate.ConfirmCallback() {
    @Override
    public void confirm(CorrelationData correlationData, 
                        boolean ack, String cause) {
      if (!ack) {
        System.out.println("å‘é€æ¶ˆæ¯å¤±è´¥ï¼š" + cause);
        throw new RuntimeException("å‘é€å¼‚å¸¸ï¼š" + cause);
      }
    }
  }
);
```



## æŠ•é€’å¤±è´¥çš„æ¶ˆæ¯å¤„ç†

æ¶ˆæ¯å¯èƒ½ç”±äºè·¯ç”±é”®è®¾ç½®é”™è¯¯ï¼Œæˆ–é˜Ÿåˆ—é…ç½®é”™è¯¯ç­‰ï¼Œæ— æ³•æŠ•é€’æˆåŠŸã€‚

å¸¸è§å¤„ç†æ–¹å¼æœ‰ï¼šé‡æ–°æŠ•é€’ï¼›å°†æ¶ˆæ¯è·¯ç”±åˆ°å¤‡ä»½äº¤æ¢æœºã€‚è¿™é‡Œä¸»è¦è¯´ä¸‹å¤‡ä»½äº¤æ¢æœºçš„è®¾ç½®ã€‚

`channel.basicPublish`æœ‰ä¸¤ä¸ªå‚æ•°`mandatory`å’Œ`immediate`

```java
//å‘é€æ¶ˆæ¯
channel.basicPublish(EXCHANGE NAME, "", true,
                     MessageProperties.PERSISTENT TEXT PLAIN,
                     "mandatory Msg".getBytes());

//æŠ•é€’å¤±è´¥åè¿”å›
channel.addReturnListener(new ReturnListener()(
    public void handleReturn ( int replyCode, String replyText,String exchange, 
                              String routingKey, AMQP.BasicProperties basicProperties ,
                              byte[] body) throws IOException{
      String message = new String(body);
      System.out.println("è¿”å›: " + message);
    }
});
```

Spring AMQPä¸­é…ç½®æ–¹å¼å¦‚ä¸‹

```java
rabbitTemplate.setMandatory(true);
        rabbitTemplate.setReturnCallback((RabbitTemplate.ReturnCallback) (message, replyCode, replyText, exchange, routingKey) -> {
            System.out.println("å›å‘çš„æ¶ˆæ¯ï¼š");
            System.out.println("replyCode: " + replyCode);
            System.out.println("replyText: " + replyText);
            System.out.println("exchange: " + exchange);
            System.out.println("routingKey: " + routingKey);
        });
```

åˆ›å»ºäº¤æ¢æœºæ—¶æ·»åŠ å¤‡ä»½äº¤æ¢æœºã€‚

```java
Map<String,Object> arguments = new HashMap<String,Object>();
arguments.put("alternate-exchange","ALTERNATE_EXCHANGE"); // æŒ‡å®šäº¤æ¢æœºçš„å¤‡ä»½äº¤æ¢æœº
channel.exchangeDeclare("TEST_EXCHANGE","topic", false, false, false, arguments);
```



## æœªè¢«æ¶ˆè´¹çš„æ¶ˆæ¯å¤„ç†

å¦‚æœæ¶ˆæ¯åœ¨é˜Ÿåˆ—ä¸­é•¿æœŸæœªè¢«æ¶ˆè´¹ï¼Œè€Œæ­¤æ—¶å‡ºç°äº†å®•æœºç­‰å¼‚å¸¸å…³é—­çš„æƒ…å†µï¼Œæ•°æ®ä¾¿ä¼šä¸¢å¤±ã€‚æœ‰ç»éªŒçš„åŒå­¦è‚¯å®šèƒ½æƒ³åˆ°åº”è¯¥å°†æ•°æ®æŒä¹…åŒ–åˆ°ç£ç›˜ã€‚RabbitMQè‡ªç„¶æä¾›äº†è¯¥åŠŸèƒ½ã€‚é…ç½®æ–¹æ³•å¦‚ä¸‹ï¼š

```java
// è®¾ç½®æ¶ˆæ¯å‚æ•°ä¸ºæŒä¹…åŒ–
MessageProperties messageProperties = new MessageProperties();
messageProperties.setDeliveryMode(MessageDeliveryMode.PERSISTENT);
Message message = new Message("æ¶ˆæ¯æŒä¹…åŒ–".getBytes(), messageProperties);

//è®¾ç½®é˜Ÿåˆ—æŒä¹…åŒ–
@Bean("persistentQueue")
public Queue persistentQueue() {
    // queueName, durable, exclusive, autoDelete, Properties
    // ç›´æ¥è®¾ç½®durableå‚æ•°ä¸ºtrueå³å¯
    return new Queue("PERSISTENT_QUEUE", true, false, false, new HashMap<>());
}

//è®¾ç½®äº¤æ¢æœºæŒä¹…åŒ–
@Bean("persistentExchange")
public DirectExchange persistentExchange() {
    // exchangeName, durable, exclusive, autoDelete, Properties
    return new DirectExchange("PERSISTENT_EXCHANGE", true, false, new HashMap<>());
}
```



## æ¶ˆè´¹è¿‡ç¨‹ä¸­å‡ºç°å¼‚å¸¸

æ¶ˆæ¯å·²ç»æ­£å¸¸æŠ•é€’ï¼Œä¸”è¢«æ­£å¸¸æ¥æ”¶ç”¨äºæ¶ˆè´¹ã€‚è€Œåœ¨æ¶ˆè´¹è¿‡ç¨‹ä¸­å‡ºç°äº†å¼‚å¸¸ï¼Œè¯¥æ¶ˆæ¯æœªè¢«æ­£ç¡®å¤„ç†æ—¶ã€‚

è¿™ç§æƒ…å†µä¸‹ï¼Œé€šå¸¸æ˜¯æŒ‰éœ€é‡æ–°å‘é€ç»™æ¶ˆè´¹è€…è¿›è¡Œæ¶ˆè´¹ã€‚rabbitMQæä¾›äº†â€œæ¶ˆè´¹è€…ç¡®è®¤â€æœºåˆ¶ï¼ŒåŒå‰æ–‡æåˆ°çš„æœåŠ¡ç«¯ç¡®è®¤ç±»ä¼¼ï¼Œæ­¤å¤„ç”±æ¶ˆè´¹è€…å‘é€ç¡®è®¤æ¶ˆæ¯ç»™æœåŠ¡ç«¯ã€‚è®¾ç½®æ–¹æ³•å¦‚ä¸‹ï¼š

```properties
# springbootè®¾ç½®,å‚æ•°å€¼å¯é€‰ï¼š
# NONEï¼šè‡ªåŠ¨ACK
# MANUALï¼šæ‰‹åŠ¨ACK
# AUTOï¼šæ— å¼‚å¸¸ï¼Œåˆ™å‘é€ackã€‚
spring.rabbitmq.listener.direct.acknowledge-mode=manual
spring.rabbitmq.listener.simple.acknowledge-mode=manual
```



## æ¶ˆæ¯è¡¥å¿

å‡è®¾ä¸Šè¿°acké…ç½®åï¼Œç”±äºä¸šåŠ¡å¤„ç†è¾ƒé•¿æˆ–ç½‘ç»œæƒ…å†µï¼ŒæœåŠ¡ç«¯è¿Ÿè¿Ÿæ²¡æœ‰æ”¶åˆ°ackæ€ä¹ˆåŠï¼Ÿ

å¸¸è§çš„æ˜¯æŒ‰ä¸šåŠ¡éœ€è¦è®¾å®š/çº¦å®šä¸€ä¸ªè¶³å¤Ÿé•¿çš„æ—¶é—´ï¼Œå½“è¶…è¿‡è¯¥æ—¶é—´è¿›è¡Œä¸€æ¬¡é‡æ–°æŠ•é€’ã€‚



## å¹‚ç­‰æ€§

å‡è®¾ä¸Šè¿°çš„é‡æ–°æŠ•é€’åªæ˜¯æ…¢ï¼ŒAæ¶ˆæ¯åœ¨Bé‡æ–°æŠ•é€’åï¼Œä¾ç„¶æ­£ç¡®å‘é€äº†ackï¼Œåˆ™å¯¼è‡´å¤„ç†äº†ä¸¤æ¬¡åŒæ ·çš„æ¶ˆæ¯ã€‚å› æ­¤å¯ä»¥å¯¹A B...é‡å¤å‘é€çš„æ¶ˆæ¯åšæ ¡éªŒ/é”å®š/ç”Ÿæˆå”¯ä¸€IDç­‰æ“ä½œï¼Œé¿å…é‡å¤å¤„ç†ç›¸åŒæ¶ˆæ¯ã€‚



## é›†ç¾¤

å‰é¢è®²åˆ°äº†æ¶ˆæ¯æœªè¢«æ¶ˆè´¹çš„æƒ…å†µï¼Œå‡è®¾æ¶ˆæ¯åœ¨æŒä¹…åŒ–è¿‡ç¨‹ä¸­å‡ºç°äº†æ•…éšœæ€ä¹ˆåŠï¼Ÿå¸¸è§åšæ³•æ˜¯å¯¹RabbitMQåšé›†ç¾¤å¤„ç†ã€‚



## æ€»ç»“

å¼‚å¸¸æƒ…å†µè¿˜æœ‰å¾ˆå¤šï¼Œè¿™é‡Œåªåˆ—å‡ºäº†ä¸€äº›å¸¸è§çš„å¼‚å¸¸æƒ…å†µï¼Œå¹¶æä¾›äº†ä¸€äº›ç›¸å¯¹ç®€å•æˆç†Ÿçš„å¤„ç†æ€è·¯ã€‚åœ¨å…·ä½“ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œæ ¹æ®ä¸šåŠ¡çš„å¤æ‚ç¨‹åº¦ï¼Œæ•°æ®ä¸€è‡´æ€§ã€å¯é æ€§è¦æ±‚çš„ä¸åŒï¼Œè¿˜æœ‰å…¶å®ƒæ›´å¤šçš„å¤æ‚æƒ…å†µï¼Œå°±å¾—æ ¹æ®å®é™…éœ€è¦åšç‰¹å®šå¤„ç†äº†ï¼Œå…·ä½“é—®é¢˜è¿˜å¾—å…·ä½“åˆ†æã€‚

----

> æ–‡ç« å¯ä»¥ç™½å«–ï¼Œè€é“ä»¬é¡ºä¾¿å…³æ³¨ä¸€ä¸‹æˆ‘çš„å…¬ä¼—å·ï¼Œæ‰‹åŠ¨æ»‘ç¨½ğŸ¤£ğŸ¤£ &nbsp;
>
> æ¬¢è¿å¤§å®¶å…³æ³¨ï¼š**æ­¦å“¥èŠç¼–ç¨‹**ã€**Javaå¼€å‘å®å…¸**ã€**Javaç§ƒå¤´å“¥**ï¼Œæ‚¨çš„æ”¯æŒï¼Œæ˜¯æˆ‘åˆ›ä½œçš„æŒç»­åŠ¨åŠ›ï¼&nbsp;&nbsp;

![æ­¦å“¥èŠç¼–ç¨‹](https://img-blog.csdnimg.cn/202002150421550.jpg)![Javaå¼€å‘å®å…¸](https://img-blog.csdnimg.cn/20200608005630228.png)![Javaç§ƒå¤´å“¥](https://img-blog.csdnimg.cn/20201025170941235.png)