> æ–‡ç« å¯ä»¥ç™½å«–ï¼Œè€é“ä»¬é¡ºä¾¿å…³æ³¨ä¸€ä¸‹æˆ‘çš„å…¬ä¼—å·ï¼Œæ‰‹åŠ¨æ»‘ç¨½ğŸ¤£ğŸ¤£ &nbsp;
>
> æ¬¢è¿å¤§å®¶å…³æ³¨ï¼š**æ­¦å“¥èŠç¼–ç¨‹**ã€**Javaå¼€å‘å®å…¸**ã€**Javaç§ƒå¤´å“¥**ï¼Œæ‚¨çš„æ”¯æŒï¼Œæ˜¯æˆ‘åˆ›ä½œçš„æŒç»­åŠ¨åŠ›ï¼&nbsp;&nbsp;

![æ­¦å“¥èŠç¼–ç¨‹](https://img-blog.csdnimg.cn/202002150421550.jpg)![Javaå¼€å‘å®å…¸](https://img-blog.csdnimg.cn/20200608005630228.png)![Javaç§ƒå¤´å“¥](https://img-blog.csdnimg.cn/20201025170941235.png)

----



å‰é¢å·²ç»è®²äº†å¦‚ä½•åœ¨ä¸åŒç¯å¢ƒä¸‹é›†æˆrabbitMQã€‚è¿™èŠ‚åŸºäºspringbootè®²ä¸€ä¸‹rabbitMQä¸­å¸¸è§çš„é«˜çº§ç”¨æ³•ï¼Œä¸»è¦å†…å®¹å¦‚ä¸‹ï¼š

- äº¤æ¢æœºç±»å‹
- æ¶ˆæ¯å­˜æ´»æ—¶é—´
- æ­»ä¿¡äº¤æ¢æœº/æ­»ä¿¡é˜Ÿåˆ—
- å»¶æ—¶é˜Ÿåˆ—

## äº¤æ¢æœºç±»å‹

**Directï¼ˆç›´è¿äº¤æ¢æœºï¼‰**
äº¤æ¢æœºé€šè¿‡binding Keyå°†æ¶ˆæ¯ç²¾ç¡®æŠ•é€’è‡³æŒ‡å®šåç§°çš„é˜Ÿåˆ—

<img src="https://img-blog.csdnimg.cn/202012031559002.png" style="zoom:67%;"  >

**Topicï¼ˆä¸»é¢˜äº¤æ¢æœºï¼‰**
äº¤æ¢æœºé€šè¿‡ä¸¤ç§é€šé…ç¬¦ï¼ˆ* #ï¼‰å°†æ¶ˆæ¯æŠ•é€’è‡³ä¸bindingKeyåŒ¹é…çš„é˜Ÿåˆ—ã€‚

ã€ **.** ã€‘ç”¨æ¥åˆ†å‰²å¤šä¸ªè¯ï¼Œ"è¯"å¯ä»¥æ˜¯ä¸å«ç‰¹æ®Šå­—ç¬¦çš„ä»»æ„å­—ç¬¦ä¸²

ã€*ã€‘ åŒ¹é…ä¸€ä¸ªè¯

ã€#ã€‘ åŒ¹é…0æˆ–å¤šä¸ªè¯

<img src="https://img-blog.csdnimg.cn/20201203160018667.png" style="zoom:67%;"  >

**Fanoutï¼ˆå¹¿æ’­äº¤æ¢æœºï¼‰**

é˜Ÿåˆ—ä¸è¯¥äº¤æ¢æœºç»‘å®šæ—¶ï¼Œæ— éœ€æŒ‡å®šbinding keyï¼Œè¯¥äº¤æ¢æœºæ”¶åˆ°çš„æ¶ˆæ¯å°†å‘é€ç»™æ‰€æœ‰ä¸ä¹‹ç»‘å®šçš„é˜Ÿåˆ—ã€‚

**Headers**

è¯¥ç±»å‹äº¤æ¢æœºæ€§èƒ½å¾ˆå·®ï¼Œå¾ˆå°‘ä½¿ç”¨ï¼Œä¸å¤šåšä»‹ç»ã€‚

## æ¶ˆæ¯å­˜æ´»æ—¶é—´ Time To Liveï¼ˆTTLï¼‰

è®¾ç½®æ¶ˆæ¯TTLæœ‰ä¸¤ç§æ–¹å¼ï¼š

- è®¾ç½®é˜Ÿåˆ—TTLï¼Œå‘é€è‡³è¯¥é˜Ÿåˆ—çš„æ¶ˆæ¯è¶…è¿‡TTLæ—¶é—´æ— äººæ¶ˆè´¹ä¼šè¢«åˆ é™¤
- å•ç‹¬è®¾ç½®æ¶ˆæ¯TTL

å¦‚æœåŒæ—¶è®¾ç½®äº†é˜Ÿåˆ—å’Œæ¶ˆæ¯çš„TTL åˆ™æ—¶é—´çŸ­çš„ç”Ÿæ•ˆï¼ˆåŒæ—¶ç”Ÿæ•ˆï¼Œæ—¶é—´çŸ­çš„å…ˆæ‰§è¡Œï¼‰

```java
@Bean("ttlQueue")
public Queue queue() {
  Map<String, Object> msgConfig = new HashMap<String, Object>();
  // è®¾ç½®é˜Ÿåˆ—TTLï¼Œè¯¥é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯10så†…æœªè¢«æ¶ˆè´¹ï¼Œåˆ™ä¼šåˆ é™¤
  msgConfig.put("x-message-ttl", 10000);
  return new Queue("TTL_QUEUE", true, false, false, msgConfig);
}


//æŒ‡å®šæ¶ˆæ¯çš„TTL
@Autowired
private AmqpTemplate amqpTemplate;
public void sendMqMsg() {
  MessageProperties messageProperties = new MessageProperties();
  // æ¶ˆæ¯çš„è¿‡æœŸæ—¶é—´ï¼Œå•ä½ms
  messageProperties.setExpiration("5000"); 
  Message ttlMsg = new Message("è¿™æ¡æ¶ˆæ¯5såè‡ªåŠ¨åˆ é™¤".getBytes(), messageProperties);
  amqpTemplate.send("TTL_EXCHANGE", "ttl.routingkey", ttlMsg);
}
```



## æ­»ä¿¡é˜Ÿåˆ—

æ¶ˆæ¯æ— æ³•æ­£å¸¸æŠ•é€’/æ¶ˆè´¹åˆ™ä¼šè¿›å…¥æ­»ä¿¡é˜Ÿåˆ—ï¼Œè¿›å…¥æ­»ä¿¡é˜Ÿåˆ—æœ‰å¦‚ä¸‹å‡ ä¸ªåœºæ™¯ï¼š

- æ¶ˆæ¯è¢«æ¶ˆè´¹è€…æ‹’ç»æˆ–æœªæ”¶åˆ°æ¶ˆè´¹å“åº”(ack)ï¼Œä¸”æœªé‡æ–°å›åˆ°é˜Ÿåˆ—ï¼š(Reject || NotACK  ) && !requeue

- æ¶ˆæ¯è¿‡æœŸ(è¶…è¿‡TTLæ—¶é—´æœªæ¶ˆè´¹)
- æ¶ˆæ¯è¶…è¿‡ç›®æ ‡é˜Ÿåˆ—æ•°é™åˆ¶æˆ–æ¶ˆæ¯é•¿åº¦è¶…è¿‡é˜Ÿåˆ—é…ç½®çš„é™åˆ¶



### æ­»ä¿¡é˜Ÿåˆ—ç”¨æ³•

- ä½¿æ¶ˆæ¯æ²¡æœ‰æ¶ˆè´¹è€…è€Œè¿‡æœŸã€‚

```java
//äº¤æ¢æœº
@Bean("someExchange")
public DirectExchange exchange() {
  //è¿™é‡Œæ˜¯directäº¤æ¢æœº
  return new DirectExchange("SOME_EXCHANGE", true, false, new HashMap<>());
}

//é˜Ÿåˆ—
@Bean("someQueue")
public Queue queue() {
  Map<String, Object> map = new HashMap<String, Object>();
  // æ¶ˆæ¯5såæˆä¸ºæ­»ä¿¡
  map.put("x-message-ttl", 5000);
  // æŒ‡å®šæ­»ä¿¡äº¤æ¢æœºï¼Œé˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯å˜æˆæ­»ä¿¡åï¼Œè¿›å…¥æ­»ä¿¡äº¤æ¢æœº
  map.put("x-dead-letter-exchange", "DEAD_LETTER_EXCHANGE");

  return new Queue("SOME_EXCHANGE", true, false, false, map);
}

//é˜Ÿåˆ—ç»‘å®šè‡³äº¤æ¢æœº
@Bean
public Binding binding(@Qualifier("someQueue") Queue queue,
                       @Qualifier("someExchange") DirectExchange exchange) {
  //æ²¡æœ‰æ¶ˆè´¹è€…çš„æ¶ˆæ¯
  return BindingBuilder.bind(queue).to(exchange).with("noConsumer.routingKey");
}
```

- ç›´æ¥å£°æ˜æ­»ä¿¡é˜Ÿåˆ—å’Œæ­»ä¿¡äº¤æ¢æœºï¼Œå¹¶ç»‘å®š

```java
@Bean("deadLetterExchange")
public TopicExchange deadLetterExchange() {
  //è¿™é‡Œæ˜¯topicäº¤æ¢æœº
  return new TopicExchange("DEAD_LETTER_EXCHANGE", true, false, new HashMap<>());
}

@Bean("deadLetterQueue")
public Queue deadLetterQueue() {
  return new Queue("DEAD_LETTER_QUEUE", true, false, false, new HashMap<>());
}

@Bean
public Binding bindingDead(@Qualifier("deadLetterQueue") Queue queue,
                           @Qualifier("deadLetterExchange")TopicExchange exchange) {
  // æ— æ¡ä»¶è·¯ç”±
  return BindingBuilder.bind(queue).to(exchange).with("#"); 
}
```

è¿™æ ·æ¶ˆæ¯å°±è¿›å…¥äº†æ­»ä¿¡é˜Ÿåˆ—ï¼Œåç»­ä¸šåŠ¡ç›´æ¥ä»æ­»ä¿¡é˜Ÿåˆ—å–æ¶ˆæ¯ï¼Œå¤„ç†â€œæ­»ä¿¡æƒ…å†µä¸‹çš„ä¸šåŠ¡â€å³å¯



## å»¶æ—¶é˜Ÿåˆ—

RabbitMQå¹¶æœªç›´æ¥æä¾›å»¶æ—¶é˜Ÿåˆ—åŠŸèƒ½ï¼ŒåŸºäºTTL å’Œæ­»ä¿¡é˜Ÿåˆ—çš„ç‰¹ç‚¹ï¼ŒrabbitMQå¸¸è¢«è®¾è®¡ç”¨ä½œå»¶æ—¶é˜Ÿåˆ—ã€‚å³ï¼Œå¤„ç†ä¸€äº›â€œåˆ°ç‰¹å®šæ—¶é—´æ‰§è¡Œâ€çš„ä¸šåŠ¡ã€‚

å¸¸è§çš„ä¾‹å­å¦‚ï¼š

- è®¢å•è¶…æ—¶æœªæ”¯ä»˜è‡ªåŠ¨å–æ¶ˆ
- æ·˜å®å‘è´§å15å¤©è‡ªåŠ¨ç¡®è®¤
- å®šæ—¶ä»»åŠ¡ï¼Œåˆ°æŒ‡å®šæ—¶é—´å¯åŠ¨
- å…¶å®ƒå®šæ—¶/å»¶æ—¶æ‰§è¡Œçš„ä¸šåŠ¡... ...



å¯¹äºå®šæ—¶ä»»åŠ¡åœºæ™¯ï¼Œå¸¸è§åšæ³•å¦‚ä¸‹ï¼š

- å¼€çº¿ç¨‹ä¸åœæ‰«ææ•°æ®åº“æˆ–ç¼“å­˜ï¼Œç›‘å¬æ•°æ®çŠ¶æ€ï¼Œå‘ç°æ•°æ®æ”¹å˜æ—¶å¤„ç†ç‰¹å®šä¸šåŠ¡ã€‚
- é€šè¿‡æ¶ˆæ¯TTLä½¿å¾—æ¶ˆæ¯è¶…æ—¶ï¼Œè¿›å…¥æ­»ä¿¡é˜Ÿåˆ—ï¼Œå†ç›‘å¬æ­»ä¿¡é˜Ÿåˆ—è¿›è¡Œå¤„ç†
- åˆ©ç”¨rabbitmq-delayed-message-exchange æ’ä»¶å®ç°



è¿™é‡Œä¸»è¦è®²ä¸€ä¸‹TTL+DLXçš„å»¶æ—¶é˜Ÿåˆ—ï¼Œè¯¥æ–¹å¼å®ç°æ­»ä¿¡é˜Ÿåˆ—æœ‰å¦‚ä¸‹ç¼ºç‚¹ï¼š

- å®šçš„æ—¶é—´ä¸ä¼šå¾ˆå‡†æ—¶ï¼Œå­˜åœ¨å»¶è¿Ÿæ‰§è¡Œ
- TTLåªèƒ½å¯¹é˜Ÿåˆ—/æ¶ˆæ¯è¿›è¡Œè®¾ç½®ï¼Œå¦‚æœæ—¶é—´æ¢¯åº¦å¤šï¼ˆæ¯ä¸ªä¸šåŠ¡å…·æœ‰ä¸åŒçš„æ—¶é—´è¦æ±‚ï¼‰ï¼Œè®¾ç½®å¤ªå¤šæ¶ˆæ¯çš„TTLï¼Œåˆ™å¯èƒ½å¯¼è‡´æ¶ˆæ¯é˜»å¡ï¼›è®¾ç½®é˜Ÿåˆ—TTLï¼Œåˆ™éœ€è¦åˆ›å»ºå¾ˆå¤šé˜Ÿåˆ—(å’Œäº¤æ¢æœº) ; 

----

> æ–‡ç« å¯ä»¥ç™½å«–ï¼Œè€é“ä»¬é¡ºä¾¿å…³æ³¨ä¸€ä¸‹æˆ‘çš„å…¬ä¼—å·ï¼Œæ‰‹åŠ¨æ»‘ç¨½ğŸ¤£ğŸ¤£ &nbsp;
>
> æ¬¢è¿å¤§å®¶å…³æ³¨ï¼š**æ­¦å“¥èŠç¼–ç¨‹**ã€**Javaå¼€å‘å®å…¸**ã€**Javaç§ƒå¤´å“¥**ï¼Œæ‚¨çš„æ”¯æŒï¼Œæ˜¯æˆ‘åˆ›ä½œçš„æŒç»­åŠ¨åŠ›ï¼&nbsp;&nbsp;

![æ­¦å“¥èŠç¼–ç¨‹](https://img-blog.csdnimg.cn/202002150421550.jpg)![Javaå¼€å‘å®å…¸](https://img-blog.csdnimg.cn/20200608005630228.png)![Javaç§ƒå¤´å“¥](https://img-blog.csdnimg.cn/20201025170941235.png)

