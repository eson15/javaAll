> æ–‡ç« å¯ä»¥ç™½å«–ï¼Œå…¬ä¼—å·ä¸èƒ½ä¸å…³æ³¨ï¼Œæ‰‹åŠ¨æ»‘ç¨½ğŸ¤£ğŸ¤£ &nbsp;
>
> æ¬¢è¿å¤§å®¶å…³æ³¨ï¼š**æ­¦å“¥èŠç¼–ç¨‹**ã€**Javaå¼€å‘å®å…¸**ï¼Œæ‚¨çš„æ”¯æŒï¼Œæ˜¯æˆ‘ä»¬åˆ›ä½œçš„æŒç»­åŠ¨åŠ›ï¼&nbsp;&nbsp;

![æ­¦å“¥èŠç¼–ç¨‹](https://img-blog.csdnimg.cn/202002150421550.jpg)![Javaå¼€å‘å®å…¸](https://img-blog.csdnimg.cn/20200608005630228.png)![Javaç§ƒå¤´å“¥](https://img-blog.csdnimg.cn/20201025170941235.png)

----

##### å†™åœ¨å‰é¢ï¼š

å°ä¼™ä¼´å„¿ä»¬ï¼Œå¤§å®¶å¥½ï¼ä¸Šä¸€ç¯‡æˆ‘ä»¬å­¦ä¹ äº†Springä¸­çš„æ•°æ®åº“ç¼–ç¨‹ç›¸å…³çŸ¥è¯†ï¼›
ç°åœ¨æˆ‘ä»¬æ¥å­¦ä¹ ä¸€ä¸‹Springä¸­äº‹åŠ¡ç®¡ç†ã€‚

##### æ€ç»´å¯¼å›¾ï¼š

![image-20201108225716315](https://gitee.com/Huke-123/PicCloud/raw/master/20201108225716.png)

## 1ï¼Œäº‹åŠ¡æ˜¯ä»€ä¹ˆï¼Ÿ

æ•°æ®åº“äº‹åŠ¡( transaction)æ˜¯è®¿é—®å¹¶å¯èƒ½æ“ä½œå„ç§æ•°æ®é¡¹çš„ä¸€ä¸ªæ•°æ®åº“æ“ä½œåºåˆ—ï¼Œè¿™äº›æ“ä½œè¦ä¹ˆå…¨éƒ¨æ‰§è¡Œ,è¦ä¹ˆå…¨éƒ¨ä¸æ‰§è¡Œï¼Œæ˜¯ä¸€ä¸ªä¸å¯åˆ†å‰²çš„å·¥ä½œå•ä½ã€‚äº‹åŠ¡ç”±äº‹åŠ¡å¼€å§‹ä¸äº‹åŠ¡ç»“æŸä¹‹é—´æ‰§è¡Œçš„å…¨éƒ¨æ•°æ®åº“æ“ä½œç»„æˆã€‚

**äº‹åŠ¡çš„å››å¤§ç‰¹æ€§ï¼š**

- åŸå­æ€§ï¼ˆatomicityï¼‰ã€‚ä¸€ä¸ªäº‹åŠ¡æ˜¯ä¸€ä¸ªä¸å¯åˆ†å‰²çš„å·¥ä½œå•ä½ï¼Œäº‹åŠ¡ä¸­åŒ…æ‹¬çš„æ“ä½œ**è¦ä¹ˆéƒ½åšï¼Œè¦ä¹ˆéƒ½ä¸åš**ã€‚
- ä¸€è‡´æ€§ï¼ˆconsistencyï¼‰ã€‚äº‹åŠ¡å¿…é¡»æ˜¯ä½¿æ•°æ®åº“ä»ä¸€ä¸ª**ä¸€è‡´æ€§çŠ¶æ€**å˜åˆ°å¦ä¸€ä¸ª**ä¸€è‡´æ€§çŠ¶æ€**ã€‚ä¸€è‡´æ€§ä¸åŸå­æ€§æ˜¯å¯†åˆ‡ç›¸å…³çš„ã€‚
- éš”ç¦»æ€§ï¼ˆisolationï¼‰ã€‚ä¸€ä¸ªäº‹åŠ¡çš„æ‰§è¡Œ**ä¸èƒ½è¢«å…¶ä»–äº‹åŠ¡å¹²æ‰°**ã€‚å³ä¸€ä¸ªäº‹åŠ¡å†…éƒ¨çš„æ“ä½œåŠä½¿ç”¨çš„æ•°æ®å¯¹å¹¶å‘çš„å…¶ä»–äº‹åŠ¡æ˜¯éš”ç¦»çš„ï¼Œå¹¶å‘æ‰§è¡Œçš„å„ä¸ªäº‹åŠ¡ä¹‹é—´**ä¸èƒ½äº’ç›¸å¹²æ‰°**ã€‚
- æŒä¹…æ€§ï¼ˆdurabilityï¼‰ã€‚æŒä¹…æ€§ä¹Ÿç§°æ°¸ä¹…æ€§ï¼ˆpermanenceï¼‰ï¼ŒæŒ‡ä¸€ä¸ªäº‹åŠ¡ä¸€æ—¦æäº¤ï¼Œå®ƒå¯¹æ•°æ®åº“ä¸­æ•°æ®çš„æ”¹å˜å°±åº”è¯¥æ˜¯**æ°¸ä¹…æ€§çš„**ã€‚æ¥ä¸‹æ¥çš„å…¶ä»–æ“ä½œæˆ–æ•…éšœä¸åº”è¯¥å¯¹å…¶æœ‰ä»»ä½•å½±å“ã€‚

## 2ï¼ŒSpringä¸­çš„äº‹åŠ¡æ§åˆ¶

äº‹åŠ¡ä¸­çš„ä¸‰å¤§æ¥å£ï¼š

### 2.1ï¼ŒPlatformTransaction Manager äº‹åŠ¡ç®¡ç†å™¨

PlatformTransactionManager æ¥å£æä¾›äº‹åŠ¡æ“ä½œçš„æ–¹æ³•ï¼ŒåŒ…å«æœ‰3ä¸ªå…·ä½“çš„æ“ä½œï¼›

```java
public interface PlatformTransactionManager {
 
    //æ ¹æ®äº‹åŠ¡å®šä¹‰TransactionDefinitionï¼Œè·å–äº‹åŠ¡çŠ¶æ€ä¿¡æ¯
    TransactionStatus getTransaction(TransactionDefinition definition);
 
    //æäº¤äº‹åŠ¡
    void commit(TransactionStatus status);
 
    //å›æ»šäº‹åŠ¡
    void rollback(TransactionStatus status);
}
```

### 2.2ï¼ŒTransactionDefinition  äº‹åŠ¡å®šä¹‰

TransactionDefinition æ¥å£å®šä¹‰äº†äº‹åŠ¡çš„ä¸€äº›åŸºç¡€ä¿¡æ¯ï¼Œå¦‚è¶…æ—¶æ—¶é—´ã€éš”ç¦»çº§åˆ«ä»¥åŠä¼ æ’­å±æ€§ç­‰ã€‚

```java
public class DefaultTransactionDefinition implements TransactionDefinition, Serializable {
    private int propagationBehavior = PROPAGATION_REQUIRED;
    private int isolationLevel = ISOLATION_DEFAULT;
    private int timeout = TIMEOUT_DEFAULT;
    private boolean readOnly = false;
    ...
}
```

#### 2.2.1ï¼Œäº‹åŠ¡çš„éš”ç¦»çº§åˆ«

> `ISOLATION_DEFAULT`ï¼šæ•°æ®åº“é»˜è®¤çš„éš”ç¦»çº§åˆ«ï¼Œé€šå¸¸æƒ…å†µä¸‹æ˜¯Read Committedã€‚
>
> `ISOLATION_READ_UNC0MMITTED`ï¼šå¯¹åº”Read Uncommittedéš”ç¦»çº§åˆ«ï¼Œ**æ— æ³•é¿å…**è„è¯»ï¼Œä¸å¯é‡å¤è¯»å’Œå¹»è¯»ï¼Œå¯ä»¥è¯»å–æœªæäº¤æ•°æ®ã€‚
>
> `ISOLATION_READ_COMMITTED`ï¼šå¯¹åº”Read Committedéš”ç¦»çº§åˆ«ï¼Œ**å¯ä»¥é¿å…**è„è¯»ï¼Œä½†**æ— æ³•é¿å…**ä¸å¯é‡å¤è¯»å’Œå¹»è¯»ï¼Œåªèƒ½è¯»å–å·²æäº¤æ•°æ®ã€‚
>
> `ISOLATION_REPEATABLEREADE`ï¼šå¯¹åº”Repeatable readéš”ç¦»çº§åˆ«ï¼Œ**å¯ä»¥é¿å…**è„è¯»å’Œä¸å¯é‡å¤è¯»ï¼Œä½†**ä¸èƒ½é¿å…**å¹»è¯»ï¼Œæ˜¯å¦è¯»å–å…¶ä»–äº‹åŠ¡å·²ä¿®æ”¹çš„æ•°æ®ã€‚
>
> `ISOLATION-SERIALIZABLE`ï¼šå¯¹åº”Serializableéš”ç¦»çº§åˆ«ï¼Œ**å¯ä»¥é¿å…æ‰€æœ‰**çš„è„è¯»ï¼Œä¸å¯é‡å¤è¯»ä»¥åŠå¹»è¯»ï¼Œä½†å¹¶å‘æ€§æ•ˆç‡æœ€ä½ã€‚

<img src="https://gitee.com/Huke-123/PicCloud/raw/master/20201108202120.png" alt="image-20201108202113105" style="zoom:80%;" />

ç®€å•ä»‹ç»è„è¯»ï¼Œä¸å¯é‡å¤è¯»å’Œå¹»è¯»ï¼š

> è„è¯»ï¼ˆè¯»å–æœªæäº¤æ•°æ®ï¼‰
>
> ä¸å¯é‡å¤è¯»ï¼ˆå‰åå¤šæ¬¡è¯»å–ï¼Œæ•°æ®å†…å®¹ä¸ä¸€è‡´ï¼‰
>
> å¹»è¯»ï¼ˆå‰åå¤šæ¬¡è¯»å–ï¼Œæ•°æ®æ€»é‡ä¸ä¸€è‡´ï¼‰

#### 2.2.2ï¼Œäº‹åŠ¡çš„ä¼ æ’­è¡Œä¸º

Springä¸­7ä¸ªäº‹åŠ¡ä¼ æ’­è¡Œä¸ºï¼š

<img src="https://gitee.com/Huke-123/PicCloud/raw/master/20201108204053.png" alt="image-20201108204053702" style="zoom:80%;" />

#### 2.2.3ï¼Œè¶…æ—¶æ—¶é—´

çº¿ç¨‹å·²ç»è·‘åˆ°æ–¹æ³•é‡Œé¢ï¼Œå¦‚æœå·²ç»è¶…è¿‡è®¾ç½®æ—¶é—´äº†è¿˜æ²¡è·‘å®Œè¿™ä¸ªæ–¹æ³•å¹¶ä¸”çº¿ç¨‹åœ¨è¿™ä¸ªæ–¹æ³•ä¸­çš„åé¢è¿˜æœ‰æ¶‰åŠåˆ°å¯¹æ•°æ®åº“çš„å¢åˆ æ”¹æŸ¥æ“ä½œæ—¶ä¼šæŠ¥äº‹åŠ¡è¶…æ—¶é”™è¯¯ï¼ˆä¼šå›æ»šï¼‰ã€‚å¦‚æœå·²ç»è¿‡å»è®¾ç½®æ—¶é—´äº†è¿˜æ²¡è·‘å®Œä½†æ˜¯åé¢å·²ç»æ²¡æœ‰æ¶‰åŠåˆ°å¯¹æ•°æ®åº“çš„å¢åˆ æ”¹æŸ¥æ“ä½œï¼Œé‚£ä¹ˆè¿™æ—¶ä¸ä¼šæŠ¥äº‹åŠ¡è¶…æ—¶é”™è¯¯ï¼ˆä¸ä¼šå›æ»šï¼‰ã€‚

#### 2.2.4ï¼Œåªè¯»äº‹åŠ¡

å¹¶ä¸æ˜¯ä¸èƒ½åœ¨äº‹åŠ¡ä¸­è¿›è¡Œä¿®æ”¹ç­‰æ“ä½œï¼Œå®ƒåªæ˜¯ä¸€ä¸ªæš—ç¤ºï¼Œæç¤ºæ•°æ®åº“é©±åŠ¨ç¨‹åºå’Œæ•°æ®åº“ç³»ç»Ÿï¼Œè¿™ä¸ªäº‹åŠ¡å¹¶ä¸åŒ…å«æ›´æ”¹æ•°æ®çš„æ“ä½œï¼Œé‚£ä¹ˆJDBCé©±åŠ¨ç¨‹åºå’Œæ•°æ®åº“å°±æœ‰å¯èƒ½æ ¹æ®è¿™ç§æƒ…å†µå¯¹è¯¥äº‹åŠ¡è¿›è¡Œä¸€äº›ç‰¹å®šçš„ä¼˜åŒ–ï¼Œæ¯”æ–¹è¯´ä¸å®‰æ’ç›¸åº”çš„æ•°æ®åº“é”ï¼Œä»¥å‡è½»äº‹åŠ¡å¯¹æ•°æ®åº“çš„å‹åŠ›ï¼Œæ¯•ç«Ÿäº‹åŠ¡ä¹Ÿæ˜¯è¦æ¶ˆè€—æ•°æ®åº“çš„èµ„æºçš„ã€‚åªè¯»äº‹åŠ¡ä»…ä»…æ˜¯ä¸€ä¸ªæ€§èƒ½ä¼˜åŒ–çš„æ¨èé…ç½®è€Œå·²ï¼Œå¹¶éå¼ºåˆ¶ä½ éè¦è¿™æ ·å¤„ç†ä¸å¯ã€‚

### 2.3ï¼ŒTransactionStatus  äº‹åŠ¡çŠ¶æ€

TransactionStatus æ¥å£å®šä¹‰äº†äº‹åŠ¡çš„ä¸€äº›çŠ¶æ€ä¿¡æ¯ï¼Œå¦‚æ˜¯éƒ½ä¸€ä¸ªæ–°çš„äº‹åŠ¡ã€æ˜¯å¦å·²è¢«æ ‡è®°å›æ»šã€‚

```java
public interface SavepointManager {
    Object createSavepoint() throws TransactionException;
    void rollbackToSavepoint(Object savepoint) throws TransactionException;
    void releaseSavepoint(Object savepoint) throws TransactionException;
}
```

1ã€ä½¿ç”¨Transactionstatusæä¾›çš„ç›¸åº”æ–¹æ³•æŸ¥è¯¢äº‹åŠ¡çŠ¶æ€ã€‚

2ã€é€šè¿‡setRolIbackOnly ()æ–¹æ³•æ ‡è®°å½“å‰äº‹åŠ¡ä»¥ä½¿å…¶å›æ»šã€‚

3ã€å¦‚æœç›¸åº”çš„PlatformTransactionManageræ”¯æŒSavepoint,å¯ä»¥é€šè¿‡ Transactionstatusåœ¨å½“å‰äº‹åŠ¡ä¸­åˆ›å»ºå†…éƒ¨åµŒå¥—äº‹åŠ¡ã€‚

## 3ï¼ŒSpringåŸºäºæ³¨è§£çš„å£°æ˜å¼äº‹åŠ¡æ§åˆ¶

æˆ‘ä»¬æ–°å»ºä¸€ä¸ªæ™®é€šçš„mavené¡¹ç›®ï¼Œå…¶pom.xmlé…ç½®å¦‚ä¸‹ï¼š

```xml
<dependencies>
        <dependency>
            <groupId>org.springframework</groupId>
            <artifactId>spring-context</artifactId>
            <version>5.0.2.RELEASE</version>
        </dependency>

        <dependency>
            <groupId>org.springframework</groupId>
            <artifactId>spring-jdbc</artifactId>
            <version>5.0.2.RELEASE</version>
        </dependency>

        <dependency>
            <groupId>org.springframework</groupId>
            <artifactId>spring-tx</artifactId>
            <version>5.0.2.RELEASE</version>
        </dependency>

        <dependency>
            <groupId>org.springframework</groupId>
            <artifactId>spring-test</artifactId>
            <version>5.0.2.RELEASE</version>
        </dependency>

        <dependency>
            <groupId>mysql</groupId>
            <artifactId>mysql-connector-java</artifactId>
            <version>5.1.6</version>
        </dependency>

        <dependency>
            <groupId>org.aspectj</groupId>
            <artifactId>aspectjweaver</artifactId>
            <version>1.8.7</version>
        </dependency>

        <dependency>
            <groupId>junit</groupId>
            <artifactId>junit</artifactId>
            <version>4.12</version>
        </dependency>
    </dependencies>
```

ä¾‹å­æ¶æ„ä¹Ÿå’Œä¹‹å‰å·®ä¸å¤šï¼Œæ–°å»ºå®ä½“ç±»Accountï¼ŒåŠ ä¸Šidï¼Œnameä»¥åŠmoneyå±æ€§ï¼Œè¿˜æœ‰getå’Œsetæ–¹æ³•ä»¥åŠtoString()æ–¹æ³•ï¼›

ç„¶åæ˜¯æŒä¹…å±‚æ¥å£daoå±‚ï¼š

<img src="https://gitee.com/Huke-123/PicCloud/raw/master/20201108223011.png" alt="image-20201108223011212" style="zoom:80%;" />

ä»¥åŠå®ƒçš„å®ç°ç±»ï¼š

```java
/**
 * è´¦æˆ·çš„æŒä¹…å±‚å®ç°ç±»
 */
@Repository("accountDao")
public class AccountDaoImpl implements IAccountDao {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    public Account findAccountById(Integer accountId) {
        List<Account> accounts = jdbcTemplate.query("select * from account where id = ?",new BeanPropertyRowMapper<Account>(Account.class),accountId);
        return accounts.isEmpty()?null:accounts.get(0);
    }

    public Account findAccountByName(String accountName) {
        List<Account> accounts = jdbcTemplate.query("select * from account where name = ?",new BeanPropertyRowMapper<Account>(Account.class),accountName);
        if(accounts.isEmpty()){
            return null;
        }
        if(accounts.size()>1){
            throw new RuntimeException("ç»“æœé›†ä¸å”¯ä¸€");
        }
        return accounts.get(0);
    }

    public void updateAccount(Account account) {
        jdbcTemplate.update("update account set name=?,money=? where id=?",account.getName(),account.getMoney(),account.getId());
    }
}
```

ç„¶åæ˜¯ä¸šåŠ¡å±‚æ¥å£serviceå±‚ï¼š

![image-20201108225229256](https://gitee.com/Huke-123/PicCloud/raw/master/20201108225229.png)

ä»¥åŠå®ƒçš„å®ç°ç±»ï¼š

```java
/**
 * è´¦æˆ·çš„ä¸šåŠ¡å±‚å®ç°ç±»
 *
 * äº‹åŠ¡æ§åˆ¶åº”è¯¥éƒ½æ˜¯åœ¨ä¸šåŠ¡å±‚
 */
@Service("accountService")
@Transactional(propagation= Propagation.SUPPORTS,readOnly=true)//åªè¯»å‹äº‹åŠ¡çš„é…ç½®
public class AccountServiceImpl implements IAccountService{

    @Autowired
    private IAccountDao accountDao;

    public Account findAccountById(Integer accountId) {
        return accountDao.findAccountById(accountId);

    }

    //éœ€è¦çš„æ˜¯è¯»å†™å‹äº‹åŠ¡é…ç½®
    @Transactional(propagation= Propagation.REQUIRED,readOnly=false)
    public void transfer(String sourceName, String targetName, Float money) {
        System.out.println("transfer....");
            //2.1æ ¹æ®åç§°æŸ¥è¯¢è½¬å‡ºè´¦æˆ·
            Account source = accountDao.findAccountByName(sourceName);
            //2.2æ ¹æ®åç§°æŸ¥è¯¢è½¬å…¥è´¦æˆ·
            Account target = accountDao.findAccountByName(targetName);
            //2.3è½¬å‡ºè´¦æˆ·å‡é’±
            source.setMoney(source.getMoney()-money);
            //2.4è½¬å…¥è´¦æˆ·åŠ é’±
            target.setMoney(target.getMoney()+money);
            //2.5æ›´æ–°è½¬å‡ºè´¦æˆ·
            accountDao.updateAccount(source);
            //2.6æ›´æ–°è½¬å…¥è´¦æˆ·
            accountDao.updateAccount(target);
    }
}
```

è¿˜æœ‰é‡è¦çš„`bean.xml`é…ç½®æ–‡ä»¶ï¼š

```xml
<!-- é…ç½®springåˆ›å»ºå®¹å™¨æ—¶è¦æ‰«æçš„åŒ…-->
    <context:component-scan base-package="com.java"></context:component-scan>

    <!-- é…ç½®JdbcTemplate-->
    <bean id="jdbcTemplate" class="org.springframework.jdbc.core.JdbcTemplate">
        <property name="dataSource" ref="dataSource"></property>
    </bean>

    <!-- é…ç½®æ•°æ®æº-->
    <bean id="dataSource" class="org.springframework.jdbc.datasource.DriverManagerDataSource">
        <property name="driverClassName" value="com.mysql.jdbc.Driver"></property>
        <property name="url" value="jdbc:mysql://localhost:3306/db_bank"></property>
        <property name="username" value="root"></property>
        <property name="password" value="123456"></property>
    </bean>

    <!-- springä¸­åŸºäºæ³¨è§£ çš„å£°æ˜å¼äº‹åŠ¡æ§åˆ¶é…ç½®æ­¥éª¤
        1ã€é…ç½®äº‹åŠ¡ç®¡ç†å™¨
        2ã€å¼€å¯springå¯¹æ³¨è§£äº‹åŠ¡çš„æ”¯æŒ
        3ã€åœ¨éœ€è¦äº‹åŠ¡æ”¯æŒçš„åœ°æ–¹ä½¿ç”¨@Transactionalæ³¨è§£
     -->
    <!-- é…ç½®äº‹åŠ¡ç®¡ç†å™¨ -->
    <bean id="transactionManager" class="org.springframework.jdbc.datasource.DataSourceTransactionManager">
        <property name="dataSource" ref="dataSource"></property>
    </bean>

    <!-- å¼€å¯springå¯¹æ³¨è§£äº‹åŠ¡çš„æ”¯æŒ-->
    <tx:annotation-driven transaction-manager="transactionManager"></tx:annotation-driven>
```

æœ€åæˆ‘ä»¬åœ¨æµ‹è¯•ç±»è¿›è¡Œæµ‹è¯•ï¼š

```java
/**
 * ä½¿ç”¨Junitå•å…ƒæµ‹è¯•ï¼šæµ‹è¯•æˆ‘ä»¬çš„é…ç½®
 */
@RunWith(SpringJUnit4ClassRunner.class)
@ContextConfiguration(locations = "classpath:bean.xml")
public class AccountServiceTest {

    @Autowired
    private  IAccountService as;

    @Test
    public  void testTransfer(){
        as.transfer("aaa","bbb",100f);

    }
}
```

è¿è¡Œä¹‹åæˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ•°æ®åº“å·²ç»å‘ç”Ÿå˜åŒ–äº†ï¼Œäº§ç”Ÿäº†ä½œç”¨ã€‚

## å°ç»“ï¼š

è¿™èŠ‚æˆ‘ä»¬å­¦ä¹ äº†Springä¸­çš„äº‹åŠ¡ç®¡ç†ï¼Œåˆè¯†äº†äº‹åŠ¡ä»¥åŠåœ¨Springè¿ç”¨äº‹åŠ¡ã€‚

----

> æ–‡ç« å¯ä»¥ç™½å«–ï¼Œå…¬ä¼—å·ä¸èƒ½ä¸å…³æ³¨ï¼Œæ‰‹åŠ¨æ»‘ç¨½ğŸ¤£ğŸ¤£ &nbsp;
>
> æ¬¢è¿å¤§å®¶å…³æ³¨ï¼š**æ­¦å“¥èŠç¼–ç¨‹**ã€**Javaå¼€å‘å®å…¸**ï¼Œæ‚¨çš„æ”¯æŒï¼Œæ˜¯æˆ‘ä»¬åˆ›ä½œçš„æŒç»­åŠ¨åŠ›ï¼&nbsp;&nbsp;

![æ­¦å“¥èŠç¼–ç¨‹](https://img-blog.csdnimg.cn/202002150421550.jpg)![Javaå¼€å‘å®å…¸](https://img-blog.csdnimg.cn/20200608005630228.png)![Javaç§ƒå¤´å“¥](https://img-blog.csdnimg.cn/20201025170941235.png)
