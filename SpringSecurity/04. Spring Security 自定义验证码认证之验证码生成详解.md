# Spring Security è‡ªå®šä¹‰éªŒè¯ç è®¤è¯ä¹‹éªŒè¯ç ç”Ÿæˆ

> æ–‡ç« å¯ä»¥ç™½å«–ï¼Œå…¬ä¼—å·ä¸èƒ½ä¸å…³æ³¨ï¼Œæ‰‹åŠ¨æ»‘ç¨½ğŸ¤£ğŸ¤£ &nbsp;
>
> æ¬¢è¿å¤§å®¶å…³æ³¨ï¼š**æ­¦å“¥èŠç¼–ç¨‹**ã€**Javaå¼€å‘å®å…¸**ï¼Œæ‚¨çš„æ”¯æŒï¼Œæ˜¯æˆ‘åˆ›ä½œçš„æŒç»­åŠ¨åŠ›ï¼&nbsp;&nbsp;

![æ­¦å“¥èŠç¼–ç¨‹](https://img-blog.csdnimg.cn/202002150421550.jpg)![Javaå¼€å‘å®å…¸](https://img-blog.csdnimg.cn/20200608005630228.png)

----

å…ˆçœ‹ä¸‹æœ¬æ–‡çš„æ€ç»´å¯¼å›¾

![å›¾1-1 éªŒè¯ç ç”Ÿæˆ æ¦‚å›¾](https://img-blog.csdnimg.cn/20200926182558751.png?x-oss-process=image)

## æ¦‚è¿°

æ€»æ‰€å‘¨çŸ¥ï¼ŒéªŒè¯ç æ–¹å¼çš„ç™»å½•æ¨¡å¼ååˆ†çš„æ™®éï¼Œä¸è¿‡ ```Spring Security``` å¹¶æ²¡æœ‰æä¾›æ¯”è¾ƒå¥½çš„åŸç”Ÿè§£å†³æ–¹æ¡ˆï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥ ```do it by ourselvesï¼```ï¼Œæœ¬æ–‡çš„ç¯‡å¹…ç›¸å¯¹æ¯”è¾ƒé•¿ï¼Œå› æ­¤åˆ†ä¸Šä¸‹ç¯‡åˆ†åˆ«æ¥ä»‹ç»ã€‚ä¸Šç¯‡ä¸»è¦ä»‹ç»ï¼šéªŒè¯ç çš„ç”Ÿæˆï¼Œä¸‹ç¯‡å¯¹è‡ªå®šä¹‰éªŒè¯ç ç™»å½•çš„æµç¨‹è¿›è¡Œè®²è§£ã€‚

æˆ‘ä»¬æ¯”è¾ƒå¸¸è§çš„éªŒè¯ç ä¸»è¦æœ‰ä¸¤ç§ï¼šå›¾å½¢éªŒè¯ç ä»¥åŠçŸ­ä¿¡éªŒè¯ç ï¼Œç›¸å¯¹æ¥è¯´ä¸æ˜¯ç‰¹åˆ«çš„å¤æ‚ã€‚å¯èƒ½ä¼šæœ‰äººæœ‰ç–‘æƒ‘ï¼šä¸ºä»€ä¹ˆç®€å•çš„éªŒè¯ç ç”Ÿæˆéœ€è¦èŠ±è´¹ä¸€æ•´ç¯‡å¹…æ¥ä»‹ç»å‘¢ï¼ŸåŸå› å½“ç„¶æ˜¯ï¼šèº«ä¸ºèœé¸Ÿçš„æˆ‘ä¹Ÿæœ‰ä¸€ä¸ªæ¶æ„å¸ˆçš„æ¢¦ï¼éªŒè¯ç çš„ç”Ÿæˆä¼šç»“åˆæ¨¡æ¿æ–¹æ³•æ¨¡å¼ä¸€èµ·è®²è§£ã€‚

## åˆæ¢æ¨¡æ¿æ–¹æ³•æ¨¡å¼

æ¨¡æ¿æ–¹æ³•æ¨¡å¼å±äºä¸€ç§è¡Œä¸ºå‹çš„è®¾è®¡æ¨¡å¼ï¼Œä¸»è¦æ˜¯ç”¨æ¥è§£å†³å¤ç”¨å’Œæ‰©å±•ä¸¤ä¸ªé—®é¢˜ã€‚

æ¨¡æ¿æ–¹æ³•æ¨¡å¼åœ¨ä¸€ä¸ªæ–¹æ³•ä¸­å®šä¹‰ä¸€ä¸ª```ç®—æ³•éª¨æ¶```ï¼Œå¹¶å°†æŸäº›æ­¥éª¤æ¨è¿Ÿåˆ°æŸäº›å­ç±»ä¸­å®ç°ã€‚è¯¥æ¨¡å¼å¯ä»¥è®©å­ç±»åœ¨ä¸æ”¹å˜ç®—æ³•æ•´ä½“ç»“æ„çš„æƒ…å†µï¼Œé‡æ–°å®šä¹‰ç®—æ³•ä¸­çš„æŸäº›æ­¥éª¤ç»†èŠ‚ã€‚

è¿™é‡Œæåˆ°äº†ä¸€ä¸ªç®—æ³•éª¨æ¶çš„æ¦‚å¿µï¼Œ```ç®—æ³•``` å¹¶éæ˜¯æŒ‡æ•°æ®ç»“æ„ä¸­çš„â€œç®—æ³•â€ï¼Œå¯ä»¥ç†è§£ä¸ºå¹¿ä¹‰ä¸Šçš„ä¸šåŠ¡é€»è¾‘ï¼› ```éª¨æ¶``` æ¶å­å…¶å®å°±æ˜¯æ¨¡æ¿ï¼›æ€»çš„æ¥è¯´ï¼š```ç®—æ³•éª¨æ¶``` å¯ä»¥ç†è§£ä¸ºåŒ…å«å¹¿ä¹‰ä¸šåŠ¡é€»è¾‘çš„æ¨¡æ¿æ–¹æ³•ã€‚

## å®è·µå‡ºçœŸçŸ¥

ç»å¤§éƒ¨åˆ†çš„è®¾è®¡æ¨¡å¼çš„åŸç†éƒ½ååˆ†çš„ç®€å•ï¼Œéš¾å¾—æ˜¯å°†åŸç†è½å®åˆ°å®è·µä¸­ï¼Œè§£å†³å®é™…é—®é¢˜ã€‚

æˆ‘ä»¬çŸ¥é“æ¨¡æ¿æ–¹æ³•æ¨¡å¼ä¸»è¦æ˜¯ç”¨æ¥è§£å†³ ```å¤ç”¨``` å’Œ ```æ‰©å±•``` è¿™ä¸¤ä¸ªé—®é¢˜ï¼Œç»“åˆåˆ°å®é™…æƒ…å†µä¸­æ¥åˆ†æï¼›éªŒè¯ç ç”Ÿæˆæœ‰å“ªäº›åœ°æ–¹éœ€è¦ ```å¤ç”¨``` å’Œ ```æ‰©å±•``` å‘¢ï¼Ÿ

è®©æˆ‘ä»¬æ¥æ¢³ç†ä¸€ä¸‹éªŒè¯ç ç™»å½•æ¨¡å¼çš„æµç¨‹ï¼Œæ— è®ºæ˜¯çŸ­ä¿¡éªŒè¯ç è¿˜æ˜¯å›¾å½¢éªŒè¯ç ï¼Œå¤§è‡´ä¸Šéƒ½æœ‰å¦‚ä¸‹æ­¥éª¤ï¼š ç”ŸæˆéªŒè¯ç ã€å­˜å‚¨ã€å‘é€ã€æ ¡éªŒï¼›æ—¢ç„¶æµç¨‹ä¸Šç›¸åŒï¼Œé‚£ä¹ˆå°±èƒ½åšåˆ°```å¤ç”¨```ã€‚è€Œ ```æ‰©å±•``` å¹¶éæ˜¯æŒ‡ä»£ç çš„æ‰©å±•æ€§ï¼Œè€Œæ˜¯æŒ‡æ¡†æ¶ä¸Šçš„æ‰©å±•æ€§ï¼Œæ¨¡æ¿æ–¹æ³•æ¨¡å¼å¯ä»¥è®©ä½¿ç”¨è€…åœ¨ä¸ä¿®æ”¹éª¨æ¶æºç çš„æƒ…å†µä¸‹ï¼Œå®šåˆ¶åŒ–æ‰©å±•åŠŸèƒ½ã€‚

åºŸè¯ä¸å¤šè¯´ï¼Œæ¥ä¸‹æ¥å°±æ¥ç…ç…æ¨¡æ¿æ–¹æ³•æ¨¡å¼åœ¨éªŒè¯ç ç”Ÿæˆæ¨¡å—çš„è½åœ°æƒ…å†µå§ï¼è¿˜æ˜¯è€è§„çŸ©ï¼Œå…ˆä¸Šå›¾ï¼š

![å›¾1-2 éªŒè¯ç å…³ç³»æ¦‚è§ˆå›¾](https://img-blog.csdnimg.cn/2020092618062910.png?x-oss-process=image)

éªŒè¯ç çš„ç”Ÿæˆä¸»è¦åˆ†3ä¸ªæ¨¡å—ï¼šéª¨æ¶æ¨¡å—ã€éªŒè¯ç ç”Ÿå‘½å‘¨æœŸæ¨¡å—ã€å…·ä½“éªŒè¯ç æ¨¡å—ï¼ˆçŸ­ä¿¡éªŒè¯ç å’Œå›¾å½¢éªŒè¯ç ï¼‰

- éª¨æ¶æ¨¡å—ä¸»è¦åŒ…å« ```ValidateCodeProcessor``` æ¥å£ä»¥åŠ```AbstractValidateCodeProcessor```æŠ½è±¡ç±»ï¼›å°è£…äº†éªŒè¯ç ç›¸å…³çš„å¯å¤ç”¨çš„ä¸šåŠ¡é€»è¾‘ã€‚

- éªŒè¯ç ç”Ÿå‘½å‘¨æœŸæ¨¡å—æ˜¯æŒ‡ï¼šéªŒè¯ç çš„ç”Ÿæˆã€å­˜å‚¨ã€å‘é€ã€‚

- å…·ä½“éªŒè¯ç æ¨¡å—æ¶‰åŠçŸ­ä¿¡éªŒè¯ç å’Œå›¾å½¢éªŒè¯ç ï¼ŒåŸºäºéª¨æ¶é‡æ–°å®šä¹‰è‡ªå·±çš„ç›¸å…³å®ç°ã€‚

### éªŒè¯ç éª¨æ¶

æ— è®ºæ˜¯å›¾å½¢éªŒè¯ç è¿˜æ˜¯çŸ­ä¿¡éªŒè¯ç ï¼ŒéªŒè¯ç çš„ç›¸å…³ä¸šåŠ¡é€»è¾‘ï¼ˆ```ç®—æ³•éª¨æ¶```ï¼‰éƒ½æ˜¯å¤§åŒå°å¼‚çš„ï¼›ä¸»è¦æ˜¯éªŒè¯ç çš„ ```åˆ›å»ºæµç¨‹``` å’Œ ```éªŒè¯æµç¨‹```ã€‚å› æ­¤ä½¿ç”¨æ¨¡æ¿æ–¹æ³•æ¨¡å¼ï¼Œå¯¹å¯å¤ç”¨çš„ä¸šåŠ¡é€»è¾‘è¿›è¡ŒæŠ½ç¦»ï¼Œå°è£…æˆä¸€ä¸ªéª¨æ¶ã€‚

ValidateCodeProcessor.class

```java
/**
 * æ ¡éªŒç å¤„ç†å™¨ å°è£…ä¸åŒéªŒè¯ç çš„å¤„ç†é€»è¾‘
 *
 * @author å°å¥‡
 * @date 2020/09/26
 */
public interface ValidateCodeProcessor {


    /**
     * åˆ›å»ºéªŒè¯ç 
     * 1.ç”ŸæˆéªŒè¯ç   2.å­˜å‚¨  3.å‘é€
     *
     * @param res httpè¯·æ±‚çš„requestå’Œresponseå°è£…
     * @throws Exception
     */
    void create(ServletWebRequest res) throws Exception;


    /**
     * æ ¡éªŒéªŒè¯ç 
     *
     * @param res
     */
    void validate(ServletWebRequest res);
}
```

```ValidateCodeProcessor``` æ¥å£å®šä¹‰äº†2ä¸ªæ–¹æ³•ï¼š```create()``` æ–¹æ³•ï¼Œç”¨äºéªŒè¯ç çš„ç”Ÿæˆï¼Œ ```validate()``` æ–¹æ³•ç”¨äºéªŒè¯ç çš„æ ¡éªŒã€‚

AbstractValidateCodeProcessor.class

```java
/**
 * æŠ½è±¡æ–¹æ³•æ¨¡å¼â€”â€”ç®—æ³•éª¨æ¶
 * å¯¹éªŒè¯ç çš„ä¸€äº›å…¬æœ‰çš„ä¸šåŠ¡é€»è¾‘è¿›è¡ŒæŠ½ç¦»ï¼Œåšåˆ°å¤ç”¨
 *
 * @author å°å¥‡
 * @date 2020/09/26
 **/
@Slf4j
public abstract class AbstractValidateCodeProcessor<C extends ValidateCode> implements ValidateCodeProcessor {


    /**
     * æ”¶é›†ç³»ç»Ÿä¸­æ‰€æœ‰çš„ {@link ValidateCodeGenerator} æ¥å£çš„å®ç°ã€‚
     */
    @Autowired
    private Map<String, ValidateCodeGenerator> validateCodeGeneratorMap;

    /**
     * éªŒè¯ç çš„å­˜å‚¨ä»‹è´¨
     */
    @Autowired
    private ValidateCodeRepository validateCodeRepository;


    private static final String SMS = "sms", IMAGE = "image";

    @Override
    public void create(ServletWebRequest res) throws Exception {
        // ç”Ÿæˆ
        C validateCode = generate(res);

        // å­˜å‚¨

        save(res, validateCode);

        // å‘é€ ï¼ˆæŠ½è±¡æ–¹æ³• ç”±å…·ä½“çš„å­ç±»å®ç°å„è‡ªçš„å‘é€é€»è¾‘ï¼‰
        send(res, validateCode);
    }

    @Override
    public void validate(ServletWebRequest res) {

        // æ ¹æ®è¯·æ±‚è·å–éªŒè¯ç çš„ç±»å‹ï¼Œå¹¶ä¸”ä»repositoryå­˜å‚¨å±‚ä¸­å¯»æ‰¾åŒ¹é…çš„éªŒè¯ç 
        ValidateCodeEnum codeEnum = getValidateCodeType(res);
        Optional<ValidateCode> codeOpt = validateCodeRepository.get(res, codeEnum);
        ValidateCode valCodeInStorage = codeOpt.orElseThrow(() -> new ValidateCodeException("éªŒè¯ç ä¸å­˜åœ¨"));

        // ä»è¯·æ±‚ä¸­è·å–éªŒè¯ç 
        String codeInRequest;
        try {
            codeInRequest = ServletRequestUtils.getStringParameter(res.getRequest(),
                    codeEnum.getType());
        } catch (ServletRequestBindingException e) {
            throw new ValidateCodeException("è·å–è¯·æ±‚éªŒè¯ç çš„å€¼å¤±è´¥");
        }

        if (StringUtils.isBlank(codeInRequest)) {
            throw new ValidateCodeException(codeEnum + "è¯·æ±‚éªŒè¯ç çš„å€¼ä¸èƒ½ä¸ºç©º");
        }

        // å¯¹çŸ­ä¿¡éªŒè¯ç åšä¸€ä¸ªæ˜¯å¦è¿‡æœŸçš„åˆ¤æ–­
        if (ValidateCodeEnum.SMS.equals(codeEnum) && valCodeInStorage.checkExpired()) {
            validateCodeRepository.remove(res, codeEnum);
            throw new ValidateCodeException(codeEnum + "éªŒè¯ç å·²è¿‡æœŸ");
        }

        // éªŒè¯ç æ ¡éªŒ
        if (!StringUtils.equals(valCodeInStorage.getCode(), codeInRequest)) {
            throw new ValidateCodeException(codeEnum + "éªŒè¯ç ä¸åŒ¹é…");
        }

        log.info("éªŒè¯ç æ ¡éªŒæˆåŠŸ");
        validateCodeRepository.remove(res, codeEnum);
    }


    /**
     * ç”ŸæˆéªŒè¯ç 
     *
     * @param res
     * @return C éªŒè¯ç æ³›å‹
     */
    @SuppressWarnings("unchecked")
    private C generate(ServletWebRequest res) {
        // æ ¹æ®ä¼ å…¥çš„resæ¥åšç±»å‹åˆ¤æ–­
        String type = getValidateCodeType(res).getType();
        // è·å–å…·ä½“çš„Generatorçš„åå­—
        String generatorName = type.concat(ValidateCodeGenerator.class.getSimpleName());
        ValidateCodeGenerator codeGenerator = Optional.ofNullable(validateCodeGeneratorMap.get(generatorName))
                .orElseThrow(() -> new ValidateCodeException("éªŒè¯ç ç”Ÿæˆå™¨ï¼š" + generatorName + "ä¸å­˜åœ¨"));

        return (C) codeGenerator.generate(res);

    }

    /**
     * å­˜å‚¨çŸ­ä¿¡éªŒè¯ç 
     * å¯å¤ç”¨---æŠ½è±¡ç±»ä¸­å®šä¹‰
     *
     * @param res
     * @param validateCode
     */
    private void save(ServletWebRequest res, C validateCode) {
        ValidateCode code = new ValidateCode(validateCode.getCode(), validateCode.getExpireTime());
        validateCodeRepository.save(res, code, getValidateCodeType(res));

    }

    /**
     * éªŒè¯ç çš„å‘é€
     * å›¾å½¢éªŒè¯ç å’ŒçŸ­çº¿éªŒè¯ç çš„å‘é€é€»è¾‘ä¸ä¸€æ ·ï¼Œå› æ­¤è®¾è®¡ä¸ºæŠ½è±¡æ–¹æ³•ï¼Œç”±å…·ä½“çš„å­ç±»å®ç°å„è‡ªçš„å‘é€é€»è¾‘
     *
     * @param res
     * @param validateCode
     * @throws ServletRequestBindingException
     * @throws IOException
     */
    protected abstract void send(ServletWebRequest res, C validateCode) throws ServletRequestBindingException, IOException;



    /**
     * æ ¹æ®è¯·æ±‚çš„urlè·å–æ ¡éªŒç çš„ç±»å‹
     *
     * @param res
     * @return ValidateCodeType
     */
    private ValidateCodeEnum getValidateCodeType(ServletWebRequest res) {
        String uri = res.getRequest().getRequestURI();
        if (StringUtils.contains(uri, SMS)) {
            return ValidateCodeEnum.SMS;
        }
        return ValidateCodeEnum.IMAGE;
    }
}
```

```AbstractValidateCodeProcessor``` æŠ½è±¡ç±»å®ç° ```ValidateCodeProcessor``` æ¥å£ï¼Œä¸»è¦åŠŸèƒ½æ˜¯å¯¹éªŒè¯ç ç›¸å…³çš„å…±æœ‰é€»è¾‘è¿›è¡Œä¸€ä¸ªæŠ½ç¦»ï¼Œè¾¾åˆ°åŠŸèƒ½çš„å¤ç”¨ã€‚  

- ```create```æµç¨‹å¯ä»¥ç»†åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼šç”Ÿæˆã€å­˜å‚¨ã€å‘é€ã€‚  

- ```validate```æ˜¯åšéªŒè¯ç çš„æ ¡éªŒï¼Œæ— è®ºæ˜¯å›¾å½¢éªŒè¯ç orçŸ­ä¿¡éªŒè¯ç ï¼›éªŒè¯çš„é€»è¾‘æ˜¯ä¸€è‡´çš„ã€‚  

ç±»ä¸­æœ‰2ä¸ªæˆå‘˜å˜é‡ï¼š

- ```private Map<String, ValidateCodeGenerator> validateCodeGeneratorMap``` éªŒè¯ç ç”Ÿæˆå™¨ï¼Œä¸åŒçš„éªŒè¯ç ç”Ÿæˆé€»è¾‘ä¸åŒï¼Œå› æ­¤ç”Ÿæˆæ¨¡å—æŠ½ç¦»å‡ºå»ç”±å¤–éƒ¨å®ç°ã€‚
éœ€è¦æåˆ°çš„æ˜¯:è¿™é‡Œä½¿ç”¨åˆ°```Spring``` çš„ ```å®šå‘æŸ¥æ‰¾``` æŠ€å·§è¿›è¡Œæ³¨å…¥ï¼Œ```Spring``` å¯åŠ¨æ—¶ï¼Œä¼šæŸ¥æ‰¾å®¹å™¨ä¸­æ‰€æœ‰ ```ValidateCodeGenerator```æ¥å£çš„å®ç°ï¼Œå¹¶æŠŠ```Bean```çš„åå­—ä½œä¸º ```Key```,å®ä½“ä½œä¸º```Value```æ”¾åˆ° ```Map```ä¸­ã€‚

- ```private ValidateCodeRepository validateCodeRepository``` éªŒè¯ç å­˜å‚¨å±‚ï¼Œç”Ÿæˆçš„éªŒè¯ç codeå€¼éœ€è¦å­˜å‚¨åˆ°æŸä¸ªå­˜å‚¨ä»‹è´¨ä¸­ï¼Œç”¨ä»¥åç»­æ ¡éªŒçš„æ—¶å€™å–å¾—ï¼ˆæˆ‘è¿™é‡Œä½¿ç”¨çš„æ˜¯Redisä½œä¸ºå­˜å‚¨ä»‹è´¨ï¼‰ã€‚

### éªŒè¯ç ç”Ÿå‘½å‘¨æœŸ

éªŒè¯ç çš„ç”Ÿå‘½å‘¨æœŸå¯ç®€å•çš„åˆ’åˆ†ä¸ºï¼šç”Ÿæˆã€å­˜å‚¨ã€å‘é€ã€‚

#### ç”ŸæˆéªŒè¯ç 

ç”Ÿæˆå’Œå‘é€æ¨¡å—ä¹Ÿç›¸å¯¹ç®€å•ï¼Œå°±æ˜¯å®šä¹‰äº†éªŒè¯ç çš„å…·ä½“ç”Ÿæˆå™¨ä»¥åŠå‘é€å™¨ã€‚

ValidateCodeGenerator.class

```java
/**
 * éªŒè¯ç ç”Ÿæˆå™¨
 *
 * @author å°å¥‡
 * @date 2020/09/26
 */
public interface ValidateCodeGenerator {


    /**
     * ç”ŸæˆéªŒè¯ç 
     *
     * @param res httpè¯·æ±‚ä¸­çš„requestå’Œresponse
     * @return ValidateCode
     */
    ValidateCode generate(ServletWebRequest res);

}
```

```ValidateCodeGenerator```æ¥å£å®šä¹‰äº†éªŒè¯ç ç”Ÿæˆæ–¹æ³•```generate()```ï¼Œå…·ä½“çš„ç”Ÿæˆé€»è¾‘ç”±å¯¹åº”çš„å­ç±»```SmsValidatecodeGenerator```å’Œ```ImageValidateCodeGenerator```å®ç°ã€‚

SmsValidateCodeGenerator.class

```java
/**
 * çŸ­ä¿¡éªŒè¯ç ç”Ÿæˆå™¨
 *
 * @author å°å¥‡
 * @date 2020/09/26
 **/
public class SmsValidateCodeGenerator implements ValidateCodeGenerator {



    private final SecurityProperties securityProperties;

    public SmsValidateCodeGenerator(SecurityProperties securityProperties) {
        this.securityProperties = securityProperties;
    }


    /**
     * çŸ­ä¿¡éªŒè¯ç ç”Ÿæˆé€»è¾‘
     *
     * @param res
     * @return ValidateCode
     */
    @Override
    public ValidateCode generate(ServletWebRequest res) {
        //éšæœºç”ŸæˆæŒ‡å®šé•¿åº¦çš„çŸ­ä¿¡éªŒè¯ç 
        String code = RandomStringUtils.randomNumeric(securityProperties.getCode().getSms().getLength());
        return new ValidateCode(code, securityProperties.getCode().getSms().getExpireIn());
    }
}
```

çŸ­ä¿¡éªŒè¯ç çš„ç”Ÿæˆé€»è¾‘ï¼Œä»£ç ç›¸å¯¹ç®€å•ï¼Œå½“ç„¶å¯ä»¥å®šä¹‰è‡ªå·±çš„ç”Ÿæˆé€»è¾‘ï¼Œåæ­£å°±æ˜¯éšä½ å¼€å¿ƒå°±è¡Œæ‹‰ï¼

ImageValidateCodeGenerator.class

```java
/**
 * å›¾å½¢éªŒè¯ç ç”Ÿæˆå™¨
 *
 * @author å°å¥‡
 * @date 2020/09/26
 **/
public class ImageValidateCodeGenerator implements ValidateCodeGenerator {


    private final SecurityProperties securityProperties;

    public ImageValidateCodeGenerator(SecurityProperties securityProperties) {
        this.securityProperties = securityProperties;
    }

    /**
     * å›¾å½¢éªŒè¯ç ç”Ÿæˆé€»è¾‘
     * todo è¿™é‡Œçš„ç”Ÿæˆé€»è¾‘å¯ç¨å¾®ä¼˜åŒ–ä¸€ä¸‹æˆutils
     *
     * @param res
     * @return ValidateCode
     */
    @Override
    public ValidateCode generate(ServletWebRequest res) {
        // è¿™é‡Œæ˜¯å®ç°äº†éªŒè¯ç å‚æ•°çš„ä¸‰çº§å¯é…ï¼šè¯·æ±‚çº§>åº”ç”¨çº§>é»˜è®¤é…ç½® ä»è¯·æ±‚ä¸­è·å–width å¦‚æœæ²¡æœ‰åˆ™ä» securityPropertiesçš„é…ç½®ä¸­è·å–
        int width = ServletRequestUtils.getIntParameter(res.getRequest(), "width",
                securityProperties.getCode().getImage().getWidth());
        int height = ServletRequestUtils.getIntParameter(res.getRequest(), "height",
                securityProperties.getCode().getImage().getHeight());
        BufferedImage image = new BufferedImage(width, height, BufferedImage.TYPE_INT_RGB);

        Graphics g = image.getGraphics();

        Random random = new Random();

        g.setColor(getRandColor(200, 250));
        g.fillRect(0, 0, width, height);
        g.setFont(new Font("Times New Roman", Font.ITALIC, 20));
        g.setColor(getRandColor(160, 200));
        for (int i = 0; i < 155; i++) {
            int x = random.nextInt(width);
            int y = random.nextInt(height);
            int xl = random.nextInt(12);
            int yl = random.nextInt(12);
            g.drawLine(x, y, x + xl, y + yl);
        }

        String sRand = "";
        for (int i = 0; i < securityProperties.getCode().getImage().getLength(); i++) {
            String rand = String.valueOf(random.nextInt(10));
            sRand += rand;
            g.setColor(new Color(20 + random.nextInt(110), 20 + random.nextInt(110), 20 + random.nextInt(110)));
            g.drawString(rand, 13 * i + 6, 16);
        }

        g.dispose();

        return new ImageValidateCode(image, sRand, securityProperties.getCode().getImage().getExpireIn());

    }


    /**
     * ç”ŸæˆéšæœºèƒŒæ™¯æ¡çº¹
     *
     * @param fc
     * @param bc
     * @return Color
     */
    private Color getRandColor(int fc, int bc) {
        Random random = new Random();
        if (fc > 255) {
            fc = 255;
        }
        if (bc > 255) {
            bc = 255;
        }
        int r = fc + random.nextInt(bc - fc);
        int g = fc + random.nextInt(bc - fc);
        int b = fc + random.nextInt(bc - fc);
        return new Color(r, g, b);
    }

}
```

```ImageValidateCodeGenerator```ä¸ºå›¾å½¢éªŒè¯ç ç”Ÿæˆå™¨ï¼Œç›¸å¯¹ç®€å•ï¼›å½“ç„¶é‡Œé¢æœ‰äº›ç±»utilçš„ä»£ç å¯ä»¥æ›´å¥½çš„å°è£…ï¼Œè¿™é‡Œå°±ä¸é¢å¤–å°è£…äº†ã€‚  

#### å­˜å‚¨éªŒè¯ç 

éªŒè¯ç ç”Ÿæˆä¹‹ååç«¯æœåŠ¡éœ€è¦è¿›è¡Œå­˜å‚¨ï¼Œæ–¹ä¾¿åç»­æ ¡éªŒçš„æ—¶å€™å–å¾—ï¼Œç›¸å¯¹æ¯”è¾ƒç®€å•ï¼Œæˆ‘è¿™é‡Œä½¿ç”¨çš„æ˜¯Redisæ¥å­˜å‚¨ã€‚

ValidateCodeRepository.class

```java
/**
 * éªŒè¯ç å­˜å–å™¨ æ¥å£
 *
 * @author å°å¥‡
 * @date 2020/09/26
 */
public interface ValidateCodeRepository {


    /**
     * ä¿å­˜éªŒè¯ç 
     *
     * @param res è¯·æ±‚HttpRequest å’ŒHttpResponseçš„å°è£…
     * @param code éªŒè¯ç 
     * @param validateCodeType éªŒè¯ç ç±»å‹
     */
    void save(ServletWebRequest res, ValidateCode code, ValidateCodeEnum validateCodeType);

    /**
     * è·å–éªŒè¯ç 
     *
     * @param res
     * @param validateCodeType
     * @return Optional<ValidateCode>
     */
    Optional<ValidateCode> get(ServletWebRequest res, ValidateCodeEnum validateCodeType);

    /**
     * ç§»é™¤éªŒè¯ç 
     *
     * @param request
     * @param codeType
     */
    void remove(ServletWebRequest request, ValidateCodeEnum codeType);

}
```

```ValidateCodeRepository``` æ¥å£ä¸»è¦å®šä¹‰äº†ä¸‰ä¸ªæ–¹æ³•```save```ä¿å­˜éªŒè¯ç ï¼Œ ```get```è·å–éªŒè¯ç ï¼Œ ```remove```ç§»é™¤éªŒè¯ç 

RedisValidateCodeRepository.class

```java
/**
 * åŸºäºredisçš„éªŒè¯ç å­˜å–å™¨
 *
 * @author å°å¥‡
 */
@Slf4j
@Component
public class RedisValidateCodeRepository implements ValidateCodeRepository {

    @Autowired
    private RedisTemplate<Object, Object> redisTemplate;


    /**
     * è®¾å¤‡id
     */
    private static final String DEVICE_ID = "deviceId";



    @Override
    public void save(ServletWebRequest res, ValidateCode code, ValidateCodeEnum codeEnum) {
        redisTemplate.opsForValue().set(buildKey(res, codeEnum), code, 30, TimeUnit.MINUTES);
    }



    @Override
    public Optional<ValidateCode> get(ServletWebRequest request, ValidateCodeEnum codeEnum) {
        Object value = redisTemplate.opsForValue().get(buildKey(request, codeEnum));
        if (value == null) {
            log.warn("ä¸å­˜åœ¨å¯¹åº”çš„éªŒè¯ç ");
            return Optional.empty();
        }
        return Optional.of((ValidateCode) value);
    }


    @Override
    public void remove(ServletWebRequest request, ValidateCodeEnum codeEnum) {
        redisTemplate.delete(buildKey(request, codeEnum));
    }


    /**
     * æ ¹æ®è¯·æ±‚çš„è®¾å¤‡ç”ŸæˆéªŒè¯ç çš„keyï¼Œå¦‚æœåŒä¸€ä¸ªè®¾å¤‡å¤šæ¬¡è¯·æ±‚ åˆ™å…ˆå‰çš„éªŒè¯ç åˆ™è¢«è¦†ç›–æ— æ•ˆ
     *
     * @param res
     * @param codeEnum
     * @return String rediså­˜å‚¨çš„key
     */
    private String buildKey(ServletWebRequest res, ValidateCodeEnum codeEnum) {
        String deviceId = res.getHeader(DEVICE_ID);
        if (StringUtils.isBlank(deviceId)) {
            throw new ValidateCodeException("è¯·åœ¨è¯·æ±‚å¤´ä¸­æºå¸¦deviceIdå‚æ•°");
        }
        String codeKey = SecurityConstant.DEFAULT_PARAMETER_NAME_CODE.concat(codeEnum.getType().toLowerCase())
                .concat(CommonConstant.COLON).concat(deviceId);
        log.info("æœ¬æ¬¡è¯·æ±‚ç”Ÿæˆçš„codeKey:{}", codeKey);
        return codeKey;
    }

}
```

```RedisValidateCodeRepository``` ç±»æ˜¯æ¥å£çš„å…·ä½“å®ç°ï¼Œä½¿ç”¨```Redis``` ä½œä¸ºå­˜å‚¨åª’ä»‹ï¼Œä»£ç ç›¸å¯¹æ¯”è¾ƒç®€å•ï¼Œä¸åšè¿‡å¤šçš„èµ˜è¿°ã€‚

#### å‘é€éªŒè¯ç 

éªŒè¯ç ç»è¿‡ç”Ÿæˆï¼Œåç«¯å­˜å‚¨åï¼Œå°±è¦è¿›å…¥æœ€åä¸€æ­¥ï¼šå‘é€ã€‚

ValidareCodeSender.class

```java
/**
 * çŸ­ä¿¡éªŒè¯ç å‘é€å™¨
 *
 * @author å°å¥‡
 * @date 2020/09/26
 */
public interface SmsCodeSender {


    /**
     * å‘é€çŸ­çº¿éªŒè¯ç 
     *
     * @param code
     * @param mobile
     */
    void send(String code, String mobile);
}

```

DefaultSmsCodeSender.class

```java
/**
 * é»˜è®¤çš„çŸ­ä¿¡éªŒè¯ç çš„å‘é€å™¨
 * @author å°å¥‡
 * @date 2020/6/16
 **/
@Slf4j
public class DefaultSmsCodeSender implements SmsCodeSender {


    @Override
    public void send(String code, String mobile) {
        // è¿™é‡Œåšç®€å•çš„è¾“å‡ºå³å¯
        log.info("å‘æ‰‹æœºå·" + mobile + "å‘é€çŸ­ä¿¡éªŒè¯ç " + code);
    }
}
```

çœŸå®çš„ç”Ÿäº§ä¸­å‘é€éªŒè¯ç éœ€è¦ä½¿ç”¨ç¬¬ä¸‰æ–¹çš„çŸ­ä¿¡æœåŠ¡ï¼Œç”±äºè¿™é‡Œæ˜¯å­¦ä¹ è®°å½•ï¼Œå°±ç®€å•çš„logä¸€ä¸‹è®°å½•å‘é€ã€‚

### å›¾å½¢éªŒè¯ç 

å›¾å½¢éªŒè¯ç ç»§æ‰¿äºéªŒè¯ç éª¨æ¶ï¼Œå®ç°å›¾å½¢éªŒè¯ç æœ‰å…³çš„è‡ªå®šä¹‰é€»è¾‘ï¼Œè¯¸å¦‚ï¼šç”Ÿæˆã€å‘é€ã€‚

ImageValidateCodeProcessor.class

```java
/**
 * æ¨¡æ¿æ–¹æ³•æœ€åº•å±‚ --- åŸºäºå„è‡ªçš„ç‰¹å®šå®ç°å„è‡ªçš„å‘é€è¡Œä¸º
 *
 * @author å°å¥‡
 * @date 2020/09/26
 **/
@Component("imageValidateCodeProcessor")
public class ImageValidateCodeProcessor extends AbstractValidateCodeProcessor<ImageValidateCode> {


    private static final String JPEG = "JPEG";

    @Override
    protected void send(ServletWebRequest res, ImageValidateCode validateCode) throws IOException {
        if (Objects.nonNull(res.getResponse())) {
            ImageIO.write(validateCode.getBufferedImage(), JPEG, res.getResponse().getOutputStream());
        }
    }
}
```

```ImageValidateCodeProcessor```ç±»ä¸»è¦è‡ªå®šä¹‰å›¾å½¢éªŒè¯ç çš„å‘é€é€»è¾‘ï¼Œç”Ÿæˆçš„é€»è¾‘å·²ç»å°è£…åœ¨```ImageValidateCodeGenerator```ç±»ï¼Œç”±ä¾èµ–æŸ¥æ‰¾çš„æ–¹å¼æ³¨å…¥åˆ°éªŒè¯ç éª¨æ¶ä¸­äº†ã€‚

### çŸ­ä¿¡éªŒè¯ç 

çŸ­ä¿¡éªŒè¯ç ç»§æ‰¿äºéªŒè¯ç éª¨æ¶ï¼Œå®ç°çŸ­ä¿¡éªŒè¯ç æœ‰å…³çš„è‡ªå®šä¹‰é€»è¾‘ï¼Œè¯¸å¦‚ï¼šç”Ÿæˆã€å‘é€ã€‚

SmsValidateCodeProcessor.class

```java

/**
 * çŸ­ä¿¡éªŒè¯ç çš„å¤„ç†å™¨
 * æ¨¡æ¿æ–¹æ³•æœ€åº•å±‚ --- åŸºäºå„è‡ªçš„ç‰¹å®šå®ç°å„è‡ªçš„å‘é€è¡Œä¸º
 *
 * @author å°å¥‡
 * @date 2020/6/16
 **/
@Component("smsValidateCodeProcessor")
public class SmsValidateCodeProcessor extends AbstractValidateCodeProcessor<ValidateCode> {

    @Autowired
    private SmsCodeSender smsCodeSender;

    private static final String MOBILE = "mobile";

    @Override
    protected void send(ServletWebRequest res, ValidateCode validateCode) throws ServletRequestBindingException {
        smsCodeSender.send(validateCode.getCode(), ServletRequestUtils.getRequiredStringParameter(res.getRequest(), MOBILE));
    }
}
```

```SmsValidateCodeProcessor```ç±»åŒæ ·è‡ªå®šä¹‰çŸ­ä¿¡éªŒè¯ç çš„å‘é€é€»è¾‘ï¼Œç”Ÿæˆçš„é€»è¾‘å·²ç»å°è£…åœ¨```SmsValidateCodeGenerator```ç±»ï¼Œç”±ä¾èµ–æŸ¥æ‰¾çš„æ–¹å¼æ³¨å…¥åˆ°éªŒè¯ç éª¨æ¶ä¸­äº†ã€‚

## å…¶ä»–æ¨¡å—

å…¶ä»–æ¨¡å—ä¸»è¦æ˜¯ä¸€äº›é…ç½®ç±»ã€æšä¸¾ç±»ã€å¼‚å¸¸ç±»ä»¥åŠæ˜¯ä¸€äº›ç”¨ä»¥æå‡ä»£ç è´¨é‡çš„å°è£…ï¼Œéœ€è¦ç‰¹åˆ«ä»‹ç»çš„æ˜¯```ValidateCodeBeanConfig``` é…ç½®ç±»å’Œ```ValidateCodeException``` å¼‚å¸¸ç±»ã€‚

```ValidateCodeBeanConfig``` é…ç½®äº†```bean```çš„ç”Ÿæˆè§„åˆ™ï¼Œå¥‘åˆ```SpringBoot```çš„é»˜è®¤å®ç°åŸç†ï¼šç”¨æˆ·æœ‰è‡ªå®šä¹‰åˆ™ä½¿ç”¨è‡ªå®šä¹‰ï¼Œæ²¡æœ‰åˆ™ä½¿ç”¨é»˜è®¤å®ç°ã€‚

ValidateCodeBeanConfig.class

```java
/**
 * @author å°å¥‡
 * @date 2020/09/26
 **/
@Configuration
public class ValidateCodeBeanConfig {


    @Autowired
    private SecurityProperties securityProperties;

    /**
     * æ³¨å†Œå›¾å½¢éªŒè¯ç ç”Ÿæˆå™¨
     * ä½¿ç”¨conditionalOnMissingBeanæ˜¯ä¸ºäº† å¦‚æœä¸šåŠ¡æ–¹æœ‰è‡ªå·±çš„ç”Ÿæˆé€»è¾‘ åˆ™ä½¿ç”¨ä¸šåŠ¡æ–¹çš„ï¼›å¦åˆ™ä½¿ç”¨è¯¥é»˜è®¤é…ç½®
     * æ–¹æ³•åå°±æ˜¯beançš„åå­—
     *
     * @return ValidateCodeGenerator
     */
    @Bean
    @ConditionalOnMissingBean(name = "imageValidateCodeGenerator")
    public ValidateCodeGenerator imageValidateCodeGenerator() {
        return new ImageValidateCodeGenerator(securityProperties);
    }

    /**
     * çŸ­çº¿éªŒè¯ç ç”Ÿæˆå™¨
     *
     * @return ValidateCodeGenerator
     */
    @Bean
    @ConditionalOnMissingBean(name = "smsValidateCodeGenerator")
    public ValidateCodeGenerator smsValidateCodeGenerator() {
        return new SmsValidateCodeGenerator(securityProperties);
    }

    /**
     * æ‰¾åˆ°smsCodeSenderæ¥å£çš„æ‰€æœ‰å®ç°ç±»
     * é»˜è®¤å®ç°æ˜¯ç”¨æ¥è¢«è¦†ç›–çš„
     * å¦‚æœä¹‹å‰ç”¨æˆ·å·²ç»é…ç½®äº† åˆ™ä¸å†è£…è½½Defaultçš„
     */
    @Bean
    @ConditionalOnMissingBean(SmsCodeSender.class)
    public SmsCodeSender smsCodeSender() {
        return new DefaultSmsCodeSender();
    }
}

```

é…ç½®Beançš„ç”Ÿæˆè§„åˆ™ï¼Œä¾‹å¦‚ï¼š```Generator```æ¨¡å—ï¼Œç”¨æˆ·å¯é€šè¿‡å®ç°```ValidateCodeGenerator```æ¥è¾¾åˆ°è‡ªå®šä¹‰éªŒè¯ç ç”Ÿæˆï¼Œå¦åˆ™ä½¿ç”¨é»˜è®¤çš„ç”Ÿæˆå™¨ï¼Œä¹Ÿæ˜¯ä¸€ç§ç¼–ç¨‹æŠ€å·§ã€‚

```ValidateCodeException``` å¼‚å¸¸ç±»ç»§æ‰¿äº ```SpringSecurity```çš„å¼‚å¸¸åŸºç±»```AuthenticationException```ï¼Œè¿™æ˜¯å› ä¸ºæˆ‘ä»¬æ˜¯åŸºäº```SpringSecurity```åšæ‰©å±•å¼€å‘è‡ªå®šä¹‰éªŒè¯ç è®¤è¯æ¨¡å¼ã€‚

```java
/**
 * AuthenticationExceptionæ˜¯æ•´ä¸ªsecurityå¼‚å¸¸ä¸­çš„åŸºç±»
 * éªŒè¯ç å¼‚å¸¸å±äºè®¤è¯è¿‡ç¨‹ä¸­çš„ä¸€ä¸ªç‰¹ä¾‹ï¼Œå½’å±äºè¯¥åŸºç±»ä¹‹ä¸‹
 *
 * @author å°å¥‡
 * @date 2020/09/26
 **/
public class ValidateCodeException extends AuthenticationException {

    /**
     * éªŒè¯ç å¼‚å¸¸
     * @param msg
     * @return t
     */
    public ValidateCodeException(String msg, Throwable t) {
        super(msg, t);
    }

    public ValidateCodeException(String msg) {
        super(msg);
    }
}

```

å…¶ä»–çš„ä¸€äº›å¯ä»¥æ ¹æ®ç±»åå¤§è‡´çŒœå‡ºä½œç”¨çš„ç±»è¿™é‡Œå°±ä¸åšè¿‡å¤šçš„å±•ç¤ºã€‚

## æ€»ç»“

æœ¬ç¯‡æ–‡ç« ä¸»è¦ç»“åˆæ¨¡æ¿æ–¹æ³•æ¨¡å¼ä»‹ç»äº†éªŒè¯ç çš„ç”Ÿæˆï¼Œå¹¶ä¸”ä»‹ç»äº†2ä¸ªæ¯”è¾ƒå¸¸ç”¨çš„ç¼–ç¨‹æŠ€å·§ï¼š```ä¾èµ–æŸ¥æ‰¾``` å’Œ ä½¿ç”¨```ConditionalOnMissingBean``` å¥‘åˆ```SpringBoot```é»˜è®¤å®ç°æ€æƒ³ã€‚

æœ¬æ–‡ä¸ºæˆ‘åœ¨ä¹‹å‰åœ¨bç«™ä¸Šå­¦ä¹ æŸå¤§ä½¬è¯¾ç¨‹è¿‡ç¨‹ä¸­æ‰€åšçš„å­¦ä¹ ç¬”è®°ï¼Œå¯èƒ½ä¼šå‡ºç°ç†è§£ä¸Šçš„åå·®ï¼Œå¦‚æœ‰é”™è¯¯æˆ–ä¸å¦¥æŒ‡å‡ºï¼Œçƒ¦è¯·æŒ‡å‡ºï¼
