> æ–‡ç« å¯ä»¥ç™½å«–ï¼Œå…¬ä¼—å·ä¸èƒ½ä¸å…³æ³¨ï¼Œæ‰‹åŠ¨æ»‘ç¨½ğŸ¤£ğŸ¤£ &nbsp;
>
> æ¬¢è¿å¤§å®¶å…³æ³¨ï¼š**æ­¦å“¥èŠç¼–ç¨‹**ã€**Javaå¼€å‘å®å…¸**ï¼Œæ‚¨çš„æ”¯æŒï¼Œæ˜¯æˆ‘ä»¬åˆ›ä½œçš„æŒç»­åŠ¨åŠ›ï¼&nbsp;&nbsp;

![æ­¦å“¥èŠç¼–ç¨‹](https://img-blog.csdnimg.cn/202002150421550.jpg)![Javaå¼€å‘å®å…¸](https://img-blog.csdnimg.cn/20200608005630228.png)

----

## åŸç†æ¢è®¨

å½“æˆ‘ä»¬åœ¨é¡¹ç›®ä¸­å¼•å…¥ ```Spring Security``` çš„ç›¸å…³ä¾èµ–åï¼Œé»˜è®¤çš„å°±æ˜¯è¡¨å•ç™»å½•å½¢å¼ï¼›ä¿—è¯è¯´ï¼šâ€œå¬äººåŠï¼Œåƒé¥±é¥­â€ï¼Œæ—¢ç„¶ ```Spring Security``` å·²ç»ç»™æˆ‘ä»¬å®‰æ’çš„æ˜æ˜ç™½ç™½äº†ï¼Œæˆ‘ä»¬å°±ä»è¡¨å•ç™»å½•å¼€å§‹å§ã€‚

åœ¨å¼€å§‹ä¹‹å‰ï¼Œæˆ‘ä»¬å¯ä»¥ç«™åœ¨ ```Spring Security``` çš„è§’åº¦ä¸Šæ€è€ƒï¼šå¦‚æœæˆ‘è‡ªå·±æ¥å®ç°è¡¨å•ç™»å½•çš„åŠŸèƒ½ï¼Œé‚£ä¹ˆæˆ‘éœ€è¦åšå“ªäº›å·¥ä½œå‘¢ï¼Ÿ

å°±æˆ‘ä¸ªäººè€Œè¨€ï¼Œæˆ‘å¯èƒ½ä¼šè€ƒè™‘ä»¥ä¸‹å‡ ç‚¹ï¼š

- é…ç½®ç”¨æˆ·ä¿¡æ¯ï¼Œå­˜å‚¨å¦‚è´¦å·ã€å¯†ç ç­‰ï¼›å¯†ç ä¸èƒ½ä»¥æ˜æ–‡ä¼ è¾“ï¼Œéœ€è¦åŠ å¯†åŠŸèƒ½

- æ‰§è¡Œæ ¡éªŒ

- è®¤è¯æˆåŠŸæˆ–è€…å¤±è´¥çš„å¤„ç†æ–¹æ¡ˆ

å¯ä»¥ç®€å•çš„åˆ¶ä½œæˆå¦‚ä¸‹æµç¨‹å›¾ï¼š

![å›¾1-1 è¡¨å•ç™»å½•ç®€å•æµç¨‹å›¾](https://img-blog.csdnimg.cn/20200913132829115.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NjkyMDM3Ng==,size_16,color_FFFFFF,t_70#pic_center)

ä¸Šæ–¹å±äºæˆ‘ä»¬è‡ªå·±è®¾æƒ³çš„å®ç°æ–¹æ¡ˆï¼Œå±äº"ä½é…ç‰ˆ"æ¨¡å¼ï¼Œä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹ ```Spring Security``` æ˜¯æ€ä¹ˆåšçš„ã€‚ ```Spring Security```çš„æ€è·¯å’Œæˆ‘ä»¬å¤§åŒå°å¼‚ï¼Œä¼˜ç‚¹åœ¨äºå…¶æä¾›äº†å¾ˆå¥½çš„å°è£…ï¼Œæé«˜äº†æ¡†æ¶æœ¬èº«çš„å¯æ‰©å±•æ€§ã€‚

```Spring Security``` çš„å®ç°æ­¥éª¤å¦‚ä¸‹ï¼š

1. ```UsernamePasswordAuthenticationFilter```æ‹¦æˆªå™¨æ‹¦æˆªå‰ç«¯ä¼ é€’çš„è¡¨å•ç™»å½•è¯·æ±‚ï¼Œå°†ç™»å½•ä¿¡æ¯ï¼ˆ```usernameã€password```ï¼‰å°è£…æˆ ```UsernamePasswordAuthenticationToken```ï¼Œä¼ é€’ç»™ ```AuthenticationManager```è®¤è¯ç®¡ç†å™¨

2. ```AuthenticationManager```è®¤è¯ç®¡ç†å™¨æ ¹æ®```Token```çš„ç±»å‹éå†è·å–å¯¹åº”çš„```Provider```ï¼Œä¹Ÿå³æ˜¯ ```DaoAuthenticationProvider```ï¼Œæ‰§è¡Œè®¤è¯æµç¨‹

3. ```DaoAuthenticationProvider``` ä¾é  ```PasswordEncoder``` å’Œ ```UserDetailsService```å¯¹ç™»å½•è¯·æ±‚è¿›è¡ŒéªŒè¯

4. éªŒè¯é€šè¿‡ï¼Œç”±```AuthenticationSuccessHandler``` è®¤è¯æˆåŠŸå¤„ç†å™¨è¿›è¡Œå¤„ç†

5. éªŒè¯å¤±è´¥ï¼Œç”±```AuthenticationFailureHandler``` è®¤è¯å¤±è´¥å¤„ç†å™¨è¿›è¡Œå¤„ç†

åˆ¶ä½œæˆæµç¨‹å›¾å¦‚ç¤ºï¼š

![å›¾1-2 Spring Securityè¡¨å•ç™»å½•è®¤è¯æµç¨‹å›¾](https://img-blog.csdnimg.cn/20200913133846485.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NjkyMDM3Ng==,size_16,color_FFFFFF,t_70#pic_center)

è¿™æ—¶ä½ å¯èƒ½ä¼šä¸€è„¸æ‡µé€¼ï¼šè¿™å’‹å’Œåˆšåˆšæˆ‘ä»¬è‡ªå·±è®¾æƒ³çš„å®Œå…¨ä¸ä¸€æ ·å‘€~ åˆæ˜¯```Manager```åˆæ˜¯```Provider```çš„ï¼›è«æ…Œï¼Œä¸”å¬æˆ‘æ…¢æ…¢é“æ¥ã€‚

ä¸Šé¢å‡ºç°äº†å¾ˆå¤šæ–°çš„æ¦‚å¿µï¼Œæˆ‘ä»¬ç›®å‰ä¸éœ€è¦ååˆ†ç»†è‡´çš„äº†è§£å®ƒä»¬æ˜¯æ€ä¹ˆå‘æŒ¥ä½œç”¨çš„ï¼Œåªéœ€è¦å¤§æ¦‚çŸ¥é“å®ƒä»¬æœ‰ä»€ä¹ˆç”¨çš„å³å¯ï¼›å…·ä½“çš„ä»‹ç»ä¼šåœ¨ä¸‹ç¯‡ã€Šè®¤è¯ï¼ˆäºŒï¼‰ï¼šè¡¨å•ç™»å½•è®¤è¯æµç¨‹æºç è§£æã€‹å¨“å¨“é“æ¥ã€‚

- ```UsernamePasswordAuthenticationFilter``` è¡¨å•ç™»å½•æ‹¦æˆªå™¨ï¼Œç”¨ä»¥æ•è·å‰ç«¯ä¼ é€’çš„ç™»å½•ä¿¡æ¯ï¼ˆ```usernameã€password```ï¼‰ï¼Œå¹¶å°†ç™»å½•ä¿¡æ¯å°è£…æˆæŸäº›```Token```ã€‚

- ```AuthenticationManager``` è®¤è¯ç®¡ç†å™¨ï¼Œå¯ç®€å•çš„ç†è§£ä¸ºåˆ†é…å·¥ä½œçš„é¢†å¯¼ã€‚```DaoAuthenticationProvider``` DAOè®¤è¯å¤„ç†å™¨ï¼Œç›¸å½“äºè¢«å®‰æ’å¹²æ´»çš„ç«¥é‹ï¼›ä»åå­—DAOä¹Ÿå¯ä»¥ç®€å•çš„æ¨æµ‹å‡ºï¼šå®ƒä¸æ•°æ®åº“ä¸­çš„ç”¨æˆ·ä¿¡æ¯å¯†ä¸å¯åˆ†ã€‚

- ```PasswordEncoder``` å¯†ç åŠ å¯†å™¨ï¼Œå¯†ç ä¸èƒ½æ˜æ–‡ä¼ è¾“ï¼Œéœ€è¦åŠ å¯†ã€‚```UserDetailsService``` ç”¨æˆ·ä¿¡æ¯Serviceå±‚ï¼Œè¿™ä¸ªä¹Ÿå¾ˆå¥½ç†è§£ï¼Œå‰ç«¯ä¼ é€’çš„ç™»å½•ä¿¡æ¯è‚¯å®šæ˜¯æœ‰å¯¹åº”çš„æ•°æ®åº“å®ä½“å­˜å‚¨ã€‚

- ```AuthenticationSuccessHandler``` è®¤è¯æˆåŠŸå¤„ç†å™¨ ```AuthenticationFailureHandler``` è®¤è¯å¤±è´¥å¤„ç†å™¨ã€‚

ç»è¿‡ä¸Šè¿°çš„åŸç†æ¢è®¨ï¼Œæˆ‘ä»¬å¤§ä½“ä¸Šèƒ½å¼„æ‡‚äº†æ•´ä¸ªè¡¨å•ç™»å½•æœ‰å“ªå‡ ä¸ªæ¨¡å—éœ€è¦å¤„ç†ï¼›å¯ç®€å•çš„æ€»ç»“ä¸º3ä¸ªæ¨¡å—ï¼š

1. ç™»å½•å‰ç½®å¤„ç†ï¼š ç”¨æˆ·ä¿¡æ¯çš„å°è£…ã€å¯†ç åŠ å¯†å™¨çš„è®¾ç½®

2. ç™»å½•ä¸­å¤„ç†ï¼š ç™»å½•çš„æ ¡éªŒ

3. ç™»å½•åç½®å¤„ç†ï¼š ç™»å½•å¤±è´¥ã€ç™»å½•æˆåŠŸçš„å¤„ç†æ–¹æ¡ˆ

## å°è¯•ç‰›åˆ€

ä¿—è¯è¯´ï¼šâ€œå…‰è¯´ä¸ç»ƒå‡æŠŠå¼â€ï¼Œé‚£ä¹ˆå°±è®©æˆ‘ä»¬æ¥å®æˆ˜ä¸€ç•ªå§ã€‚

### ç™»å½•å‰ç½®å¤„ç†

ä½œä¸ºä¸€ä¸ªJava Webé¡¹ç›®ï¼Œç¬¬ä¸€æ­¥å½“ç„¶æ˜¯å¼•å…¥ç›¸å…³ä¾èµ–ï¼›ç›´æ¥å¼•å…¥Spring Bootå°è£…å¥½çš„starterå³å¯ã€‚

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-security</artifactId>
</dependency>
```

#### Step-1 é…ç½®ç”¨æˆ·ä¿¡æ¯

```Spring Security``` æä¾›äº†```UserDetails```æ¥å£ï¼Œç”¨äºè·å–ç”¨æˆ·çš„åŸºæœ¬ä¿¡æ¯ï¼ˆè´¦å·å¯†ç ã€æƒé™é›†åˆã€æ˜¯å¦é”å®šç­‰ç­‰ï¼‰ï¼Œæˆ‘ä»¬åªéœ€è¦æ ¹æ®è‡ªèº«çš„ä¸šåŠ¡åœºæ™¯ï¼Œå®ç°è¯¥æ¥å£å³å¯ã€‚

Spring Securityæä¾›çš„UserDetails.classæ¥å£

```java
public interface UserDetails extends Serializable {

    /**
     * ç”¨æˆ·æƒé™é›†ï¼Œé»˜è®¤éœ€è¦æ·»åŠ ROLE_ä½œä¸ºå‰ç¼€
     */
    Collection<? extends GrantedAuthority> getAuthorities();

    /**
     * è·å–ç”¨æˆ·å¯†ç 
     */
    String getPassword();

    /**
     * UserDetailsçš„æ¥å£
     * è·å–ç”¨æˆ·å
     */
    String getUsername();

     /**
     * è´¦æˆ·æ˜¯å¦æœªè¿‡æœŸ  --trueåˆ™ä¸ºæœªè¿‡æœŸ
     */
    boolean isAccountNonExpired();

    /**
     * è´¦æˆ·æ˜¯å¦æœªè¢«é”å®š
     */
    boolean isAccountNonLocked();

    /**
     * è´¦æˆ·å‡­è¯æ˜¯å¦æœªè¿‡æœŸ
     */
    boolean isCredentialsNonExpired();

    /**
     * è´¦æˆ·æ˜¯å¦å¯ç”¨
     */
    boolean isEnabled();
}
```

è‡ªå®šä¹‰ä¸šåŠ¡ç›¸å…³çš„ç”¨æˆ·ä¿¡æ¯ç±»ï¼Œä¸šåŠ¡å®šä¹‰çš„```UserInfo.class```å¿…é¡»å¸¦æœ‰```username```å’Œ```password```ç›¸å…³çš„ä¿¡æ¯ï¼Œç”¨äºåšç”¨æˆ·éªŒè¯ï¼›é¡¹ç›®æ ¹æ®è‡ªèº«éœ€æ±‚æ¥åˆ¤æ–­æ˜¯å¦éœ€è¦ä½¿ç”¨ä¸‹é¢çš„å‡ ä¸ªbooleanæ–¹æ³•ï¼Œå¦‚æœæ— ç›¸å…³éœ€æ±‚åˆ™ç›´æ¥è¿”å›```true```å³å¯ã€‚

```java
@Setter
public class UserInfo implements UserDetails {

    private String username;

    private String password;

    /**
     * UserDetailsçš„æ¥å£
     * ç”¨æˆ·æƒé™é›†ï¼Œé»˜è®¤éœ€è¦æ·»åŠ ROLE_ä½œä¸ºå‰ç¼€
     */
    @Override
    public Collection<? extends GrantedAuthority> getAuthorities() {
        List<SimpleGrantedAuthority> simpleGrantedAuthorities = new ArrayList<>(1);
        simpleGrantedAuthorities.add(new SimpleGrantedAuthority("ROLE_USER"));
        return simpleGrantedAuthorities;
    }

    /**
     * è·å–ç”¨æˆ·å¯†ç 
     */
    @Override
    public String getPassword() {
        return this.password;
    }

    /**
     * è·å–ç”¨æˆ·å
     */
    @Override
    public String getUsername() {
        return this.username;
    }

    /**
     * è´¦æˆ·æ˜¯å¦æœªè¿‡æœŸ  --trueåˆ™ä¸ºæœªè¿‡æœŸ
     */
    @Override
    public boolean isAccountNonExpired() {
        return true;
    }

    /**
     * è´¦æˆ·æ˜¯å¦æœªè¢«é”å®š
     */
    @Override
    public boolean isAccountNonLocked() {
        return true;
    }

    /**
     * è´¦æˆ·å‡­è¯æ˜¯å¦æœªè¿‡æœŸ
     */
    @Override
    public boolean isCredentialsNonExpired() {
        return true;
    }

    /**
     * è´¦æˆ·æ˜¯å¦å¯ç”¨
     */
    @Override
    public boolean isEnabled() {
        return true;
    }
}
```

åœ¨å®šä¹‰å®Œç”¨æˆ·å®ä½“```UserInfo```åï¼Œæˆ‘ä»¬åŒæ—¶ä¹Ÿéœ€è¦æä¾›å¯¹åº”çš„```Service```å±‚çš„APIæ–¹æ³•ï¼Œç”¨ä»¥è¿›è¡Œä¸€äº›åŸºæœ¬çš„æ“ä½œï¼Œè¯¸å¦‚ï¼šæ–°å¢ç”¨æˆ·ã€åˆ é™¤ç”¨æˆ·ç­‰ã€‚

```Spring Security``` ä¹Ÿæä¾›äº†å¯¹åº”çš„```Service```å±‚æ¥å£ï¼Œ```UserDetailsService```ï¼Œæ¥å£åªæœ‰ä¸€ä¸ªæ–¹æ³•ï¼š ```UserDetails loadUserByUsername(String username)```ï¼›æ ¹æ®ç”¨æˆ·ååŠ è½½ç”¨æˆ·ä¿¡æ¯.

UserDetailsService.class

```java
public interface UserDetailsService {
    UserDetails loadUserByUsername(String username) throws UsernameNotFoundException;
}
```

å› æ­¤æˆ‘ä»¬å¯ä»¥è‡ªå®šä¹‰ä¸šåŠ¡ç›¸å…³çš„```UserInfoServiceImpl```ç±»ï¼Œå®ç°```Spring Security```æä¾›çš„ ```UserDetailsService```æ¥å£

UserInfoServiceImpl.class

```java
/**
 * ç”¨æˆ·ä¿¡æ¯serviceæ¨¡å—
 *
 * UserDetailsServiceæ¥å£ä¸ºSpringSecurityå†…ç½®æ¥å£ï¼Œå†…éƒ¨æœ‰æ–¹æ³•ï¼š
 * UserDetails loadUserByUsername(String username):å¦‚åæ‰€å¾— æ ¹æ®ç”¨æˆ·ååŠ è½½ç”¨æˆ·
 * è¯¥æ–¹æ³•ä¸»è¦æ˜¯åœ¨ï¼šDaoAuthenticationProviderä¸­è¢«è°ƒç”¨ï¼Œè·å–ç”¨æˆ·çš„ä¿¡æ¯
 *
 * @author å°å¥‡
 */
@Slf4j
@Service
public class UserInfoServiceImpl implements UserDetailsService, UserInfoService {

    private final UserInfoDAO userInfoDAO;

    @Autowired
    public UserInfoServiceImpl(UserInfoDAO userInfoDAO) {
        this.userInfoDAO = userInfoDAO;
    }

    @Override
    public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException {
        Optional<UserInfo> userInfoOpt = Optional.ofNullable(userInfoDAO.loadUserByUsername(username));
        UserInfo user = userInfoOpt.orElseThrow(() -> new UsernameNotFoundException("can't not load user by username"));
        log.info("æ ¹æ®ç”¨æˆ·å:{}æŸ¥è¯¢ç”¨æˆ·æˆåŠŸ", user.getUsername());
        return user;
    }
}
```

#### Step-2 é…ç½®å¯†ç åŠ å¯†å™¨

ä¼—æ‰€å‘¨çŸ¥ï¼Œå¯†ç æ˜¯ä¸èƒ½ä»¥æ˜æ–‡çš„æ–¹å¼å­˜å‚¨çš„ï¼Œè´´å¿ƒçš„```Spring Security```è‡ªç„¶ä¸ä¼šå¿˜è®°æä¾›åŠ å¯†çš„åŠŸèƒ½ã€‚```PasswordEncoder```æ¥å£ï¼Œä¸»è¦æä¾›2ä¸ªæ–¹æ³•ï¼›```String encode(CharSequence rawPassword)```æ–¹æ³•ç”¨äºåŠ å¯†ï¼Œç”±æˆ‘ä»¬åœ¨æ³¨å†Œç”¨æˆ·çš„æ—¶å€™è°ƒç”¨ï¼›
```boolean matches(CharSequence rawPassword, String encodedPassword)``` æ–¹æ³•ç”¨äºåŒ¹é…ï¼Œç™»å½•éªŒè¯æ—¶ç”±```Spring Security```æ¡†æ¶è°ƒç”¨ã€‚

PasswordEncoder.class

```java
public interface PasswordEncoder {

    /**
     * åŠ å¯†ï¼Œæ³¨å†Œç”¨æˆ·æˆ–è€…ä¿®æ”¹å¯†ç çš„æ—¶å€™è°ƒç”¨
     */
    String encode(CharSequence rawPassword);

     /**
     * åŒ¹é…ï¼Œç™»å½•éªŒè¯æ—¶ï¼Œsecurityæ¡†æ¶è°ƒç”¨
     */
    boolean matches(CharSequence rawPassword, String encodedPassword);

    default boolean upgradeEncoding(String encodedPassword) {
        return false;
    }
}
```

å¦‚æœé¡¹ç›®æœ‰è‡ªå·±çš„åŠ è§£å¯†æ–¹å¼ï¼Œåªéœ€è¦å®ç°è¯¥æ¥å£å³å¯ï¼Œå¦‚æœæ²¡æœ‰å¯ä»¥å°è¯•ä½¿ç”¨```Spring```æä¾›çš„```BCryptPasswordEncoder```å¯†ç åŠ å¯†å™¨ã€‚

### ç™»å½•ä¸­å¤„ç†

åœ¨è¿™ä¸€å—ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥è‡ªå®šä¹‰ä¸è‡ªèº«ä¸šåŠ¡æœ‰å…³çš„ç™»å½•é€»è¾‘åˆ¤æ–­ï¼Œç›®å‰æ²¡æœ‰è¿™ç§éœ€æ±‚å°±ä½¿ç”¨```Spring Security```æä¾›çš„é»˜è®¤å®ç°å³å¯ã€‚

### ç™»å½•åç½®å¤„ç†

ç™»å½•çš„åç½®å¤„ç†åˆ†ä¸¤ç§æƒ…å†µï¼Œç¬¬ä¸€ç§æ˜¯ç™»å½•æˆåŠŸçš„å¤„ç†ï¼Œä¸€ç§æ˜¯ç™»å½•å¤±è´¥çš„å¤„ç†ã€‚

#### Step-03 é…ç½®ç™»å½•æˆåŠŸå¤„ç†å™¨

```Spring Security```æä¾›äº†è®¤è¯æˆåŠŸå¤„ç†å™¨æ¥å£```AuthenticationSuccessHandler```ï¼Œå½“æˆ‘ä»¬æœ‰ä¸€äº›è‡ªå®šä¹‰çš„ä¸šåŠ¡é€»è¾‘ï¼Œè¯¸å¦‚ï¼šç”¨æˆ·ç™»å½•æˆåŠŸåèµ é€ç§¯åˆ†ï¼Œæˆ–è€…ç™»å½•æˆåŠŸåè‡ªåŠ¨è·³è½¬â€¦â€¦å°±å¯ä»¥é€šè¿‡æä¾›è¯¥æ¥å£çš„è‡ªå®šä¹‰å®ç°ã€‚

AuthenticationSuccessHandler.class

```java
public interface AuthenticationSuccessHandler {

     /**
      * é»˜è®¤æ–¹æ³•
     */
    default void onAuthenticationSuccess(HttpServletRequest request,HttpServletResponse response, FilterChain chain, Authentication authentication)
        throws IOException, ServletException{
            onAuthenticationSuccess(request, response, authentication);
            chain.doFilter(request, response);
    }

    /**
    * æˆåŠŸåä¼šè¢«è°ƒç”¨
     */
    void onAuthenticationSuccess(HttpServletRequest request,HttpServletResponse response, Authentication authentication)
        throws IOException, ServletException;
}
```

è‡ªå®šä¹‰æˆåŠŸå¤„ç†å™¨ WebAuthenticationSuccessHandler.class

```java
/**
 * è‡ªå®šä¹‰éªŒè¯æˆåŠŸå¤„ç†å™¨
 * @author å°å¥‡
 */
@Slf4j
@Component
public class WebAuthenticationSuccessHandler implements AuthenticationSuccessHandler {

    @Autowired
    private ObjectMapper objectMapper;

    @Override
    public void onAuthenticationSuccess(HttpServletRequest request, HttpServletResponse response, Authentication authentication)
            throws IOException, ServletException {
        log.info("ç™»å½•æˆåŠŸ~~");
        // è¿”å›json å¯æ·»åŠ è‡ªèº«ä¸šåŠ¡é€»è¾‘  å¦‚ï¼šç™»å½•æˆåŠŸåæ·»åŠ ç”¨æˆ·ç§¯åˆ†ç­‰â€¦â€¦
        response.setContentType("application/json;charset=UTF-8");
        response.getWriter().write(objectMapper.writeValueAsString(authentication));
    }
}
```

#### Step-04 é…ç½®ç™»å½•å¤±è´¥å¤„ç†å™¨

```AuthenticationFailureHandler```å¤±è´¥å¤„ç†å™¨å’ŒæˆåŠŸå¤„ç†å™¨ç±»ä¼¼ï¼Œä¸åšè¿‡å¤šçš„è§£æï¼Œä¸Šä»£ç ã€‚

```java
public interface AuthenticationFailureHandler {

    /**
     * å¤±è´¥åè°ƒç”¨
     */
    void onAuthenticationFailure(HttpServletRequest request,HttpServletResponse response, AuthenticationException exception)
        throws IOException, ServletException;
}
```

è‡ªå®šä¹‰å¤±è´¥å¤„ç†å™¨WebAuthenticationFailureHandler.class

```java
/**
 * è‡ªå®šä¹‰éªŒè¯å¤±è´¥å¤„ç†å™¨
 * @author å°å¥‡
 */
@Slf4j
@Component
public class WebAuthenticationFailureHandler implements AuthenticationFailureHandler {

    @Autowired
    private ObjectMapper objectMapper;

    @Override
    public void onAuthenticationFailure(HttpServletRequest request, HttpServletResponse response, AuthenticationException exception)
            throws IOException, ServletException {
        log.error("ç™»å½•å¤±è´¥");
        // æŠŠexceptionè¿”å›ç»™å‰å°
        response.setStatus(HttpStatus.INTERNAL_SERVER_ERROR.value());
        response.setContentType("application/json;charset=UTF-8");
        response.getWriter().write(objectMapper.writeValueAsString(exception));

        // å¯åšå…¶ä»–ä¸šåŠ¡é€»è¾‘ï¼Œè¯¸å¦‚é™åˆ¶æ¯å¤©ç™»å½•å¤±è´¥çš„æ¬¡æ•°
    }
}
```

#### Step-05 é…ç½®SecurityConfig

è¿˜è®°å¾—ä¹‹å‰æˆ‘ä»¬æè¿‡çš„```Spring Security```ä¸ºäººå¹¿ä¸ºè¯Ÿç—…çš„ç¹çé…ç½®å—ï¼Ÿè‡ªä»æ­ä¸Š```Spring Boot```çš„åˆ—è½¦ä¹‹åï¼Œæœ‰äº†ç¿»å¤©è¦†åœ°çš„æ”¹å˜ã€‚

ä¸‹é¢å°±æ¥ç®€å•é…ç½®ä¸€ä¸‹æˆ‘ä»¬åœ¨ä¸Šé¢è‡ªå®šä¹‰çš„ä¸€äº›æ¨¡å—å§ã€‚

```java
/**
 * @author kylin
 */
@Configuration
@EnableWebSecurity
public class WebSecurityConfig extends WebSecurityConfigurerAdapter {


    @Autowired
    private WebAuthenticationSuccessHandler successHandler;

    @Autowired
    private WebAuthenticationFailureHandler failureHandler;


    /**
     * å¯†ç åŠ å¯†å™¨ï¼Œä½¿ç”¨springæä¾›çš„BCryptPasswordEncoder
     */
    @Bean
    public PasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder();
    }

     /**
     * httpè¯·æ±‚å®‰å…¨é…ç½®
     *
     * @param http
     */
    @Override
    protected void configure(HttpSecurity http) throws Exception {
        http
           .authorizeRequests()
                .antMatchers("/resources/**", "/css/**", "/about", "/test").permitAll()
                .anyRequest().authenticated()
                .and()
           .formLogin()
                .loginPage("/login.html")
                .successHandler(successHandler)
                .failureHandler(failureHandler)
                .permitAll()
                .and()
           .csrf().disable();
    }

}
```

æ•´ä¸ªé…ç½®å°±åŸºæœ¬å®Œæˆäº†ï¼Œä¹Ÿæ¯”è¾ƒç®€å•æ˜“æ‡‚ï¼›å¯¹ä¸€äº›é…ç½®è¿›è¡ŒåŸºç¡€çš„è®²è§£

1. ```.antMatchers("/resources/**", "/css/**", "/about", "/test").permitAll()```æ˜¯æŒ‡å¯¹äºè¿™äº›æ­£åˆ™è·¯å¾„è¿›è¡Œæ”¾è¡Œ

2. ```loginPage("/login.html")```æŒ‡çš„æ˜¯è‡ªå®šä¹‰äº†ä¸€ä¸ªå‰ç«¯çš„ç™»å½•é¡µé¢ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥ä½¿ç”¨é»˜è®¤çš„é¡µé¢ï¼ˆåªæ˜¯ç›¸å¯¹æ¯”è¾ƒç®€é™‹äº†äº›ï¼‰

3. æœ€åçš„csrfè®°å¾—å…³é—­ï¼Œè¿™ä¸€å—åé¢ä¼šä¸“é—¨ä»‹ç»ã€‚

## æ€»ç»“

ä»¥ä¸Šå†…å®¹åˆ™ä¸ºã€Šè®¤è¯ï¼ˆä¸€ï¼‰ï¼šåŸºäºè¡¨å•ç™»å½•çš„è®¤è¯æ¨¡å¼ã€‹çš„å…¨å†…å®¹ï¼Œæ–‡ç« é€šè¿‡åŸç†æ¢è®¨ã€åŠ¨æ‰‹å°è¯•é€ä¸€å±•å¼€ã€‚

æ–‡ç« å†…å®¹ä¸ºä¸ªäººå­¦ä¹ æ€»ç»“ï¼Œå¦‚æœ‰é”™è¯¯ä¹‹å¤„ï¼Œè¯·å¤šå¤šæŒ‡æ­£ã€‚

![å›¾1-3 æ€»ç»“å›¾](https://img-blog.csdnimg.cn/20200913191419506.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NjkyMDM3Ng==,size_16,color_FFFFFF,t_70#pic_center)

----

> æ–‡ç« å¯ä»¥ç™½å«–ï¼Œå…¬ä¼—å·ä¸èƒ½ä¸å…³æ³¨ï¼Œæ‰‹åŠ¨æ»‘ç¨½ğŸ¤£ğŸ¤£ &nbsp;
>
> æ¬¢è¿å¤§å®¶å…³æ³¨ï¼š**æ­¦å“¥èŠç¼–ç¨‹**ã€**Javaå¼€å‘å®å…¸**ï¼Œæ‚¨çš„æ”¯æŒï¼Œæ˜¯æˆ‘ä»¬åˆ›ä½œçš„æŒç»­åŠ¨åŠ›ï¼&nbsp;&nbsp;

![æ­¦å“¥èŠç¼–ç¨‹](https://img-blog.csdnimg.cn/202002150421550.jpg)![Javaå¼€å‘å®å…¸](https://img-blog.csdnimg.cn/20200608005630228.png)

----
