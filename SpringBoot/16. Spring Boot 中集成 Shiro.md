> æ–‡ç« å¯ä»¥ç™½å«–ï¼Œå…¬ä¼—å·ä¸èƒ½ä¸å…³æ³¨ï¼Œæ‰‹åŠ¨æ»‘ç¨½ğŸ¤£ğŸ¤£ &nbsp;
>
> æ¬¢è¿å¤§å®¶å…³æ³¨ï¼š**æ­¦å“¥èŠç¼–ç¨‹**ã€**Javaå¼€å‘å®å…¸**ï¼Œæ‚¨çš„æ”¯æŒï¼Œæ˜¯æˆ‘ä»¬åˆ›ä½œçš„æŒç»­åŠ¨åŠ›ï¼&nbsp;&nbsp;

![æ­¦å“¥èŠç¼–ç¨‹](https://img-blog.csdnimg.cn/202002150421550.jpg)![Javaå¼€å‘å®å…¸](https://img-blog.csdnimg.cn/20200608005630228.png)

----

Shiro æ˜¯ä¸€ä¸ªå¼ºå¤§ã€ç®€å•æ˜“ç”¨çš„ Java å®‰å…¨æ¡†æ¶ï¼Œä¸»è¦ç”¨æ¥æ›´ä¾¿æ·çš„è®¤è¯ï¼Œæˆæƒï¼ŒåŠ å¯†ï¼Œä¼šè¯ç®¡ç­‰ç­‰ï¼Œå¯ä¸ºä»»ä½•åº”ç”¨æä¾›å®‰å…¨ä¿éšœã€‚æœ¬è¯¾ç¨‹ä¸»è¦æ¥ä»‹ç» Shiro çš„è®¤è¯å’ŒæˆæƒåŠŸèƒ½ã€‚

## 1. Shiro ä¸‰å¤§æ ¸å¿ƒç»„ä»¶

Shiro æœ‰ä¸‰å¤§æ ¸å¿ƒçš„ç»„ä»¶ï¼š`Subject`ã€`SecurityManager` å’Œ `Realm`ã€‚å…ˆæ¥çœ‹ä¸€ä¸‹å®ƒä»¬ä¹‹é—´çš„å…³ç³»ã€‚

![ä¸‰å¤§æ ¸å¿ƒç»„ä»¶çš„å…³ç³»](https://images.gitbook.cn/2dd0f5f0-af4a-11e8-a51c-93c39f2785b1)

1. Subjectï¼šè®¤è¯ä¸»ä½“ã€‚å®ƒåŒ…å«ä¸¤ä¸ªä¿¡æ¯ï¼šPrincipals å’Œ Credentialsã€‚çœ‹ä¸€ä¸‹è¿™ä¸¤ä¸ªä¿¡æ¯å…·ä½“æ˜¯ä»€ä¹ˆã€‚
> Principalsï¼šèº«ä»½ã€‚å¯ä»¥æ˜¯ç”¨æˆ·åï¼Œé‚®ä»¶ï¼Œæ‰‹æœºå·ç ç­‰ç­‰ï¼Œç”¨æ¥æ ‡è¯†ä¸€ä¸ªç™»å½•ä¸»ä½“èº«ä»½ï¼›   
> Credentialsï¼šå‡­è¯ã€‚å¸¸è§æœ‰å¯†ç ï¼Œæ•°å­—è¯ä¹¦ç­‰ç­‰ã€‚

è¯´ç™½äº†ï¼Œå°±æ˜¯éœ€è¦è®¤è¯çš„ä¸œè¥¿ï¼Œæœ€å¸¸è§çš„å°±æ˜¯ç”¨æˆ·åå¯†ç äº†ï¼Œæ¯”å¦‚ç”¨æˆ·åœ¨ç™»å½•çš„æ—¶å€™ï¼ŒShiro éœ€è¦å»è¿›è¡Œèº«ä»½è®¤è¯ï¼Œå°±éœ€è¦ Subject è®¤è¯ä¸»ä½“ã€‚

2. SecurityManagerï¼šå®‰å…¨ç®¡ç†å‘˜ã€‚è¿™æ˜¯ Shiro æ¶æ„çš„æ ¸å¿ƒï¼Œå®ƒå°±åƒ Shiro å†…éƒ¨æ‰€æœ‰åŸä»¶çš„ä¿æŠ¤ä¼ä¸€æ ·ã€‚æˆ‘ä»¬åœ¨é¡¹ç›®ä¸­ä¸€èˆ¬éƒ½ä¼šé…ç½® SecurityManagerï¼Œå¼€å‘äººå‘˜å¤§éƒ¨åˆ†ç²¾åŠ›ä¸»è¦æ˜¯åœ¨ Subject è®¤è¯ä¸»ä½“ä¸Šé¢ã€‚æˆ‘ä»¬åœ¨ä¸ Subject è¿›è¡Œäº¤äº’çš„æ—¶å€™ï¼Œå®é™…ä¸Šæ˜¯ SecurityManager åœ¨èƒŒååšä¸€äº›å®‰å…¨æ“ä½œã€‚
3. Realmï¼šRealm æ˜¯ä¸€ä¸ªåŸŸï¼Œå®ƒæ˜¯è¿æ¥ Shiro å’Œå…·ä½“åº”ç”¨çš„æ¡¥æ¢ï¼Œå½“éœ€è¦ä¸å®‰å…¨æ•°æ®äº¤äº’çš„æ—¶å€™ï¼Œæ¯”å¦‚ç”¨æˆ·è´¦æˆ·ã€è®¿é—®æ§åˆ¶ç­‰ï¼ŒShiro å°±ä¼šä»ä¸€ä¸ªæˆ–å¤šä¸ª Realm ä¸­å»æŸ¥æ‰¾ã€‚æˆ‘ä»¬å¯ä»¥æŠŠ Realm çœ‹æˆ DataSourceï¼Œå³å®‰å…¨æ•°æ®æºï¼Œä¸€èˆ¬æˆ‘ä»¬ä¼šè‡ªå·±å®šåˆ¶ Realmï¼Œåœ¨è‡ªå®šä¹‰ Realm ä¸­ï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¼šä»æ•°æ®åº“ä¸­è·å–å’Œè®¤è¯ç›¸å…³çš„ä¿¡æ¯ï¼Œè¿™åœ¨ä¸‹æ–‡è‡ªå®šä¹‰ Realm éƒ¨åˆ†ä¼šè¯¦ç»†è¯´æ˜ã€‚

## 1. Shiro èº«ä»½å’Œæƒé™è®¤è¯

### 1.2 Shiro èº«ä»½è®¤è¯

æˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹ Shiro èº«ä»½è®¤è¯çš„è¿‡ç¨‹ï¼Œçœ‹ä¸€ä¸‹å®˜æ–¹çš„ä¸€ä¸ªè®¤è¯å›¾ï¼š

![è®¤è¯è¿‡ç¨‹](https://images.gitbook.cn/f21c53a0-af4f-11e8-a51c-93c39f2785b1)

Step1ï¼šåº”ç”¨ç¨‹åºä»£ç åœ¨è°ƒç”¨ `Subject.login(token)` æ–¹æ³•åï¼Œä¼ å…¥ä»£è¡¨æœ€ç»ˆç”¨æˆ·çš„èº«ä»½å’Œå‡­è¯çš„ AuthenticationToken å®ä¾‹ tokenã€‚ 

Step2ï¼šå°† Subject å®ä¾‹å§”æ‰˜ç»™åº”ç”¨ç¨‹åºçš„ SecurityManagerï¼ˆShiroçš„å®‰å…¨ç®¡ç†ï¼‰æ¥å¼€å§‹å®é™…çš„è®¤è¯å·¥ä½œã€‚è¿™é‡Œå¼€å§‹çœŸæ­£çš„è®¤è¯å·¥ä½œäº†ã€‚ 

Step3ï¼Œ4ï¼Œ5ï¼šç„¶å SecurityManager å°±ä¼šæ ¹æ®å…·ä½“çš„ realm å»è¿›è¡Œå®‰å…¨è®¤è¯äº†ã€‚ ä»å›¾ä¸­å¯ä»¥çœ‹å‡ºï¼Œrealm å¯ä»¥è‡ªå®šä¹‰ï¼ˆCustom Realmï¼‰ã€‚

### 1.3 Shiro æƒé™è®¤è¯

æƒé™è®¤è¯ï¼Œä¹Ÿå°±æ˜¯è®¿é—®æ§åˆ¶ï¼Œå³åœ¨åº”ç”¨ä¸­æ§åˆ¶è°èƒ½è®¿é—®å“ªäº›èµ„æºã€‚åœ¨æƒé™è®¤è¯ä¸­ï¼Œæœ€æ ¸å¿ƒçš„ä¸‰ä¸ªè¦ç´ æ˜¯ï¼šæƒé™ï¼Œè§’è‰²å’Œç”¨æˆ·ã€‚

> æƒé™ï¼ˆpermissionï¼‰ï¼šå³æ“ä½œèµ„æºçš„æƒåˆ©ï¼Œæ¯”å¦‚è®¿é—®æŸä¸ªé¡µé¢ï¼Œä»¥åŠå¯¹æŸä¸ªæ¨¡å—çš„æ•°æ®çš„æ·»åŠ ï¼Œä¿®æ”¹ï¼Œåˆ é™¤ï¼ŒæŸ¥çœ‹çš„æƒåˆ©ï¼› 
> è§’è‰²ï¼ˆroleï¼‰ï¼šæŒ‡çš„æ˜¯ç”¨æˆ·æ‹…ä»»çš„çš„è§’è‰²ï¼Œä¸€ä¸ªè§’è‰²å¯ä»¥æœ‰å¤šä¸ªæƒé™ï¼› 
> ç”¨æˆ·ï¼ˆuserï¼‰ï¼šåœ¨ Shiro ä¸­ï¼Œä»£è¡¨è®¿é—®ç³»ç»Ÿçš„ç”¨æˆ·ï¼Œå³ä¸Šé¢æåˆ°çš„ Subject è®¤è¯ä¸»ä½“ã€‚

å®ƒä»¬ä¹‹é—´çš„çš„å…³ç³»å¯ä»¥ç”¨ä¸‹å›¾æ¥è¡¨ç¤ºï¼š 

![ç”¨æˆ·ã€è§’è‰²å’Œæƒé™çš„å…³ç³»](https://images.gitbook.cn/44a68bc0-af75-11e8-85ef-dd986da3511e)

ä¸€ä¸ªç”¨æˆ·å¯ä»¥æœ‰å¤šä¸ªè§’è‰²ï¼Œè€Œä¸åŒçš„è§’è‰²å¯ä»¥æœ‰ä¸åŒçš„æƒé™ï¼Œä¹Ÿå¯ç”±æœ‰ç›¸åŒçš„æƒé™ã€‚æ¯”å¦‚è¯´ç°åœ¨æœ‰ä¸‰ä¸ªè§’è‰²ï¼Œ1æ˜¯æ™®é€šè§’è‰²ï¼Œ2ä¹Ÿæ˜¯æ™®é€šè§’è‰²ï¼Œ3æ˜¯ç®¡ç†å‘˜ï¼Œè§’è‰²1åªèƒ½æŸ¥çœ‹ä¿¡æ¯ï¼Œè§’è‰²2åªèƒ½æ·»åŠ ä¿¡æ¯ï¼Œç®¡ç†å‘˜éƒ½å¯ä»¥ï¼Œè€Œä¸”è¿˜å¯ä»¥åˆ é™¤ä¿¡æ¯ï¼Œç±»ä¼¼äºè¿™æ ·ã€‚

## 2. Spring Boot é›†æˆ Shiro è¿‡ç¨‹

### 2.1 ä¾èµ–å¯¼å…¥

Spring Boot 2.0.3 é›†æˆ Shiro éœ€è¦å¯¼å…¥å¦‚ä¸‹ starter ä¾èµ–ï¼š

```xml
<dependency>
    <groupId>org.apache.shiro</groupId>
    <artifactId>shiro-spring</artifactId>
    <version>1.4.0</version>
</dependency>
```

### 2.2 æ•°æ®åº“è¡¨æ•°æ®åˆå§‹åŒ–

è¿™é‡Œä¸»è¦æ¶‰åŠåˆ°ä¸‰å¼ è¡¨ï¼šç”¨æˆ·è¡¨ã€è§’è‰²è¡¨å’Œæƒé™è¡¨ï¼Œå…¶å®åœ¨ demo ä¸­ï¼Œæˆ‘ä»¬å®Œå…¨å¯ä»¥è‡ªå·±æ¨¡æ‹Ÿä¸€ä¸‹ï¼Œä¸ç”¨å»ºè¡¨ï¼Œä½†æ˜¯ä¸ºäº†æ›´åŠ æ¥è¿‘å®é™…æƒ…å†µï¼Œæˆ‘ä»¬è¿˜æ˜¯åŠ å…¥ mybatisï¼Œæ¥æ“ä½œæ•°æ®åº“ã€‚ä¸‹é¢æ˜¯æ•°æ®åº“è¡¨çš„è„šæœ¬ã€‚
```sql
CREATE TABLE `t_role` (
  `id` int(11) NOT NULL AUTO_INCREMENT COMMENT 'ä¸»é”®',
  `rolename` varchar(20) DEFAULT NULL COMMENT 'è§’è‰²åç§°',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=4 DEFAULT CHARSET=utf8

CREATE TABLE `t_user` (
  `id` int(11) NOT NULL AUTO_INCREMENT COMMENT 'ç”¨æˆ·ä¸»é”®',
  `username` varchar(20) NOT NULL COMMENT 'ç”¨æˆ·å',
  `password` varchar(20) NOT NULL COMMENT 'å¯†ç ',
  `role_id` int(11) DEFAULT NULL COMMENT 'å¤–é”®å…³è”roleè¡¨',
  PRIMARY KEY (`id`),
  KEY `role_id` (`role_id`),
  CONSTRAINT `t_user_ibfk_1` FOREIGN KEY (`role_id`) REFERENCES `t_role` (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=4 DEFAULT CHARSET=utf8

CREATE TABLE `t_permission` (
  `id` int(11) NOT NULL AUTO_INCREMENT COMMENT 'ä¸»é”®',
  `permissionname` varchar(50) NOT NULL COMMENT 'æƒé™å',
  `role_id` int(11) DEFAULT NULL COMMENT 'å¤–é”®å…³è”role',
  PRIMARY KEY (`id`),
  KEY `role_id` (`role_id`),
  CONSTRAINT `t_permission_ibfk_1` FOREIGN KEY (`role_id`) REFERENCES `t_role` (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=3 DEFAULT CHARSET=utf8
```
å…¶ä¸­ï¼Œt_userï¼Œt_role å’Œ t_permissionï¼Œåˆ†åˆ«å­˜å‚¨ç”¨æˆ·ä¿¡æ¯ï¼Œè§’è‰²ä¿¡æ¯å’Œæƒé™ä¿¡æ¯ï¼Œè¡¨å»ºç«‹å¥½äº†ä¹‹åï¼Œæˆ‘ä»¬å¾€è¡¨é‡Œæ’å…¥ä¸€äº›æµ‹è¯•æ•°æ®ã€‚
t_user è¡¨ï¼š
|id|username|password|role_id|
|:--:|:--:|:--:|:--:|
|1|csdn1|123456|1|
|2|csdn2|123456|2|
|3|csdn3|123456|3|

t_role è¡¨ï¼š
|id|rolename|
|:--:|:--:|
|1|admin|
|2|teacher|
|3|student|

t_permission è¡¨ï¼š
|id|permissionname|role_id|
|:--:|:--:|:--:|
|1|`user:*`|1|
|2|`student:*`|2|

è§£é‡Šä¸€ä¸‹è¿™é‡Œçš„æƒé™ï¼š`user:*`è¡¨ç¤ºæƒé™å¯ä»¥æ˜¯ `user:create` æˆ–è€…å…¶ä»–ï¼Œ`*` å¤„è¡¨ç¤ºä¸€ä¸ªå ä½ç¬¦ï¼Œæˆ‘ä»¬å¯ä»¥è‡ªå·±å®šä¹‰ï¼Œå…·ä½“çš„ä¼šåœ¨ä¸‹æ–‡ Shiro é…ç½®é‚£é‡Œè¯´æ˜ã€‚

### 2.2 è‡ªå®šä¹‰ Realm

æœ‰äº†æ•°æ®åº“è¡¨å’Œæ•°æ®ä¹‹åï¼Œæˆ‘ä»¬å¼€å§‹è‡ªå®šä¹‰ realmï¼Œè‡ªå®šä¹‰ realm éœ€è¦ç»§æ‰¿ AuthorizingRealm ç±»ï¼Œå› ä¸ºè¯¥ç±»å°è£…äº†å¾ˆå¤šæ–¹æ³•ï¼Œå®ƒä¹Ÿæ˜¯ä¸€æ­¥æ­¥ç»§æ‰¿è‡ª Realm ç±»çš„ï¼Œç»§æ‰¿äº† AuthorizingRealm ç±»åï¼Œéœ€è¦é‡å†™ä¸¤ä¸ªæ–¹æ³•ï¼š

> `doGetAuthenticationInfo()` æ–¹æ³•ï¼šç”¨æ¥éªŒè¯å½“å‰ç™»å½•çš„ç”¨æˆ·ï¼Œè·å–è®¤è¯ä¿¡æ¯   
> `doGetAuthorizationInfo()` æ–¹æ³•ï¼šç”¨æ¥ä¸ºå½“å‰ç™»é™†æˆåŠŸçš„ç”¨æˆ·æˆäºˆæƒé™å’Œè§’è‰²

å…·ä½“å®ç°å¦‚ä¸‹ï¼Œç›¸å…³çš„è§£é‡Šæˆ‘æ”¾åœ¨ä»£ç çš„æ³¨é‡Šä¸­ï¼Œè¿™æ ·æ›´åŠ æ–¹ä¾¿ç›´è§‚ï¼š

```java
/**
 * è‡ªå®šä¹‰realm
 * @author shengwu ni
 */
public class MyRealm extends AuthorizingRealm {

    @Resource
    private UserService userService;

    @Override
    protected AuthorizationInfo doGetAuthorizationInfo(PrincipalCollection principalCollection) {
        // è·å–ç”¨æˆ·å
        String username = (String) principalCollection.getPrimaryPrincipal();
        SimpleAuthorizationInfo authorizationInfo = new SimpleAuthorizationInfo();
        // ç»™è¯¥ç”¨æˆ·è®¾ç½®è§’è‰²ï¼Œè§’è‰²ä¿¡æ¯å­˜åœ¨t_roleè¡¨ä¸­å–
        authorizationInfo.setRoles(userService.getRoles(username));
        // ç»™è¯¥ç”¨æˆ·è®¾ç½®æƒé™ï¼Œæƒé™ä¿¡æ¯å­˜åœ¨t_permissionè¡¨ä¸­å–
        authorizationInfo.setStringPermissions(userService.getPermissions(username));
        return authorizationInfo;
    }

    @Override
    protected AuthenticationInfo doGetAuthenticationInfo(AuthenticationToken authenticationToken) throws AuthenticationException {
        // æ ¹æ®tokenè·å–ç”¨æˆ·åï¼Œå¦‚æœæ‚¨ä¸çŸ¥é“è¯¥è¯¥tokenæ€ä¹ˆæ¥çš„ï¼Œå…ˆå¯ä»¥ä¸ç®¡ï¼Œä¸‹æ–‡ä¼šè§£é‡Š
        String username = (String) authenticationToken.getPrincipal();
        // æ ¹æ®ç”¨æˆ·åä»æ•°æ®åº“ä¸­æŸ¥è¯¢è¯¥ç”¨æˆ·
        User user = userService.getByUsername(username);
        if(user != null) {
            // æŠŠå½“å‰ç”¨æˆ·å­˜åˆ°sessionä¸­
            SecurityUtils.getSubject().getSession().setAttribute("user", user);
            // ä¼ å…¥ç”¨æˆ·åå’Œå¯†ç è¿›è¡Œèº«ä»½è®¤è¯ï¼Œå¹¶è¿”å›è®¤è¯ä¿¡æ¯
            AuthenticationInfo authcInfo = new SimpleAuthenticationInfo(user.getUsername(), user.getPassword(), "myRealm");
            return authcInfo;
        } else {
            return null;
        }
    }
}
```
ä»ä¸Šé¢ä¸¤ä¸ªæ–¹æ³•ä¸­å¯ä»¥çœ‹å‡ºï¼šéªŒè¯èº«ä»½çš„æ—¶å€™æ˜¯æ ¹æ®ç”¨æˆ·è¾“å…¥çš„ç”¨æˆ·åå…ˆä»æ•°æ®åº“ä¸­æŸ¥å‡ºè¯¥ç”¨æˆ·åå¯¹åº”çš„ç”¨æˆ·ï¼Œè¿™æ—¶å€™å¹¶æ²¡æœ‰æ¶‰åŠåˆ°å¯†ç ï¼Œä¹Ÿå°±æ˜¯è¯´åˆ°è¿™ä¸€æ­¥çš„æ—¶å€™ï¼Œå³ä½¿ç”¨æˆ·è¾“å…¥çš„å¯†ç ä¸å¯¹ï¼Œä¹Ÿæ˜¯å¯ä»¥æŸ¥å‡ºæ¥è¯¥ç”¨æˆ·çš„ï¼Œç„¶åå°†è¯¥ç”¨æˆ·çš„æ­£ç¡®ä¿¡æ¯å°è£…åˆ° authcInfo ä¸­è¿”å›ç»™ Shiroï¼Œæ¥ä¸‹æ¥å°±æ˜¯Shiroçš„äº‹äº†ï¼Œå®ƒä¼šæ ¹æ®è¿™é‡Œé¢çš„çœŸå®ä¿¡æ¯ä¸ç”¨æˆ·å‰å°è¾“å…¥çš„ç”¨æˆ·åå’Œå¯†ç è¿›è¡Œæ ¡éªŒï¼Œ è¿™ä¸ªæ—¶å€™ä¹Ÿè¦æ ¡éªŒå¯†ç äº†ï¼Œå¦‚æœæ ¡éªŒé€šè¿‡å°±è®©ç”¨æˆ·ç™»å½•ï¼Œå¦åˆ™è·³è½¬åˆ°æŒ‡å®šé¡µé¢ã€‚åŒç†ï¼Œæƒé™éªŒè¯çš„æ—¶å€™ä¹Ÿæ˜¯å…ˆæ ¹æ®ç”¨æˆ·åä»æ•°æ®åº“ä¸­è·å–ä¸è¯¥ç”¨æˆ·åæœ‰å…³çš„è§’è‰²å’Œæƒé™ï¼Œç„¶åå°è£…åˆ° authorizationInfo ä¸­è¿”å›ç»™ Shiroã€‚

### 2.3 Shiro é…ç½®

è‡ªå®šä¹‰çš„ realm å†™å¥½äº†ï¼Œæ¥ä¸‹æ¥éœ€è¦å¯¹ Shiro è¿›è¡Œé…ç½®äº†ã€‚æˆ‘ä»¬ä¸»è¦é…ç½®ä¸‰ä¸ªä¸œè¥¿ï¼šè‡ªå®šä¹‰ realmã€å®‰å…¨ç®¡ç†å™¨ SecurityManager å’Œ Shiro è¿‡æ»¤å™¨ã€‚å¦‚ä¸‹ï¼š

é…ç½®è‡ªå®šä¹‰ realmï¼š
```java
@Configuration
public class ShiroConfig {

    private static final Logger logger = LoggerFactory.getLogger(ShiroConfig.class);

    /**
     * æ³¨å…¥è‡ªå®šä¹‰çš„realm
     * @return MyRealm
     */
    @Bean
    public MyRealm myAuthRealm() {
        MyRealm myRealm = new MyRealm();
        logger.info("====myRealmæ³¨å†Œå®Œæˆ=====");
        return myRealm;
    }
}
```
é…ç½®å®‰å…¨ç®¡ç†å™¨ SecurityManagerï¼š
```java
@Configuration
public class ShiroConfig {

    private static final Logger logger = LoggerFactory.getLogger(ShiroConfig.class);

    /**
     * æ³¨å…¥å®‰å…¨ç®¡ç†å™¨
     * @return SecurityManager
     */
    @Bean
    public SecurityManager securityManager() {
        // å°†è‡ªå®šä¹‰realmåŠ è¿›æ¥
        DefaultWebSecurityManager securityManager = new DefaultWebSecurityManager(myAuthRealm());
        logger.info("====securityManageræ³¨å†Œå®Œæˆ====");
        return securityManager;
    }
}
```
é…ç½® SecurityManager æ—¶ï¼Œéœ€è¦å°†ä¸Šé¢çš„è‡ªå®šä¹‰ realm æ·»åŠ è¿›æ¥ï¼Œè¿™æ ·çš„è¯ Shiro æ‰ä¼šèµ°åˆ°è‡ªå®šä¹‰çš„ realm ä¸­ã€‚

é…ç½® Shiro è¿‡æ»¤å™¨ï¼š
```java
@Configuration
public class ShiroConfig {

    private static final Logger logger = LoggerFactory.getLogger(ShiroConfig.class);
    
    /**
     * æ³¨å…¥Shiroè¿‡æ»¤å™¨
     * @param securityManager å®‰å…¨ç®¡ç†å™¨
     * @return ShiroFilterFactoryBean
     */
    @Bean
    public ShiroFilterFactoryBean shiroFilter(SecurityManager securityManager) {
        // å®šä¹‰shiroFactoryBean
        ShiroFilterFactoryBean shiroFilterFactoryBean=new ShiroFilterFactoryBean();

        // è®¾ç½®è‡ªå®šä¹‰çš„securityManager
        shiroFilterFactoryBean.setSecurityManager(securityManager);

        // è®¾ç½®é»˜è®¤ç™»å½•çš„urlï¼Œèº«ä»½è®¤è¯å¤±è´¥ä¼šè®¿é—®è¯¥url
        shiroFilterFactoryBean.setLoginUrl("/login");
        // è®¾ç½®æˆåŠŸä¹‹åè¦è·³è½¬çš„é“¾æ¥
        shiroFilterFactoryBean.setSuccessUrl("/success");
        // è®¾ç½®æœªæˆæƒç•Œé¢ï¼Œæƒé™è®¤è¯å¤±è´¥ä¼šè®¿é—®è¯¥url
        shiroFilterFactoryBean.setUnauthorizedUrl("/unauthorized");

        // LinkedHashMapæ˜¯æœ‰åºçš„ï¼Œè¿›è¡Œé¡ºåºæ‹¦æˆªå™¨é…ç½®
        Map<String,String> filterChainMap = new LinkedHashMap<>();

        // é…ç½®å¯ä»¥åŒ¿åè®¿é—®çš„åœ°å€ï¼Œå¯ä»¥æ ¹æ®å®é™…æƒ…å†µè‡ªå·±æ·»åŠ ï¼Œæ”¾è¡Œä¸€äº›é™æ€èµ„æºç­‰ï¼Œanonè¡¨ç¤ºæ”¾è¡Œ
        filterChainMap.put("/css/**", "anon");
        filterChainMap.put("/imgs/**", "anon");
        filterChainMap.put("/js/**", "anon");
        filterChainMap.put("/swagger-*/**", "anon");
        filterChainMap.put("/swagger-ui.html/**", "anon");
        // ç™»å½•url æ”¾è¡Œ
        filterChainMap.put("/login", "anon");

        // â€œ/user/adminâ€ å¼€å¤´çš„éœ€è¦èº«ä»½è®¤è¯ï¼Œauthcè¡¨ç¤ºè¦èº«ä»½è®¤è¯
        filterChainMap.put("/user/admin*", "authc");
        // â€œ/user/studentâ€ å¼€å¤´çš„éœ€è¦è§’è‰²è®¤è¯ï¼Œæ˜¯â€œadminâ€æ‰å…è®¸
        filterChainMap.put("/user/student*/**", "roles[admin]");
        // â€œ/user/teacherâ€ å¼€å¤´çš„éœ€è¦æƒé™è®¤è¯ï¼Œæ˜¯â€œuser:createâ€æ‰å…è®¸
        filterChainMap.put("/user/teacher*/**", "perms[\"user:create\"]");

        // é…ç½®logoutè¿‡æ»¤å™¨
        filterChainMap.put("/logout", "logout");

        // è®¾ç½®shiroFilterFactoryBeançš„FilterChainDefinitionMap
        shiroFilterFactoryBean.setFilterChainDefinitionMap(filterChainMap);
        logger.info("====shiroFilterFactoryBeanæ³¨å†Œå®Œæˆ====");
        return shiroFilterFactoryBean;
    }
}
```
é…ç½® Shiro è¿‡æ»¤å™¨æ—¶ä¼šä¼ å…¥ä¸€ä¸ªå®‰å…¨ç®¡ç†å™¨ï¼Œå¯ä»¥çœ‹å‡ºï¼Œè¿™æ˜¯ä¸€ç¯å¥—ä¸€ç¯ï¼Œreaml -> SecurityManager -> filterã€‚åœ¨è¿‡æ»¤å™¨ä¸­ï¼Œæˆ‘ä»¬éœ€è¦å®šä¹‰ä¸€ä¸ª shiroFactoryBeanï¼Œç„¶åå°† SecurityManager æ·»åŠ è¿›æ¥ï¼Œç»“åˆä¸Šé¢ä»£ç å¯ä»¥çœ‹å‡ºï¼Œè¦é…ç½®çš„ä¸œè¥¿ä¸»è¦æœ‰ï¼š

> é»˜è®¤ç™»å½•çš„ urlï¼šèº«ä»½è®¤è¯å¤±è´¥ä¼šè®¿é—®è¯¥ url
> è®¤è¯æˆåŠŸä¹‹åè¦è·³è½¬çš„ url
> æƒé™è®¤è¯å¤±è´¥ä¼šè®¿é—®è¯¥ url
> éœ€è¦æ‹¦æˆªæˆ–è€…æ”¾è¡Œçš„ urlï¼šè¿™äº›éƒ½æ”¾åœ¨ä¸€ä¸ª map ä¸­

ä»ä¸Šè¿°ä»£ç ä¸­å¯ä»¥çœ‹å‡ºï¼Œåœ¨ map ä¸­ï¼Œé’ˆå¯¹ä¸åŒçš„ urlï¼Œæœ‰ä¸åŒçš„æƒé™è¦æ±‚ï¼Œè¿™é‡Œæ€»ç»“ä¸€ä¸‹å¸¸ç”¨çš„å‡ ä¸ªæƒé™ã€‚
|Filter|è¯´æ˜|
|:--:|:--:|
|anon|å¼€æ”¾æƒé™ï¼Œå¯ä»¥ç†è§£ä¸ºåŒ¿åç”¨æˆ·æˆ–æ¸¸å®¢ï¼Œå¯ä»¥ç›´æ¥è®¿é—®çš„|
|authc|éœ€è¦èº«ä»½è®¤è¯çš„|
|logout|æ³¨é”€ï¼Œæ‰§è¡Œåä¼šç›´æ¥è·³è½¬åˆ° `shiroFilterFactoryBean.setLoginUrl();` è®¾ç½®çš„ urlï¼Œå³ç™»å½•é¡µé¢|
|roles[admin]|å‚æ•°å¯å†™å¤šä¸ªï¼Œè¡¨ç¤ºæ˜¯æŸä¸ªæˆ–æŸäº›è§’è‰²æ‰èƒ½é€šè¿‡ï¼Œå¤šä¸ªå‚æ•°æ—¶å†™ roles["adminï¼Œuser"]ï¼Œå½“æœ‰å¤šä¸ªå‚æ•°æ—¶å¿…é¡»æ¯ä¸ªå‚æ•°éƒ½é€šè¿‡æ‰ç®—é€šè¿‡|
|perms[user]|å‚æ•°å¯å†™å¤šä¸ªï¼Œè¡¨ç¤ºéœ€è¦æŸä¸ªæˆ–æŸäº›æƒé™æ‰èƒ½é€šè¿‡ï¼Œå¤šä¸ªå‚æ•°æ—¶å†™ perms[â€œuser, adminâ€]ï¼Œå½“æœ‰å¤šä¸ªå‚æ•°æ—¶å¿…é¡»æ¯ä¸ªå‚æ•°éƒ½é€šè¿‡æ‰ç®—é€šè¿‡|

### 2.4 ä½¿ç”¨ Shiro è¿›è¡Œè®¤è¯

åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å¯¹ Shiro çš„å‡†å¤‡å·¥ä½œéƒ½åšå®Œäº†ï¼Œæ¥ä¸‹æ¥å¼€å§‹ä½¿ç”¨ Shiro è¿›è¡Œè®¤è¯å·¥ä½œã€‚æˆ‘ä»¬é¦–å…ˆæ¥è®¾è®¡å‡ ä¸ªæ¥å£ï¼š
> æ¥å£ä¸€ï¼š ä½¿ç”¨ `http://localhost:8080/user/admin` æ¥éªŒè¯èº«ä»½è®¤è¯
> æ¥å£äºŒï¼š ä½¿ç”¨ `http://localhost:8080/user/student` æ¥éªŒè¯è§’è‰²è®¤è¯
> æ¥å£ä¸‰ï¼š ä½¿ç”¨ `http://localhost:8080/user/teacher` æ¥éªŒè¯æƒé™è®¤è¯
> æ¥å£å››ï¼š ä½¿ç”¨ `http://localhost:8080/user/login` æ¥å®ç°ç”¨æˆ·ç™»å½•

ç„¶åæ¥ä¸€ä¸‹è®¤è¯çš„æµç¨‹ï¼š
> æµç¨‹ä¸€ï¼š ç›´æ¥è®¿é—®æ¥å£ä¸€ï¼ˆæ­¤æ—¶è¿˜æœªç™»å½•ï¼‰ï¼Œè®¤è¯å¤±è´¥ï¼Œè·³è½¬åˆ° login.html é¡µé¢è®©ç”¨æˆ·ç™»å½•ï¼Œç™»å½•ä¼šè¯·æ±‚æ¥å£å››ï¼Œå®ç°ç”¨æˆ·ç™»å½•åŠŸèƒ½ï¼Œæ­¤æ—¶ Shiro å·²ç»ä¿å­˜äº†ç”¨æˆ·ä¿¡æ¯äº†ã€‚
> æµç¨‹äºŒï¼š å†æ¬¡è®¿é—®æ¥å£ä¸€ï¼ˆæ­¤æ—¶ç”¨æˆ·å·²ç»ç™»å½•ï¼‰ï¼Œè®¤è¯æˆåŠŸï¼Œè·³è½¬åˆ° success.html é¡µé¢ï¼Œå±•ç¤ºç”¨æˆ·ä¿¡æ¯ã€‚
> æµç¨‹ä¸‰ï¼š è®¿é—®æ¥å£äºŒï¼Œæµ‹è¯•è§’è‰²è®¤è¯æ˜¯å¦æˆåŠŸã€‚
> æµç¨‹å››ï¼š è®¿é—®æ¥å£ä¸‰ï¼Œæµ‹è¯•æƒé™è®¤è¯æ˜¯å¦æˆåŠŸã€‚

#### 2.4.1 èº«ä»½ã€è§’è‰²ã€æƒé™è®¤è¯æ¥å£

```java
@Controller
@RequestMapping("/user")
public class UserController {

    /**
     * èº«ä»½è®¤è¯æµ‹è¯•æ¥å£
     * @param request
     * @return
     */
    @RequestMapping("/admin")
    public String admin(HttpServletRequest request) {
        Object user = request.getSession().getAttribute("user");
        return "success";
    }

    /**
     * è§’è‰²è®¤è¯æµ‹è¯•æ¥å£
     * @param request
     * @return
     */
    @RequestMapping("/student")
    public String student(HttpServletRequest request) {
        return "success";
    }

    /**
     * æƒé™è®¤è¯æµ‹è¯•æ¥å£
     * @param request
     * @return
     */
    @RequestMapping("/teacher")
    public String teacher(HttpServletRequest request) {
        return "success";
    }
}
```
è¿™ä¸‰ä¸ªæ¥å£å¾ˆç®€å•ï¼Œç›´æ¥è¿”å›åˆ°æŒ‡å®šé¡µé¢å±•ç¤ºå³å¯ï¼Œåªè¦è®¤è¯æˆåŠŸå°±ä¼šæ­£å¸¸è·³è½¬ï¼Œå¦‚æœè®¤è¯å¤±è´¥ï¼Œå°±ä¼šè·³è½¬åˆ°ä¸Šæ–‡ ShrioConfig ä¸­é…ç½®çš„é¡µé¢è¿›è¡Œå±•ç¤ºã€‚

#### 2.4.2 ç”¨æˆ·ç™»å½•æ¥å£

```java
@Controller
@RequestMapping("/user")
public class UserController {

    /**
     * ç”¨æˆ·ç™»å½•æ¥å£
     * @param user user
     * @param request request
     * @return string
     */
    @PostMapping("/login")
    public String login(User user, HttpServletRequest request) {

        // æ ¹æ®ç”¨æˆ·åå’Œå¯†ç åˆ›å»ºtoken
        UsernamePasswordToken token = new UsernamePasswordToken(user.getUsername(), user.getPassword());
        // è·å–subjectè®¤è¯ä¸»ä½“
        Subject subject = SecurityUtils.getSubject();
        try{
            // å¼€å§‹è®¤è¯ï¼Œè¿™ä¸€æ­¥ä¼šè·³åˆ°æˆ‘ä»¬è‡ªå®šä¹‰çš„realmä¸­
            subject.login(token);
            request.getSession().setAttribute("user", user);
            return "success";
        }catch(Exception e){
            e.printStackTrace();
            request.getSession().setAttribute("user", user);
            request.setAttribute("error", "ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯ï¼");
            return "login";
        }
    }
}
```
æˆ‘ä»¬é‡ç‚¹åˆ†æä¸€ä¸‹è¿™ä¸ªç™»å½•æ¥å£ï¼Œé¦–å…ˆä¼šæ ¹æ®å‰ç«¯ä¼ è¿‡æ¥çš„ç”¨æˆ·åå’Œå¯†ç ï¼Œåˆ›å»ºä¸€ä¸ª tokenï¼Œç„¶åä½¿ç”¨ SecurityUtils æ¥åˆ›å»ºä¸€ä¸ªè®¤è¯ä¸»ä½“ï¼Œæ¥ä¸‹æ¥å¼€å§‹è°ƒç”¨ `subject.login(token)` å¼€å§‹è¿›è¡Œèº«ä»½è®¤è¯äº†ï¼Œæ³¨æ„è¿™é‡Œä¼ äº†åˆšåˆšåˆ›å»ºçš„ tokenï¼Œå°±å¦‚æ³¨é‡Šä¸­æ‰€è¿°ï¼Œè¿™ä¸€æ­¥ä¼šè·³è½¬åˆ°æˆ‘ä»¬è‡ªå®šä¹‰çš„ realm ä¸­ï¼Œè¿›å…¥ `doGetAuthenticationInfo` æ–¹æ³•ï¼Œæ‰€ä»¥åˆ°è¿™é‡Œï¼Œæ‚¨å°±ä¼šæ˜ç™½è¯¥æ–¹æ³•ä¸­é‚£ä¸ªå‚æ•° token äº†ã€‚ç„¶åå°±æ˜¯ä¸Šæ–‡åˆ†æçš„é‚£æ ·ï¼Œå¼€å§‹è¿›è¡Œèº«ä»½è®¤è¯ã€‚

#### 2.4.3 æµ‹è¯•ä¸€ä¸‹

æœ€åï¼Œå¯åŠ¨é¡¹ç›®ï¼Œæµ‹è¯•ä¸€ä¸‹ï¼š
æµè§ˆå™¨è¯·æ±‚ `http://localhost:8080/user/admin` ä¼šè¿›è¡Œèº«ä»½è®¤è¯ï¼Œå› ä¸ºæ­¤æ—¶æœªç™»å½•ï¼Œæ‰€ä»¥ä¼šè·³è½¬åˆ° IndexController ä¸­çš„ `/login` æ¥å£ï¼Œç„¶åè·³è½¬åˆ° `login.html` é¡µé¢è®©æˆ‘ä»¬ç™»å½•ï¼Œä½¿ç”¨ç”¨æˆ·åå¯†ç ä¸º csdn1/123456 ç™»å½•ä¹‹åï¼Œæˆ‘ä»¬åœ¨æµè§ˆå™¨ä¸­è¯·æ±‚ `http://localhost:8080/user/student` æ¥å£ï¼Œä¼šè¿›è¡Œè§’è‰²è®¤è¯ï¼Œå› ä¸ºæ•°æ®åº“ä¸­ csdn1 çš„ç”¨æˆ·è§’è‰²æ˜¯ adminï¼Œæ‰€ä»¥å’Œé…ç½®ä¸­çš„å»åˆï¼Œè®¤è¯é€šè¿‡ï¼›æˆ‘ä»¬å†è¯·æ±‚ `http://localhost:8080/user/teacher` æ¥å£ï¼Œä¼šè¿›è¡Œæƒé™è®¤è¯ï¼Œå› ä¸ºæ•°æ®åº“ä¸­ csdn1 çš„ç”¨æˆ·æƒé™ä¸º `user:*`ï¼Œæ»¡è¶³é…ç½®ä¸­çš„ `user:create`ï¼Œæ‰€ä»¥è®¤è¯é€šè¿‡ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ç‚¹é€€å‡ºï¼Œç³»ç»Ÿä¼šæ³¨é”€é‡æ–°è®©æˆ‘ä»¬ç™»å½•ï¼Œæˆ‘ä»¬ä½¿ç”¨ csdn2 è¿™ä¸ªç”¨æˆ·æ¥ç™»å½•ï¼Œé‡å¤ä¸Šè¿°æ“ä½œï¼Œå½“åœ¨è¿›è¡Œè§’è‰²è®¤è¯å’Œæƒé™è®¤è¯è¿™ä¸¤æ­¥æ—¶ï¼Œå°±è®¤è¯ä¸é€šè¿‡äº†ï¼Œå› ä¸ºæ•°æ®åº“ä¸­ csdn2 è¿™ä¸ªç”¨æˆ·å­˜çš„è§’è‰²å’Œæƒé™ä¸é…ç½®ä¸­çš„ä¸åŒï¼Œæ‰€ä»¥è®¤è¯ä¸é€šè¿‡ã€‚


## 3. æ€»ç»“

æœ¬èŠ‚ä¸»è¦ä»‹ç»äº† Shiro å®‰å…¨æ¡†æ¶ä¸ Spring Boot çš„æ•´åˆã€‚å…ˆä»‹ç»äº† Shiro çš„ä¸‰å¤§æ ¸å¿ƒç»„ä»¶å·²ç»å®ƒä»¬çš„ä½œç”¨ï¼›ç„¶åä»‹ç»äº† Shiro çš„èº«ä»½è®¤è¯ã€è§’è‰²è®¤è¯å’Œæƒé™è®¤è¯ï¼›æœ€åç»“åˆä»£ç ï¼Œè¯¦ç»†ä»‹ç»äº† Spring Boot ä¸­æ˜¯å¦‚ä½•æ•´åˆ Shiro çš„ï¼Œå¹¶è®¾è®¡äº†ä¸€å¥—æµ‹è¯•æµç¨‹ï¼Œé€æ­¥åˆ†æ Shiro çš„å·¥ä½œæµç¨‹å’ŒåŸç†ï¼Œè®©è¯»è€…æ›´ç›´è§‚åœ°ä½“ä¼šå‡º Shiro çš„æ•´å¥—å·¥ä½œæµç¨‹ã€‚Shiro ä½¿ç”¨çš„å¾ˆå¹¿æ³›ï¼Œå¸Œæœ›è¯»è€…å°†å…¶æŒæ¡ï¼Œå¹¶èƒ½è¿ç”¨åˆ°å®é™…é¡¹ç›®ä¸­ã€‚

è¯¾ç¨‹æºä»£ç ä¸‹è½½åœ°å€ï¼š[æˆ³æˆ‘ä¸‹è½½](https://gitee.com/eson15/springboot_study)

----
> æ–‡ç« å¯ä»¥ç™½å«–ï¼Œå…¬ä¼—å·ä¸èƒ½ä¸å…³æ³¨ï¼Œæ‰‹åŠ¨æ»‘ç¨½ğŸ¤£ğŸ¤£ &nbsp;
>
> æ¬¢è¿å¤§å®¶å…³æ³¨ï¼š**æ­¦å“¥èŠç¼–ç¨‹**ã€**Javaå¼€å‘å®å…¸**ï¼Œæ‚¨çš„æ”¯æŒï¼Œæ˜¯æˆ‘ä»¬åˆ›ä½œçš„æŒç»­åŠ¨åŠ›ï¼&nbsp;&nbsp;

![æ­¦å“¥èŠç¼–ç¨‹](https://img-blog.csdnimg.cn/202002150421550.jpg)![Javaå¼€å‘å®å…¸](https://img-blog.csdnimg.cn/20200608005630228.png)