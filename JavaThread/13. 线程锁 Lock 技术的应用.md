> æ–‡ç« å¯ä»¥ç™½å«–ï¼Œè€é“ä»¬é¡ºä¾¿å…³æ³¨ä¸€ä¸‹æˆ‘çš„å…¬ä¼—å·ï¼Œæ‰‹åŠ¨æ»‘ç¨½ğŸ¤£ğŸ¤£ &nbsp;
>
> æ¬¢è¿å¤§å®¶å…³æ³¨ï¼š**æ­¦å“¥èŠç¼–ç¨‹**ã€**Javaå¼€å‘å®å…¸**ã€**Javaç§ƒå¤´å“¥**ï¼Œæ‚¨çš„æ”¯æŒï¼Œæ˜¯æˆ‘åˆ›ä½œçš„æŒç»­åŠ¨åŠ›ï¼&nbsp;&nbsp;

![æ­¦å“¥èŠç¼–ç¨‹](https://img-blog.csdnimg.cn/202002150421550.jpg)![Javaå¼€å‘å®å…¸](https://img-blog.csdnimg.cn/20200608005630228.png)![Javaç§ƒå¤´å“¥](https://img-blog.csdnimg.cn/20201025170941235.png)

----

çº¿ç¨‹é”å¥½æ¯”ä¼ ç»Ÿçº¿ç¨‹æ¨¡å‹ä¸­çš„ synchronized æŠ€æœ¯ï¼Œä½†æ˜¯æ¯” sychronized æ–¹å¼æ›´åŠ é¢å‘å¯¹è±¡ï¼Œä¸ç”Ÿæ´»ä¸­çš„é”ç±»ä¼¼ï¼Œé”æœ¬èº«ä¹Ÿåº”è¯¥æ˜¯ä¸ªå¯¹è±¡ã€‚ä¸¤ä¸ªçº¿ç¨‹æ‰§è¡Œçš„ä»£ç ç‰‡æ®µå¦‚æœè¦å®ç°åŒæ­¥äº’æ–¥çš„æ•ˆæœï¼Œå®ƒä»¬å¿…é¡»ç”¨åŒä¸€ä¸ªé”å¯¹è±¡ã€‚é”æ˜¯ä¸Šåœ¨ä»£è¡¨è¦æ“ä½œçš„èµ„æºçš„ç±»çš„å†…éƒ¨æ–¹æ³•ä¸­ï¼Œè€Œä¸æ˜¯çº¿ç¨‹ä»£ç ä¸­ã€‚è¿™ä¸€ç¯‡åšæ–‡ä¸»è¦æ€»ç»“ä¸€ä¸‹çº¿ç¨‹é”æŠ€æœ¯ä¸­ Lock é”ã€ReadWriteLock é”çš„ä½¿ç”¨ã€‚

## 1. Lock çš„ç®€å•ä½¿ç”¨

æœ‰äº† synchronized çš„åŸºç¡€ï¼ŒLock å°±æ¯”è¾ƒç®€å•äº†ï¼Œé¦–å…ˆçœ‹ä¸€ä¸ªå®ä¾‹ï¼š
```java
public class LockTest {

	public static void main(String[] args) {

		new LockTest().init();
	}

	private void init() {
		final Outputer outputer = new Outputer();
		// çº¿ç¨‹1æ‰“å°ï¼šduoxiancheng
		new Thread(new Runnable() {
			@Override
			public void run() {
				while (true) {
					try {
						Thread.sleep(5);
					} catch (InterruptedException e) {
						// TODO Auto-generated catch block
						e.printStackTrace();
					}
					outputer.output("duoxiancheng");
				}

			}
		}).start();
		;

		// çº¿ç¨‹2æ‰“å°ï¼šeson15
		new Thread(new Runnable() {
			@Override
			public void run() {
				while (true) {
					try {
						Thread.sleep(5);
					} catch (InterruptedException e) {
						// TODO Auto-generated catch block
						e.printStackTrace();
					}
					outputer.output("eson15");
				}

			}
		}).start();
		;
	}

	// è‡ªå®šä¹‰ä¸€ä¸ªç±»ï¼Œä¿å­˜é”å’Œå¾…æ‰§è¡Œçš„ä»»åŠ¡
	static class Outputer {
		Lock lock = new ReentrantLock(); //å®šä¹‰ä¸€ä¸ªé”ï¼ŒLockæ˜¯ä¸ªæ¥å£ï¼Œéœ€å®ä¾‹åŒ–ä¸€ä¸ªå…·ä½“çš„Lock
		//å­—ç¬¦ä¸²æ‰“å°æ–¹æ³•ï¼Œä¸€ä¸ªä¸ªå­—ç¬¦çš„æ‰“å°
		public void output(String name) {

			int len = name.length();
			lock.lock();
			try {
				for (int i = 0; i < len; i++) {
					System.out.print(name.charAt(i));
				}
				System.out.println("");
			} finally {
				lock.unlock(); //tryèµ·æ¥çš„åŸå› æ˜¯ä¸‡ä¸€ä¸€ä¸ªçº¿ç¨‹è¿›å»äº†ç„¶åæŒ‚äº†æˆ–è€…æŠ›å¼‚å¸¸äº†ï¼Œé‚£ä¹ˆè¿™ä¸ªé”æ ¹æœ¬æ²¡æœ‰é‡Šæ”¾
			}
		}
}
```
è¿™ä¸ªä¾‹å­å’Œå‰é¢ä»‹ç» synchronized çš„ä¾‹å­å·®ä¸å¤šï¼ŒåŒºåˆ«åœ¨äºå°† synchronized æ”¹æˆäº† lockã€‚ä»ç¨‹åºä¸­å¯ä»¥çœ‹å‡ºï¼Œä½¿ç”¨ Lock çš„æ—¶å€™ï¼Œéœ€è¦å…ˆ new ä¸€ä¸ª Lock å¯¹è±¡ï¼Œç„¶ååœ¨çº¿ç¨‹ä»»åŠ¡ä¸­éœ€è¦åŒæ­¥çš„åœ°æ–¹ä¸Šé”ï¼Œä½†æ˜¯ä¸€å®šè¦è®°å¾—æ”¾é”ï¼Œæ‰€ä»¥ä½¿ç”¨ try å—å»å¤„ç†äº†ä¸€ä¸‹ï¼Œå°†æ”¾é”çš„åŠ¨ä½œæ”¾åœ¨ finally å—ä¸­äº†ã€‚

è¿™æ˜¯ä¸€ä¸ªçº¿ç¨‹ä»»åŠ¡çš„æƒ…å†µï¼Œå¦‚æœä¸¤ä¸ªçº¿ç¨‹ä»»åŠ¡ä¹Ÿä¸éº»çƒ¦ï¼Œè¿˜æ˜¯åœ¨è¿™ä¸ªç±»ä¸­æ–°å»ºä¸€ä¸ªä»»åŠ¡æ–¹æ³•ï¼Œå› ä¸º Lock æ˜¯è¿™ä¸ªç±»çš„æˆå‘˜å˜é‡ï¼Œè¿˜æ˜¯å¯ä»¥ç”¨è¿™ä¸ª lockï¼Œè€Œä¸”å¿…é¡»ç”¨è¿™ä¸ª lockï¼Œå› ä¸ºè¦å®ç°åŒæ­¥äº’æ–¥ï¼Œå¿…é¡»ä½¿ç”¨åŒä¸€æŠŠé”ã€‚

## 2. è¯»å†™é”çš„å¦™ç”¨

é”åˆåˆ†ä¸ºè¯»é”å’Œå†™é”ï¼Œè¯»é”ä¸è¯»é”ä¸äº’æ–¥ï¼Œè¯»é”ä¸å†™é”äº’æ–¥ï¼Œå†™é”ä¸å†™é”äº’æ–¥ï¼Œè¿™æ˜¯ç”± jvm è‡ªå·±æ§åˆ¶çš„ã€‚è¿™å¾ˆå¥½ç†è§£ï¼Œè¯»å˜›ï¼Œå¤§å®¶éƒ½èƒ½è¯»ï¼Œä¸ä¼šå¯¹æ•°æ®é€ æˆä¿®æ”¹ï¼Œåªè¦æ¶‰åŠåˆ°å†™ï¼Œé‚£å°±å¯èƒ½å‡ºé—®é¢˜ã€‚ æˆ‘ä»¬å†™ä»£ç çš„æ—¶å€™åªè¦åœ¨æ­£ç¡®çš„ä½ç½®ä¸Šç›¸åº”çš„é”å³å¯ã€‚è¯»å†™é”æœ‰ä¸ªæ¥å£å« ReadWriteLockï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºå…·ä½“çš„è¯»å†™é”å®ä¾‹ï¼Œé€šè¿‡è¯»å†™é”ä¹Ÿå¯ä»¥æ‹¿åˆ°è¯»é”å’Œå†™é”ã€‚ä¸‹é¢çœ‹ä¸€ä¸‹è¯»å†™é”çš„ä¾‹å­ï¼š

### 2.1 è¯»å†™é”çš„åŸºæœ¬ç”¨æ³•

```java
public class ReadWriteLockTest {

	public static void main(String[] args) {
		final Queue3 q3 = new Queue3(); //å°è£…å…±äº«çš„æ•°æ®ã€è¯»å†™é”å’Œå¾…æ‰§è¡Œçš„ä»»åŠ¡çš„ç±»

		for (int i = 0; i < 3; i++) {
			new Thread() { // å¼€å¯ä¸‰ä¸ªçº¿ç¨‹å†™æ•°æ®
				public void run() {
					while (true) {
						q3.put(new Random().nextInt(10000));
					}
				}
			}.start();

			new Thread() { // å¼€å¯ä¸‰ä¸ªçº¿ç¨‹è¯»æ•°æ®
				public void run() {
					while (true) {
						q3.get();
					}
				}
			}.start();
		}
	}
}

class Queue3 {

	private Object data = null; // å…±äº«çš„æ•°æ®
	private ReadWriteLock rwl = new ReentrantReadWriteLock();// å®šä¹‰è¯»å†™é”

	// è¯»å–æ•°æ®çš„ä»»åŠ¡æ–¹æ³•
	public void get() {
		rwl.readLock().lock(); // ä¸Šè¯»é”
		try {
			System.out.println(Thread.currentThread().getName() 
					+ ":before read: " + data); // è¯»ä¹‹å‰æ‰“å°æ•°æ®æ˜¾ç¤º
			
			Thread.sleep((long) (Math.random() * 1000)); // ç¡ä¸€ä¼šå„¿~
			
			System.out.println(Thread.currentThread().getName() 
					+ ":after read: " + data); // è¯»ä¹‹åæ‰“å°æ•°æ®æ˜¾ç¤º
		} catch (InterruptedException e) {
			e.printStackTrace();
		} finally {
			rwl.readLock().unlock();// é‡Šæ”¾è¯»é”
		}
	}

	// å†™æ•°æ®çš„ä»»åŠ¡æ–¹æ³•
	public void put(Object data) {
		rwl.writeLock().lock(); // ä¸Šå†™é”
		try {
			System.out.println(Thread.currentThread().getName() 
					+ ":before write: " + this.data); // è¯»ä¹‹å‰æ‰“å°æ•°æ®æ˜¾ç¤º
			
			Thread.sleep((long) (Math.random() * 1000)); // ç¡ä¸€ä¼šå„¿~
			this.data = data; //å†™æ•°æ®
			
			System.out.println(Thread.currentThread().getName() 
					+ ":after write: " + this.data); // è¯»ä¹‹åæ‰“å°æ•°æ®æ˜¾ç¤º
		} catch (InterruptedException e) {
			e.printStackTrace();
		} finally {
			rwl.writeLock().unlock();// é‡Šæ”¾å†™é”		
		}
	}
}
```
ä¸ºäº†è¯´æ˜è¯»é”å’Œå†™é”çš„ç‰¹ç‚¹ï¼ˆè¯»é”ä¸è¯»é”ä¸äº’æ–¥ï¼Œè¯»é”ä¸å†™é”äº’æ–¥ï¼Œå†™é”ä¸å†™é”äº’æ–¥ï¼‰ï¼Œæˆ‘å…ˆæŠŠä¸Šé¢ä¸¤ä¸ªä»»åŠ¡æ–¹æ³•ä¸­ä¸Šé”å’Œé‡Šæ”¾é”çš„å››è¡Œä»£ç æ³¨é‡Šæ‰ï¼Œæ¥çœ‹ä¸€ä¸‹è¿è¡Œç»“æœï¼š
![æ²¡ä¸Šé”](https://images.xiaozhuanlan.com/photo/2019/d05affc1a738c98a1cfd4710206d27b2.jpg)
å…¶å®ä¸ç®¡æ˜¯æ³¨é‡Šæ‰è¯»é”è¿˜æ˜¯æ³¨é‡Šæ‰å†™é”è¿˜æ˜¯å…¨æ³¨é‡Šæ‰ï¼Œéƒ½ä¼šå‡ºé—®é¢˜ï¼Œå†™çš„æ—¶å€™ä¼šæœ‰çº¿ç¨‹å»è¯»ã€‚é‚£ä¹ˆå°†è¯»å†™é”åŠ ä¸Šåï¼Œå†çœ‹ä¸€ä¸‹è¿è¡Œç»“æœï¼š

![ä¸Šé”å](https://images.xiaozhuanlan.com/photo/2019/158d509bd71dd200b5ac900291d77c54.jpg)
å¯ä»¥çœ‹å‡ºï¼Œæœ‰äº†è¯»å†™é”ï¼Œå„ä¸ªçº¿ç¨‹è¿è¡Œæœ‰åºï¼Œä»ç»“æœæ¥çœ‹ï¼Œä¹Ÿå°è¯äº†è¯»é”ä¸è¯»é”ä¸äº’æ–¥ï¼Œå†™é”ä¸è¯»é”ã€å†™é”éƒ½äº’æ–¥çš„ç‰¹ç‚¹ã€‚

### 2.2 è¯»å†™é”ç”¨äºç¼“å­˜æ•°æ®

ç°åœ¨ä½¿ç”¨è¯»å†™é”å†™ä¸€ä¸ªç¨å¾®é«˜çº§ä¸€ç‚¹çš„åº”ç”¨ demoï¼Œå³æ¨¡æ‹Ÿç¼“å­˜æ•°æ®ã€‚å®ç°çš„åŠŸèƒ½å¦‚ä¸‹ï¼šç°åœ¨æœ‰5ä¸ªçº¿ç¨‹éƒ½éœ€è¦æ‹¿æ•°æ®ï¼Œä¸€å¼€å§‹æ˜¯æ²¡æœ‰æ•°æ®çš„ï¼Œæ‰€ä»¥æœ€å…ˆå»æ‹¿æ•°æ®çš„é‚£ä¸ªçº¿ç¨‹å‘ç°æ²¡æ•°æ®ï¼Œå®ƒå°±å¾—å»åˆå§‹åŒ–ä¸€ä¸ªæ•°æ®ï¼Œç„¶åå…¶ä»–çº¿ç¨‹æ‹¿æ•°æ®çš„æ—¶å€™å°±å¯ä»¥ç›´æ¥æ‹¿äº†ã€‚ä»£ç å¦‚ä¸‹ï¼š

```java
public class ReadWriteLockTest2 {

	public static void main(String[] args) {
		
		CacheData cache = new CacheData();
		
		for(int i = 1; i <= 5; i ++) { //å¼€å¯5ä¸ªçº¿ç¨‹
			new Thread(new Runnable() {
				
				@Override
				public void run() {
					cache.processCache(); //éƒ½å»æ‹¿æ•°æ®
				}
			}).start();
		}
	}
}

class CacheData {

	private Object data = null; // éœ€è¦ç¼“å­˜çš„æ•°æ®
	private boolean cacheValid; //ç”¨æ¥æ ‡è®°æ˜¯å¦æœ‰ç¼“å­˜æ•°æ®
	private ReadWriteLock rwl = new ReentrantReadWriteLock();// å®šä¹‰è¯»å†™é”

	public void processCache() {
		rwl.readLock().lock(); //ä¸Šè¯»é”
		
		if(!cacheValid) { //å¦‚æœæ²¡æœ‰ç¼“å­˜ï¼Œé‚£è¯´æ˜æ˜¯ç¬¬ä¸€æ¬¡è®¿é—®ï¼Œéœ€è¦ç»™dataèµ‹ä¸ªå€¼
			rwl.readLock().unlock(); //å…ˆæŠŠè¯»é”é‡Šæ”¾æ‰
			rwl.writeLock().lock(); //ä¸Šå†™é”
			if(!cacheValid) {
				System.out.println(Thread.currentThread().getName() + ": no cache!");
				data = new Random().nextInt(1000); //èµ‹å€¼
				cacheValid = true; //æ ‡è®°å·²ç»æœ‰ç¼“å­˜äº†
				System.out.println(Thread.currentThread().getName() + ": already cached!");
			}
			rwl.readLock().lock(); //å†æŠŠè¯»é”ä¸Šä¸Š
			rwl.writeLock().unlock(); //æŠŠåˆšåˆšä¸Šçš„å†™é”é‡Šæ”¾æ‰
		}
		System.out.println(Thread.currentThread().getName() + " get data: " + data);
		rwl.readLock().unlock(); //é‡Šæ”¾è¯»é”
	}
}
```
ä»ä»£ç ä¸­å¯ä»¥çœ‹å‡ºï¼Œåœ¨ processCache æ–¹æ³•ä¸­å¯¹è¯»é”å’Œå†™é”çš„äº¤æ›¿ä½¿ç”¨ã€‚ä¸€å¼€å§‹è¿›æ¥éƒ½æ˜¯è¯»æ•°æ®çš„ï¼Œæ‰€ä»¥ä¸€å¼€å§‹éƒ½æ˜¯ä¸Šäº†è¯»é”ï¼Œä½†å½“ç¬¬ä¸€ä¸ªçº¿ç¨‹è¿›æ¥å‘ç°æ²¡æœ‰ç¼“å­˜æ•°æ®çš„æ—¶å€™ï¼Œå®ƒå¾—å†™æ•°æ®ï¼Œé‚£ä¹ˆæ­¤æ—¶å®ƒå¾—å…ˆæŠŠè¯»é”ç»™é‡Šæ”¾æ‰ï¼Œæ¢äº†æŠŠå†™é”ï¼Œå‘Šè¯‰å…¶ä»–çº¿ç¨‹ï¼šâ€å“å“¥ä»¬ï¼Œè¿™é‡Œé¢è¾¹å„¿æ ¹æœ¬æ²¡æ•°æ®å•Šï¼Œæˆ‘ä»¬è¢«å‘äº†ï¼Œè®©æˆ‘å…ˆå¼„ä¸ªæ•°æ®æ¥å§ï¼Œä¸å¥½æ„æ€ä½ ä»¬å…ˆç­‰ä¼šå„¿~â€œï¼Œç­‰è¯¥çº¿ç¨‹åˆå§‹åŒ–å¥½äº†æ•°æ®åï¼Œå…¶ä»–çº¿ç¨‹å°±å¯ä»¥è¯»äº†ï¼Œäºæ˜¯å®ƒåˆæŠŠè¯»é”è£…èµ·æ¥äº†ï¼ŒæŠŠå†™é”é‡Šæ”¾äº†ï¼Œç„¶åå®ƒå‡ºå»äº†ã€‚è¿™å°±æ¨¡æ‹Ÿäº†æ‹¿ç¼“å­˜æ•°æ®çš„ä¸€ä¸ª demoï¼Œå¯ä»¥çœ‹å‡ºï¼Œåœ¨ä¸€ä¸ªæ–¹æ³•ä¸­ï¼ŒåŒä¸€ä¸ªçº¿ç¨‹å¯ä»¥æ“ä½œä¸¤ä¸ªé”çš„ã€‚çœ‹ä¸€ä¸‹è¿è¡Œç»“æœï¼š

>Thread-1: no cache!<br>
Thread-1: already cached!<br>
Thread-1 get data: 893<br>
Thread-0 get data: 893<br>
Thread-2 get data: 893<br>

è¿™å’Œ Hibernate ä¸­çš„é‚£ä¸ª `load(id, Class.class)` æ–¹æ³•æœ‰ç‚¹ç±»ä¼¼ï¼Œå…ˆæ‹¿åˆ°çš„æ˜¯ä»£ç†å¯¹è±¡ï¼Œè¦ä½¿ç”¨è¯¥å¯¹è±¡çš„æ—¶å€™ï¼Œå¦‚æœå‘ç°æ²¡æœ‰ï¼Œå°±æ–°äº§ç”Ÿä¸€ä¸ªï¼Œå¦‚æœæœ‰äº†å°±ç›´æ¥æ‹¿æ¥ç”¨ã€‚

### 2.3 è¯»å†™é”ç”¨äºç¼“å­˜ç³»ç»Ÿ

è¿›é˜¶ï¼Œå¦‚æœç°åœ¨è¦ç¼“å­˜å¤šä¸ªæ•°æ®ï¼Œå³è¦å†™ä¸€ä¸ªç¼“å­˜ç³»ç»Ÿï¼Œé‚£è¯¥å¦‚ä½•åšå‘¢ï¼Ÿä¸€ä¸ªç¼“å­˜ç³»ç»Ÿæ— éå°±æ˜¯ä¸€ä¸ªå®¹å™¨ï¼Œå¯ä»¥å­˜å‚¨å¾ˆå¤šç¼“å­˜æ•°æ®ï¼Œå¾ˆè‡ªç„¶çš„æƒ³åˆ°ä½¿ç”¨ä¸€ä¸ª Mapï¼Œä¸“é—¨è£…ç¼“å­˜æ•°æ®ï¼Œç„¶åä¾›å¤šä¸ªçº¿ç¨‹å»ä½¿ç”¨ã€‚æ‰€ä»¥æ•´ä¸ªè®¾è®¡æ€è·¯ï¼Œè·Ÿä¸Šé¢ç¼“å­˜å•ä¸ªæ•°æ®æ˜¯ä¸€æ ·çš„ï¼Œä¸è¿‡å°±æ˜¯å¤šè€ƒè™‘ä¸€äº›ä¸œè¥¿è€Œå·²ï¼Œçœ‹ä¸‹ä»£ç ï¼š
```java
public class CacheDemo {

	public static void main(String[] args) {
		
		Cache cac = new Cache();
		for(int i = 0; i < 3; i ++) { //å¼€å¯ä¸‰ä¸ªçº¿ç¨‹å»ç¼“å­˜ä¸­æ‹¿keyä¸ºcache1çš„æ•°æ®ï¼Œ
			new Thread(new Runnable() {
				
				@Override
				public void run() {
					String value = (String) cac.getData("cache1"); //ç¬¬ä¸€ä¸ªè¿›å…¥çš„çº¿ç¨‹è¦å…ˆå†™ä¸€ä¸ªæ•°æ®è¿›å»ï¼ˆç›¸å½“äºç¬¬ä¸€æ¬¡ä»æ•°æ®åº“ä¸­å–ï¼‰	
					System.out.println(Thread.currentThread().getName() + ": " + value);	
				}
			}).start();
		}
		
		for(int i = 0; i < 3; i ++) { //å¼€å¯ä¸‰ä¸ªçº¿ç¨‹å»ç¼“å­˜ä¸­æ‹¿keyä¸ºcacahe2çš„æ•°æ®
			new Thread(new Runnable() {
				
				@Override
				public void run() {
					String value = (String) cac.getData("cache2");//ç¬¬ä¸€ä¸ªè¿›å…¥çš„çº¿ç¨‹è¦å…ˆå†™ä¸€ä¸ªæ•°æ®è¿›å»ï¼ˆç›¸å½“äºç¬¬ä¸€æ¬¡ä»æ•°æ®åº“ä¸­å–ï¼‰
					System.out.println(Thread.currentThread().getName() + ": " + value);
				}
			}).start();
		}
	}
}

class Cache {
	//å­˜å‚¨ç¼“å­˜æ•°æ®çš„Mapï¼Œæ³¨æ„HashMapæ˜¯éçº¿ç¨‹å®‰å…¨çš„ï¼Œä¹Ÿè¦è¿›è¡ŒåŒæ­¥æ“ä½œ
	private Map<String, Object> cache = Collections.synchronizedMap(new HashMap<String, Object>()); 
	private ReadWriteLock rwl = new ReentrantReadWriteLock(); //å®šä¹‰è¯»å†™é”

	public synchronized Object getData(String key) {
		rwl.readLock().lock(); //ä¸Šè¯»é”
		Object value = null; 
		try {
			value = cache.get(key); //æ ¹æ®keyä»ç¼“å­˜ä¸­æ‹¿æ•°æ®
			if (value == null) { //å¦‚æœç¬¬ä¸€æ¬¡é‚£è¯¥keyå¯¹åº”çš„æ•°æ®ï¼Œæ‹¿ä¸åˆ°
				rwl.readLock().unlock(); //é‡Šæ”¾è¯»é”
				rwl.writeLock().lock(); //æ¢æˆå†™é”
				try {
					if (value == null) { //ä¹‹æ‰€ä»¥å†å»åˆ¤æ–­ï¼Œæ˜¯ä¸ºäº†é˜²æ­¢å‡ ä¸ªçº¿ç¨‹åŒæ—¶è¿›å…¥äº†ä¸Šé¢é‚£ä¸ªifï¼Œç„¶åä¸€ä¸ªä¸ªéƒ½æ¥é‡å†™èµ‹å€¼ä¸€é
						System.out.println(Thread.currentThread().getName() + " write cache for " + key);
						value = "aaa" + System.currentTimeMillis(); // å®é™…ä¸­æ˜¯å»æ•°æ®åº“ä¸­å–ï¼Œè¿™é‡Œåªæ˜¯æ¨¡æ‹Ÿ
						cache.put(key, value); //æ”¾åˆ°ç¼“å­˜ä¸­
						System.out.println(Thread.currentThread().getName() + " has already written cache!");
					}
				} finally {
					rwl.writeLock().unlock(); //å†™å®Œäº†é‡Šæ”¾å†™é”
				}
				rwl.readLock().lock(); //æ¢è¯»é”
			}
		} finally {
			rwl.readLock().unlock(); //æœ€åå‘¢é‡Šæ”¾è¯»é”
		}
		return value; //è¿”å›è¦å–çš„æ•°æ®
	}
}
```
æ•´ä¸ªä»£ç çš„ç»“æ„å’Œä¸Šé¢çš„ä¸€æ ·ï¼Œç†è§£äº†ç¼“å­˜å•ä¸ªæ•°æ®åï¼Œè¿™ä¸ªä»£ç ä¹Ÿä¸éš¾ç†è§£ã€‚è¿™é‡Œåªæ˜¯ä¸ª demoï¼Œå®é™…ä¸­å¯ä»¥æ˜¯è·Ÿæ•°æ®åº“æ‰“äº¤é“ï¼Œç¬¬ä¸€æ¬¡ä»ç¼“å­˜ä¸­æ‹¿è‚¯å®šæ˜¯æ²¡æœ‰çš„ï¼Œé‚£ä¹ˆå°±è¦å»æ•°æ®åº“ä¸­æŸ¥ï¼Œç„¶åæŠŠå–åˆ°çš„æ•°æ®æ”¾åˆ°ç¼“å­˜ä¸­ï¼Œä¸‹æ¬¡åˆ«çš„çº¿ç¨‹æ¥å°±èƒ½ç›´æ¥ä»ç¼“å­˜ä¸­å–äº†ã€‚çœ‹ä¸€ä¸‹è¿è¡Œç»“æœï¼š

>Thread-0 write cache for cache1<br>
Thread-0 has already written cache!<br>
Thread-4 write cache for cache2<br>
Thread-0: aaa1464782404722<br>
Thread-4 has already written cache!<br>
Thread-4: aaa1464782404723<br>
Thread-3: aaa1464782404723<br>
Thread-2: aaa1464782404722<br>
Thread-1: aaa1464782404722<br>
Thread-5: aaa1464782404723<br>

ä»ç»“æœå¯ä»¥çœ‹å‡ºï¼Œçº¿ç¨‹0é¦–å…ˆå»ç¼“å­˜ä¸­æ‹¿ key ä¸º cache1 çš„å€¼ï¼Œæ²¡æ‹¿åˆ°ï¼Œå¾€é‡Œé¢å†™äº†ä¸€ä¸ªï¼Œç„¶åçº¿ç¨‹4å»ç¼“å­˜ä¸­æ‹¿ key ä¸º cache2 çš„å€¼ä¹Ÿæ²¡æ‹¿åˆ°ï¼Œäºæ˜¯ä¹Ÿå†™äº†ä¸€ä¸ªï¼Œåœ¨æ­¤æœŸé—´çº¿ç¨‹0æŠŠå€¼æ‹¿äº†å‡ºæ¥ï¼Œåé¢å‡ ä¸ªçº¿ç¨‹ä¹Ÿéšåé™†ç»­çš„æ‹¿å‡ºæ¥äº†ã€‚

è¯»å†™é”çš„åº”ç”¨è¿˜æ˜¯å¾ˆå¹¿æ³›çš„ï¼Œè€Œä¸”å¾ˆå¥½ç”¨ã€‚å…³äºçº¿ç¨‹é”çš„æŠ€æœ¯å°±æ€»ç»“è¿™ä¹ˆå¤šå§ã€‚å¦‚æœ‰ç–‘é—®æ¬¢è¿è®¨è®ºï¼Œæˆ‘ä»¬ä¸€èµ·è¿›æ­¥ï¼

----

> æ–‡ç« å¯ä»¥ç™½å«–ï¼Œè€é“ä»¬é¡ºä¾¿å…³æ³¨ä¸€ä¸‹æˆ‘çš„å…¬ä¼—å·ï¼Œæ‰‹åŠ¨æ»‘ç¨½ğŸ¤£ğŸ¤£ &nbsp;
>
> æ¬¢è¿å¤§å®¶å…³æ³¨ï¼š**æ­¦å“¥èŠç¼–ç¨‹**ã€**Javaå¼€å‘å®å…¸**ã€**Javaç§ƒå¤´å“¥**ï¼Œæ‚¨çš„æ”¯æŒï¼Œæ˜¯æˆ‘åˆ›ä½œçš„æŒç»­åŠ¨åŠ›ï¼&nbsp;&nbsp;

![æ­¦å“¥èŠç¼–ç¨‹](https://img-blog.csdnimg.cn/202002150421550.jpg)![Javaå¼€å‘å®å…¸](https://img-blog.csdnimg.cn/20200608005630228.png)![Javaç§ƒå¤´å“¥](https://img-blog.csdnimg.cn/20201025170941235.png)

----