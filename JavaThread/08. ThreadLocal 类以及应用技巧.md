> æ–‡ç« å¯ä»¥ç™½å«–ï¼Œè€é“ä»¬é¡ºä¾¿å…³æ³¨ä¸€ä¸‹æˆ‘çš„å…¬ä¼—å·ï¼Œæ‰‹åŠ¨æ»‘ç¨½ğŸ¤£ğŸ¤£ &nbsp;
>
> æ¬¢è¿å¤§å®¶å…³æ³¨ï¼š**æ­¦å“¥èŠç¼–ç¨‹**ã€**Javaå¼€å‘å®å…¸**ã€**Javaç§ƒå¤´å“¥**ï¼Œæ‚¨çš„æ”¯æŒï¼Œæ˜¯æˆ‘åˆ›ä½œçš„æŒç»­åŠ¨åŠ›ï¼&nbsp;&nbsp;

![æ­¦å“¥èŠç¼–ç¨‹](https://img-blog.csdnimg.cn/202002150421550.jpg)![Javaå¼€å‘å®å…¸](https://img-blog.csdnimg.cn/20200608005630228.png)![Javaç§ƒå¤´å“¥](https://img-blog.csdnimg.cn/20201025170941235.png)

----

åœ¨ä¸Šä¸€èŠ‚æˆ‘ä»¬æ€»ç»“äº†ä¸€ä¸‹ï¼Œçº¿ç¨‹èŒƒå›´å†…çš„æ•°æ®å…±äº«é—®é¢˜ï¼Œå³å®šä¹‰ä¸€ä¸ª Mapï¼Œå°†å½“å‰çº¿ç¨‹åç§°å’Œçº¿ç¨‹ä¸­çš„æ•°æ®ä»¥é”®å€¼å¯¹çš„å½¢å¼å­˜åˆ° Map ä¸­ï¼Œç„¶ååœ¨å½“å‰çº¿ç¨‹ä¸­ä½¿ç”¨æ•°æ®çš„æ—¶å€™å°±å¯ä»¥æ ¹æ®å½“å‰çº¿ç¨‹åç§°ä» Map ä¸­æ‹¿åˆ°å½“å‰çº¿ç¨‹ä¸­çš„æ•°æ®ï¼Œè¿™æ ·å°±å¯ä»¥åšåˆ°ä¸åŒçº¿ç¨‹ä¹‹é—´æ•°æ®äº’ä¸å¹²æ‰°ã€‚å…¶å® ThreadLocal ç±»å°±æ˜¯ç»™æˆ‘ä»¬æä¾›äº†è¿™ä¸ªè§£å†³æ–¹æ³•ï¼Œæ‰€ä»¥æˆ‘ä»¬å®Œå…¨å¯ä»¥ç”¨ ThreadLocal æ¥å®Œæˆçº¿ç¨‹èŒƒå›´å†…æ•°æ®çš„å…±äº«ã€‚

```java
public class ThreadScopeShareData {
	//å®šä¹‰ä¸€ä¸ªThreadLocal
	private static ThreadLocal<Integer> threadLocal = new ThreadLocal<Integer>();
	
	public static void main(String[] args) {
		for(int i = 0; i < 2; i ++) {
			new Thread(new Runnable() {
				
				@Override
				public void run() {
					int data = new Random().nextInt();
					System.out.println(Thread.currentThread().getName() + " has put a data: " + data);
					threadLocal.set(data);//ç›´æ¥å¾€threadLocalé‡Œé¢é‡Œé¢æ‰”æ•°æ®å³å¯
					new TestA().getData();
					new TestB().getData();
				}
			}).start();
		}
	}
	
	static class TestA {
		public void getData() {
			System.out.println("A get data from " + Thread.currentThread().getName() + ": " + threadLocal.get());//ç›´æ¥å–ï¼Œä¸ç”¨ä»€ä¹ˆå…³é”®å­—ï¼Œå®ƒç›´æ¥ä»å½“å‰çº¿ç¨‹ä¸­å–
		}
	}
	
	static class TestB {
		public void getData() {
			System.out.println("B get data from " + Thread.currentThread().getName() + ": " + threadLocal.get());//ç›´æ¥å–ï¼Œä¸ç”¨ä»€ä¹ˆå…³é”®å­—ï¼Œå®ƒç›´æ¥ä»å½“å‰çº¿ç¨‹ä¸­å–
		}
	}
}
```
ç»“åˆç¬¬ 6 èŠ‚çš„ä»£ç ï¼Œå¯ä»¥çœ‹å‡ºï¼Œå…¶å® ThreadLocal å°±ç›¸å½“äºä¸€ä¸ª Mapï¼Œåªä¸è¿‡æˆ‘ä»¬ä¸éœ€è¦è®¾å®š key äº†ï¼Œå®ƒé»˜è®¤å°±æ˜¯å½“å‰çš„ Threadï¼Œå¾€é‡Œé¢æ”¾æ•°æ®ï¼Œç›´æ¥ set å³å¯ï¼Œå–æ•°æ®ï¼Œç›´æ¥ get å³å¯ï¼Œå¾ˆæ–¹ä¾¿ï¼Œå°±ä¸ç”¨ Map ä¸€ä¸ªä¸ªå­˜äº†ï¼Œ

ä½†æ˜¯é—®é¢˜æ¥äº†ï¼ŒThreadLocal è™½ç„¶å­˜å–æ–¹ä¾¿ï¼Œä½†æ˜¯ `get()` æ–¹æ³•ä¸­æ ¹æœ¬æ²¡æœ‰å‚æ•°ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬åªèƒ½å¾€ ThreadLocal ä¸­æ”¾ä¸€ä¸ªæ•°æ®ï¼Œå¤šäº†å°±ä¸è¡Œäº†ï¼Œé‚£ä¹ˆè¯¥å¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿ

å¾ˆæ˜æ˜¾ï¼ŒThreadLocal æ˜¯ä¸ªå®¹å™¨ï¼Œä¸”åªèƒ½å­˜ä¸€ä¸‹ï¼Œé‚£ä¹ˆå¦‚æœæœ‰å¤šä¸ªæ•°æ®ï¼Œæˆ‘ä»¬å¯ä»¥å®šä¹‰ä¸€ä¸ªç±»ï¼ŒæŠŠæ•°æ®éƒ½å°è£…åˆ°è¿™ä¸ªç±»ä¸­ï¼Œç„¶åæ‰”åˆ° ThreadLocal ä¸­ï¼Œç”¨çš„æ—¶å€™å–è¿™ä¸ªç±»ï¼Œå†ä»ç±»ä¸­å»æˆ‘ä»¬æƒ³è¦çš„æ•°æ®å³å¯ã€‚

å¥½ï¼Œç°åœ¨æœ‰ä¸¤ä¸ªçº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½è¦æ“ä½œå„è‡ªçš„æ•°æ®ï¼Œè€Œä¸”æ•°æ®æœ‰ä¸¤ä¸ªï¼šåå­—å’Œå¹´é¾„ã€‚æ ¹æ®ä¸Šé¢çš„æ€è·¯ï¼Œå†™ä¸€ä¸ª demoï¼Œå¦‚ä¸‹ï¼š

```java
public class ThreadScopeShareData {

	private static ThreadLocal<User> threadLocal = new ThreadLocal<User>();
	
	public static void main(String[] args) {
		for(int i = 0; i < 2; i ++) {//å¼€å¯ä¸¤ä¸ªçº¿ç¨‹
			new Thread(new Runnable() {
				
				@Override
				public void run() {
					int data = new Random().nextInt();
					System.out.println(Thread.currentThread().getName() + " has put a data: " + data);

					//æ¯ä¸ªçº¿ç¨‹ä¸­ç»´æŠ¤ä¸€ä¸ªUserï¼ŒUserä¸­ä¿å­˜äº†nameå’Œage
					User user = new User();
					user.setName("name" + data);
					user.setAge(data);
					threadLocal.set(user); //å‘å½“å‰çº¿ç¨‹ä¸­å­˜å…¥userå¯¹è±¡
					
					new TestA().getData();
					new TestB().getData();
				}
			}).start();
		}
	}
	
	static class TestA {
		public void getData() {
			
			User user = threadLocal.get();//ä»å½“å‰çº¿ç¨‹ä¸­å–å‡ºuserå¯¹è±¡
			System.out.println("A get data from " + Thread.currentThread().getName() + ": " 
					+ user.getName() + "," + user.getAge());
		}
	}
	
	static class TestB {
		public void getData() {

			User user = threadLocal.get();//ä»å½“å‰çº¿ç¨‹ä¸­å–å‡ºuserå¯¹è±¡
			System.out.println("B get data from " + Thread.currentThread().getName() + ": " 
					+ user.getName() + "," + user.getAge());

		}
	}

}
//å®šä¹‰ä¸€ä¸ªUserç±»æ¥å­˜å‚¨å§“åå’Œå¹´é¾„
class User {
	
	private String name;
	private int age;
	public String getName() {
		return name;
	}
	public void setName(String name) {
		this.name = name;
	}
	public int getAge() {
		return age;
	}
	public void setAge(int age) {
		this.age = age;
	}	
}
```
è¿™æ ·è¿›è¡Œä¸€ä¸‹å°è£…å°±å¯ä»¥å®ç°å¤šä¸ªæ•°æ®çš„å­˜å‚¨äº†ï¼Œä½†æ˜¯ä¸Šé¢è¿™ä¸ªç¨‹åºæ˜¯ä¸å¤ªå¥½çš„ï¼ŒåŸå› å¾ˆæ˜æ˜¾ï¼Œåœ¨çº¿ç¨‹ä¸­ï¼Œæˆ‘è¦è‡ªå·± new ä¸€ä¸ªå¯¹è±¡ï¼Œç„¶åå¯¹å…¶è¿›è¡Œæ“ä½œï¼Œæœ€åè¿˜å¾—æŠŠè¿™ä¸ªå¯¹è±¡æ‰”åˆ°å½“å‰çº¿ç¨‹ä¸­ã€‚è¿™ä¸å¤ªç¬¦åˆè®¾è®¡çš„æ€è·¯ï¼Œè®¾è®¡çš„æ€è·¯åº”è¯¥æ˜¯è¿™æ ·çš„ï¼Œä¸èƒ½è®©ç”¨æˆ·è‡ªå·±å» new å•Šï¼Œå¦‚æœæœ‰ä¸ªç±»ä¼¼äº `getThreadInstance()` çš„æ–¹æ³•ï¼Œç”¨æˆ·æƒ³è¦ä» ThreadLocal ä¸­æ‹¿ä»€ä¹ˆå¯¹è±¡å°±ç”¨è¯¥å¯¹è±¡å»è°ƒç”¨è¿™ä¸ª `getThreadInstance()` æ–¹æ³•å¤šå¥½ï¼Œè¿™æ ·æ‹¿åˆ°çš„æ°¸è¿œéƒ½æ˜¯æœ¬çº¿ç¨‹èŒƒå›´å†…çš„å¯¹è±¡äº†ã€‚

è¿™è®©æˆ‘æƒ³åˆ°äº†å­¦ä¹  JDBC çš„æ—¶å€™ï¼Œä» ThreadLocal ä¸­æ‹¿ connection æ—¶çš„åšæ³•äº†ï¼Œå¦‚æœå½“å‰ThreadLocalä¸­æœ‰å°±æ‹¿å‡ºæ¥ï¼Œæ²¡æœ‰å°±äº§ç”Ÿä¸€ä¸ªï¼Œè¿™è·Ÿè¿™é‡Œçš„éœ€æ±‚æ˜¯ä¸€æ ·çš„ï¼Œæˆ‘æƒ³è¦ä¸€ä¸ªUserï¼Œé‚£æˆ‘åº”è¯¥ç”¨Userå»è°ƒç”¨`getThreadLInstance()`æ–¹æ³•è·å–æœ¬çº¿ç¨‹ä¸­çš„ä¸€ä¸ªUserå¯¹è±¡ï¼Œå¦‚æœæœ‰å°±æ‹¿ï¼Œå¦‚æœæ²¡æœ‰å°±äº§ç”Ÿä¸€ä¸ªã€‚å®Œå…¨ä¸€æ ·çš„æ€è·¯ã€‚è¿™ä¸ªè®¾è®¡è·Ÿå•ä¾‹çš„æ¨¡å¼æœ‰ç‚¹åƒï¼Œè¿™é‡Œè¯´æœ‰ç‚¹åƒä¸æ˜¯æœ¬è´¨ä¸Šåƒï¼Œæ˜¯ä»£ç ç»“æ„å¾ˆåƒã€‚å…ˆçœ‹ä¸€ä¸‹ç®€å•çš„å•ä¾‹æ¨¡å¼ä»£ç ç»“æ„ï¼š

```java
public class Singleton {
	private static Singleton instance = null;
	private Singleton() {//ç§æœ‰æ„é€ æ–¹æ³•é˜»æ­¢å¤–ç•Œnew		
	}
	public static synchronized Singleton getInstance() {  //æä¾›ä¸€ä¸ªå…¬å…±æ–¹æ³•è¿”å›ç»™å¤–ç•Œä¸€ä¸ªå•ä¾‹çš„å®ä¾‹
        if (instance == null) {  //å¦‚æœæ²¡æœ‰å®ä¾‹
            instance = new Singleton();  //å°±æ–°newä¸€ä¸ª
        }  
        return instance;  //è¿”å›è¯¥å®ä¾‹
	} 
}
```
è¿™æ˜¯æ‡’æ±‰å¼å•ä¾‹æ¨¡å¼çš„ä»£ç ç»“æ„ï¼Œæˆ‘é—¨å®Œå…¨å¯ä»¥æ•ˆä»¿è¯¥æ€è·¯å»è®¾è®¡ä¸€ä¸ªä»å½“å‰çº¿ç¨‹ä¸­æ‹¿ User çš„åŠæ³•ï¼Œæ‰€ä»¥å°†ç¨‹åºä¿®æ”¹å¦‚ä¸‹ï¼š

```java
public class ThreadScopeShareData {
//ä¸éœ€è¦åœ¨å¤–é¢å®šä¹‰threadLocaläº†ï¼Œæ”¾åˆ°Userç±»ä¸­äº†
//	private static ThreadLocal<User> threadLocal = new ThreadLocal<User>();
	
	public static void main(String[] args) {
		for(int i = 0; i < 2; i ++) {
			new Thread(new Runnable() {
				
				@Override
				public void run() {
					int data = new Random().nextInt();
					System.out.println(Thread.currentThread().getName() + " has put a data: " + data);

					//è¿™é‡Œç›´æ¥ç”¨Userå»è°ƒç”¨getThreadLocalè¿™ä¸ªé™æ€æ–¹æ³•è·å–æœ¬çº¿ç¨‹èŒƒå›´å†…çš„ä¸€ä¸ªUserå¯¹è±¡
					//è¿™é‡Œå°±ä¼˜é›…å¤šäº†ï¼Œæˆ‘å®Œå…¨ä¸ç”¨å…³å¿ƒå¦‚ä½•å»æ‹¿è¯¥çº¿ç¨‹ä¸­çš„å¯¹è±¡ï¼Œå¦‚ä½•æŠŠå¯¹è±¡æ”¾åˆ°threadLocalä¸­
					//æˆ‘åªè¦æ‹¿å°±è¡Œï¼Œè€Œä¸”æ‹¿å‡ºæ¥çš„è‚¯å®šå°±æ˜¯å½“å‰çº¿ç¨‹ä¸­çš„å¯¹è±¡ï¼ŒåŸå› çœ‹ä¸‹é¢Userç±»ä¸­çš„è®¾è®¡
					User.getThreadInstance().setName("name" + data);
					User.getThreadInstance().setAge(data);
					
					new TestA().getData();
					new TestB().getData();
				}
			}).start();
		}
	}
	
	static class TestA {
		public void getData() {
			//è¿˜æ˜¯è°ƒç”¨è¿™ä¸ªé™æ€æ–¹æ³•æ‹¿ï¼Œå› ä¸ºåˆšåˆšå·²ç»æ‹¿è¿‡ä¸€æ¬¡äº†ï¼ŒthreadLocalä¸­å·²ç»æœ‰äº†
			User user = User.getThreadInstance();
			System.out.println("A get data from " + Thread.currentThread().getName() + ": " 
					+ user.getName() + "," + user.getAge());
		}
	}
	
	static class TestB {
		public void getData() {
			
			User user = User.getThreadInstance();
			System.out.println("A get data from " + Thread.currentThread().getName() + ": " 
					+ user.getName() + "," + user.getAge());
		}
	}

}

class User {
	
	private User() {}

	private static ThreadLocal<User> threadLocal = new ThreadLocal<User>();
	
	//æ³¨æ„ï¼Œè¿™ä¸æ˜¯å•ä¾‹ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½å¯ä»¥newï¼Œæ‰€ä»¥ä¸ç”¨synchronizedï¼Œ
	//ä½†æ˜¯æ¯ä¸ªthreadLocalä¸­æ˜¯å•ä¾‹çš„ï¼Œå› ä¸ºæœ‰äº†çš„è¯å°±ä¸ä¼šå†newäº†
	public static /*synchronized*/ User getThreadInstance() {
		User instance = threadLocal.get(); //å…ˆä»å½“å‰threadLocalä¸­æ‹¿
		if(instance == null) {
			instance = new User();
			threadLocal.set(instance);//å¦‚æœæ²¡æœ‰å°±æ–°newä¸€ä¸ªæ”¾åˆ°threadLocalä¸­
		}
		return instance; //å‘å¤–è¿”å›è¯¥User
	}
	
	private String name;
	private int age;
	public String getName() {
		return name;
	}
	public void setName(String name) {
		this.name = name;
	}
	public int getAge() {
		return age;
	}
	public void setAge(int age) {
		this.age = age;
	}
}
```
ç»è¿‡è¿™æ ·çš„æ”¹é€ ï¼Œä»£ç å°±ä¼˜é›…å¤šäº†ï¼Œå¤–ç•Œä»æ¥ä¸è¦è€ƒè™‘å¦‚ä½•å»å½“å‰çº¿ç¨‹ä¸­æ‹¿æ•°æ®ï¼Œåªè¦æ‹¿å°±è¡Œï¼Œæ‹¿å‡ºæ¥çš„è‚¯å®šå°±æ˜¯å½“å‰çº¿ç¨‹ä¸­ä½ æƒ³è¦çš„å¯¹è±¡ï¼Œå› ä¸ºåœ¨å¯¹è±¡å†…éƒ¨å·²ç»å†™å¥½äº†è¿™ä¸ªé™æ€æ–¹æ³•äº†ï¼Œè€Œä¸”æ‹¿å‡ºæ¥æ“ä½œå®Œäº†åï¼Œä¹Ÿä¸éœ€è¦å†æ”¾åˆ° threadLocal ä¸­ï¼Œå› ä¸ºå®ƒæœ¬æ¥å°±åœ¨ threadLocal ä¸­ï¼Œè¿™å°±å°è£…çš„ç›¸å½“å¥½äº†ã€‚

ThreadLocalç±»çš„åº”ç”¨å’Œä½¿ç”¨æŠ€å·§å°±æ€»ç»“è¿™ä¹ˆå¤šå§~å¦‚æœ‰é—®é¢˜ï¼Œæ¬¢è¿äº¤æµï¼Œæˆ‘ä»¬ä¸€èµ·è¿›æ­¥ï¼

----

> æ–‡ç« å¯ä»¥ç™½å«–ï¼Œè€é“ä»¬é¡ºä¾¿å…³æ³¨ä¸€ä¸‹æˆ‘çš„å…¬ä¼—å·ï¼Œæ‰‹åŠ¨æ»‘ç¨½ğŸ¤£ğŸ¤£ &nbsp;
>
> æ¬¢è¿å¤§å®¶å…³æ³¨ï¼š**æ­¦å“¥èŠç¼–ç¨‹**ã€**Javaå¼€å‘å®å…¸**ã€**Javaç§ƒå¤´å“¥**ï¼Œæ‚¨çš„æ”¯æŒï¼Œæ˜¯æˆ‘åˆ›ä½œçš„æŒç»­åŠ¨åŠ›ï¼&nbsp;&nbsp;

![æ­¦å“¥èŠç¼–ç¨‹](https://img-blog.csdnimg.cn/202002150421550.jpg)![Javaå¼€å‘å®å…¸](https://img-blog.csdnimg.cn/20200608005630228.png)![Javaç§ƒå¤´å“¥](https://img-blog.csdnimg.cn/20201025170941235.png)

----